(function(){"use strict";function Fi(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var ai,Vi;function Cn(){if(Vi)return ai;Vi=1,ai=t;var o=0;function e(){}function t(i,n,s){typeof n=="function"&&(s=n,n={}),n||(n={});var r=n.prefix||"__jp",d=n.name||r+o++,c=n.param||"callback",l=n.timeout!=null?n.timeout:6e4,g=encodeURIComponent,b=document.getElementsByTagName("script")[0]||document.head,h,E;l&&(E=setTimeout(function(){w(),s&&s(new Error("Timeout"))},l));function w(){h.parentNode&&h.parentNode.removeChild(h),window[d]=e,E&&clearTimeout(E)}function U(){window[d]&&w()}return window[d]=function(ge){w(),s&&s(null,ge)},i+=(~i.indexOf("?")?"&":"?")+c+"="+g(d),i=i.replace("?&","?"),h=document.createElement("script"),h.src=i,b.parentNode.insertBefore(h,b),U}return ai}var Pn=Cn();const Nn=Fi(Pn),$e={Email:"Email",SMS:"SMS",Push:"Push"},ee={ChromePush:"ChromePush",Email:"Email",SMS:"SMS",SafariPush:"SafariPush",SafariLegacyPush:"SafariLegacyPush",FirefoxPush:"FirefoxPush"},J={NoNativePermission:0,Subscribed:1,UserOptedOut:-2,TemporaryWebRecord:-20,ServiceWorkerStatus403:-23,ServiceWorkerStatus404:-24};var Ut={exports:{}};/*!
 * Bowser - a browser detector
 * https://github.com/ded/bowser
 * MIT License | (c) Dustin Diaz 2015
 */var kn=Ut.exports,Wi;function An(){return Wi||(Wi=1,function(o){(function(e,t,i){o.exports?o.exports=i():e[t]=i()})(kn,"bowser",function(){var e=!0;function t(l){function g(Dt){var ot=l.match(Dt);return ot&&ot.length>1&&ot[1]||""}function b(Dt){var ot=l.match(Dt);return ot&&ot.length>1&&ot[2]||""}var h=g(/(ipod|iphone|ipad)/i).toLowerCase(),E=/like android/i.test(l),w=!E&&/android/i.test(l),U=/nexus\s*[0-6]\s*/i.test(l),ge=!U&&/nexus\s*[0-9]+/i.test(l),we=/CrOS/.test(l),We=/silk/i.test(l),Li=/sailfish/i.test(l),_t=/tizen/i.test(l),In=/(web|hpw)os/i.test(l),En=/windows phone/i.test(l),Uo=!En&&/windows/i.test(l),Lo=!h&&!We&&/macintosh/i.test(l),Bo=!w&&!Li&&!_t&&!In&&/linux/i.test(l),Bi=g(/edge\/(\d+(\.\d+)?)/i),K=g(/version\/(\d+(\.\d+)?)/i),vn=/tablet/i.test(l)&&!/tablet pc/i.test(l),On=!vn&&/[^-]mobi/i.test(l),Fo=/xbox/i.test(l),p;/opera/i.test(l)?p={name:"Opera",opera:e,version:K||g(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/opr\/|opios/i.test(l)?p={name:"Opera",opera:e,version:g(/(?:opr|opios)[\s\/](\d+(\.\d+)?)/i)||K}:/SamsungBrowser/i.test(l)?p={name:"Samsung Internet for Android",samsungBrowser:e,version:K||g(/(?:SamsungBrowser)[\s\/](\d+(\.\d+)?)/i)}:/coast/i.test(l)?p={name:"Opera Coast",coast:e,version:K||g(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:/yabrowser/i.test(l)?p={name:"Yandex Browser",yandexbrowser:e,version:K||g(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(l)?p={name:"UC Browser",ucbrowser:e,version:g(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(l)?p={name:"Maxthon",maxthon:e,version:g(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(l)?p={name:"Epiphany",epiphany:e,version:g(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(l)?p={name:"Puffin",puffin:e,version:g(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:/sleipnir/i.test(l)?p={name:"Sleipnir",sleipnir:e,version:g(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(l)?p={name:"K-Meleon",kMeleon:e,version:g(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:En?(p={name:"Windows Phone",windowsphone:e},Bi?(p.msedge=e,p.version=Bi):(p.msie=e,p.version=g(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(l)?p={name:"Internet Explorer",msie:e,version:g(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:we?p={name:"Chrome",chromeos:e,chromeBook:e,chrome:e,version:g(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:/chrome.+? edge/i.test(l)?p={name:"Microsoft Edge",msedge:e,version:Bi}:/vivaldi/i.test(l)?p={name:"Vivaldi",vivaldi:e,version:g(/vivaldi\/(\d+(\.\d+)?)/i)||K}:Li?p={name:"Sailfish",sailfish:e,version:g(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(l)?p={name:"SeaMonkey",seamonkey:e,version:g(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(l)?(p={name:"Firefox",firefox:e,version:g(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(l)&&(p.firefoxos=e)):We?p={name:"Amazon Silk",silk:e,version:g(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(l)?p={name:"PhantomJS",phantom:e,version:g(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(l)?p={name:"SlimerJS",slimer:e,version:g(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(l)||/rim\stablet/i.test(l)?p={name:"BlackBerry",blackberry:e,version:K||g(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:In?(p={name:"WebOS",webos:e,version:K||g(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(l)&&(p.touchpad=e)):/bada/i.test(l)?p={name:"Bada",bada:e,version:g(/dolfin\/(\d+(\.\d+)?)/i)}:_t?p={name:"Tizen",tizen:e,version:g(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||K}:/qupzilla/i.test(l)?p={name:"QupZilla",qupzilla:e,version:g(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||K}:/chromium/i.test(l)?p={name:"Chromium",chromium:e,version:g(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||K}:/chrome|crios|crmo/i.test(l)?p={name:"Chrome",chrome:e,version:g(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:w?p={name:"Android",version:K}:/safari|applewebkit/i.test(l)?(p={name:"Safari",safari:e},K&&(p.version=K)):h?(p={name:h=="iphone"?"iPhone":h=="ipad"?"iPad":"iPod"},K&&(p.version=K)):/googlebot/i.test(l)?p={name:"Googlebot",googlebot:e,version:g(/googlebot\/(\d+(\.\d+))/i)||K}:p={name:g(/^(.*)\/(.*) /),version:b(/^(.*)\/(.*) /)},!p.msedge&&/(apple)?webkit/i.test(l)?(/(apple)?webkit\/537\.36/i.test(l)?(p.name=p.name||"Blink",p.blink=e):(p.name=p.name||"Webkit",p.webkit=e),!p.version&&K&&(p.version=K)):!p.opera&&/gecko\//i.test(l)&&(p.name=p.name||"Gecko",p.gecko=e,p.version=p.version||g(/gecko\/(\d+(\.\d+)?)/i)),!p.windowsphone&&!p.msedge&&(w||p.silk)?p.android=e:!p.windowsphone&&!p.msedge&&h?(p[h]=e,p.ios=e):Lo?p.mac=e:Fo?p.xbox=e:Uo?p.windows=e:Bo&&(p.linux=e);function Vo(Dt){switch(Dt){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}var X="";p.windows?X=Vo(g(/Windows ((NT|XP)( \d\d?.\d)?)/i)):p.windowsphone?X=g(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):p.mac?(X=g(/Mac OS X (\d+([_\.\s]\d+)*)/i),X=X.replace(/[_\s]/g,".")):h?(X=g(/os (\d+([_\s]\d+)*) like mac os x/i),X=X.replace(/[_\s]/g,".")):w?X=g(/android[ \/-](\d+(\.\d+)*)/i):p.webos?X=g(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):p.blackberry?X=g(/rim\stablet\sos\s(\d+(\.\d+)*)/i):p.bada?X=g(/bada\/(\d+(\.\d+)*)/i):p.tizen&&(X=g(/tizen[\/\s](\d+(\.\d+)*)/i)),X&&(p.osversion=X);var Tn=!p.windows&&X.split(".")[0];return vn||ge||h=="ipad"||w&&(Tn==3||Tn>=4&&!On)||p.silk?p.tablet=e:(On||h=="iphone"||h=="ipod"||w||U||p.blackberry||p.webos||p.bada)&&(p.mobile=e),p.msedge||p.msie&&p.version>=10||p.yandexbrowser&&p.version>=15||p.vivaldi&&p.version>=1||p.chrome&&p.version>=20||p.samsungBrowser&&p.version>=4||p.firefox&&p.version>=20||p.safari&&p.version>=6||p.opera&&p.version>=10||p.ios&&p.osversion&&p.osversion.split(".")[0]>=6||p.blackberry&&p.version>=10.1||p.chromium&&p.version>=20?p.a=e:p.msie&&p.version<10||p.chrome&&p.version<20||p.firefox&&p.version<20||p.safari&&p.version<6||p.opera&&p.version<10||p.ios&&p.osversion&&p.osversion.split(".")[0]<6||p.chromium&&p.version<20?p.c=e:p.x=e,p}var i=t(typeof navigator<"u"&&navigator.userAgent||"");i.test=function(l){for(var g=0;g<l.length;++g){var b=l[g];if(typeof b=="string"&&b in i)return!0}return!1};function n(l){return l.split(".").length}function s(l,g){var b=[],h;if(Array.prototype.map)return Array.prototype.map.call(l,g);for(h=0;h<l.length;h++)b.push(g(l[h]));return b}function r(l){for(var g=Math.max(n(l[0]),n(l[1])),b=s(l,function(h){var E=g-n(h);return h=h+new Array(E+1).join(".0"),s(h.split("."),function(w){return new Array(20-w.length).join("0")+w}).reverse()});--g>=0;){if(b[0][g]>b[1][g])return 1;if(b[0][g]===b[1][g]){if(g===0)return 0}else return-1}}function d(l,g,b){var h=i;typeof g=="string"&&(b=g,g=void 0),g===void 0&&(g=!1),b&&(h=t(b));var E=""+h.version;for(var w in l)if(l.hasOwnProperty(w)&&h[w]){if(typeof l[w]!="string")throw new Error("Browser version in the minVersion map should be a string: "+w+": "+String(l));return r([E,l[w]])<0}return g}function c(l,g,b){return!d(l,g,b)}return i.isUnsupportedBrowser=d,i.compareVersions=r,i.check=c,i._detect=t,i})}(Ut)),Ut.exports}var yt=An();const ci=Fi(yt);class te{label;id;constructor(e,t){this.label=e,this.id=t}static ONESIGNAL_ID="onesignal_id";static EXTERNAL_ID="external_id"}class M extends Error{constructor(e=""){super(e),Object.defineProperty(this,"message",{configurable:!0,enumerable:!1,value:e,writable:!0}),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:this.constructor.name,writable:!0}),Object.defineProperty(this,"stack",{configurable:!0,enumerable:!1,value:new Error(e).stack,writable:!0}),Object.setPrototypeOf(this,M.prototype)}}class li extends M{constructor(e="The asynchronous operation has timed out."){super(e),Object.setPrototypeOf(this,li.prototype)}}class H{static contains(e,t){return e?e.indexOf(t)!==-1:!1}static trimUndefined(e){for(const t in e)e[t]===void 0&&delete e[t];return e}static capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}static isNullOrUndefined(e){return typeof e>"u"||e===null}static valueOrDefault(e,t){return typeof e>"u"||e===null?t:e}static stringify(e){return JSON.stringify(e,(t,i)=>typeof i=="function"?"[Function]":i,4)}static encodeHashAsUriComponent(e){let t="";const i=Object.keys(e);for(const n of i){const s=e[n];t+=`${encodeURIComponent(n)}=${encodeURIComponent(s)}`}return t}static timeoutPromise(e,t){const i=new Promise((n,s)=>{setTimeout(()=>{s(new li)},t)});return Promise.race([e,i])}static padStart(e,t,i){let n=e;for(;n.length<t;)n=i+n;return n}static parseVersionString(e){const t=e.toString().split("."),i=H.padStart(t[0],2,"0");let n;return t[1]?n=H.padStart(t[1],2,"0"):n="00",+`${i}.${n}`}static lastParts(e,t,i){const n=e.split(t),s=Math.max(n.length-i,0);return n.slice(s).join(t)}static enforceAppId(e){if(!e)throw new Error("App id cannot be empty")}static enforceAlias(e){if(!e.label)throw new Error("Alias label cannot be empty");if(!e.id)throw new Error("Alias id cannot be empty")}static sortArrayOfObjects(e,t,i=!1,n=!0){const s=n?e:e.slice();return s.sort((r,d)=>{const c=t(r),l=t(d);return c>l?i?-1:1:c<l?i?1:-1:0}),s}}const Qe={Safari:"safari",Firefox:"firefox",Chrome:"chrome",Opera:"opera",Edge:"edge",Other:"other"};function P(){return{mobile:yt.mobile,tablet:yt.tablet,name:yt.name.toLowerCase(),version:yt.version}}class di{static getEnvironmentInfo(){return{browserType:this.getBrowser(),browserVersion:this.getBrowserVersion(),isBrowserAndSupportsServiceWorkers:this.supportsServiceWorkers(),requiresUserInteraction:this.requiresUserInteraction(),osVersion:this.getOsVersion()}}static getBrowser(){return P().name==="chrome"?Qe.Chrome:P().name==="msedge"?Qe.Edge:P().name==="opera"?Qe.Opera:P().name==="firefox"?Qe.Firefox:this.isMacOSSafari()?Qe.Safari:Qe.Other}static isMacOSSafari(){return typeof window.safari<"u"}static getBrowserVersion(){return H.parseVersionString(P().version)}static supportsServiceWorkers(){return window.navigator&&"serviceWorker"in window.navigator}static requiresUserInteraction(){return this.getBrowser()==="firefox"&&this.getBrowserVersion()>=72||this.getBrowser()==="safari"&&this.getBrowserVersion()>=12.1}static getOsVersion(){return ci.osversion}}const re="160500";let a=class Ze{static debug;static trace;static info;static warn;static error;static proxyMethodsCreated;static shouldLog(){try{if(typeof window>"u"||typeof window.localStorage>"u")return!1;const e=window.localStorage.getItem("loglevel");return!!(e&&e.toLowerCase()==="trace")}catch{return!1}}static setLevel(e){if(!(typeof window>"u"||typeof window.localStorage>"u"))try{window.localStorage.setItem("loglevel",e),Ze.proxyMethodsCreated=void 0,Ze.createProxyMethods()}catch{return}}static createProxyMethods(){if(typeof Ze.proxyMethodsCreated<"u")return;Ze.proxyMethodsCreated=!0;const e={log:"debug",trace:"trace",info:"info",warn:"warn",error:"error"};for(const t of Object.keys(e)){const i=typeof console[t]<"u",n=e[t];i&&(Ze.shouldLog()||n==="error")?Ze[n]=console[t].bind(console):Ze[n]=function(){}}}};a.createProxyMethods();class V{static getBaseUrl(){return location.origin}static redetectBrowserUserAgent(){return P().name===""&&P().version===""?ci._detect(navigator.userAgent):ci}static isValidUuid(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/.test(e)}static logMethodCall(e,...t){return a.debug(`Called ${e}(${t.map(H.stringify).join(", ")})`)}static isSafari(){return $i&&typeof window.safari<"u"}}const $i=typeof window<"u",Hi=()=>typeof navigator<"u"&&"serviceWorker"in navigator,Lt="Browser",Xe=$i&&window.safari?.pushNotification!=null,xn=typeof PushSubscriptionOptions<"u"&&PushSubscriptionOptions.prototype.hasOwnProperty("applicationServerKey"),Mn=()=>P().name=="safari"&&xn&&!Xe,It=({action:o,legacy:e=!1}={})=>new URL(e?"https://onesignal.com/api/v1/":"https://api.onesignal.com/"),rt=()=>V.redetectBrowserUserAgent().firefox?ee.FirefoxPush:Mn()?ee.SafariPush:Xe?ee.SafariLegacyPush:ee.ChromePush;function Bt(){const o=di.getEnvironmentInfo();return String(isNaN(o.browserVersion)?-1:o.browserVersion)}function Ft(){return navigator.platform}const Vt={MissingAppId:0,RetryLimitReached:1};class Wt extends M{reason;constructor(e){let t;switch(e){case Vt.MissingAppId:t="The API call is missing an app ID.";break;case Vt.RetryLimitReached:t="The API call has reached the retry limit.";break}super(t),Object.setPrototypeOf(this,Wt.prototype)}}function $t(o){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/.test(o)}function z(o,e){return typeof o>"u"||o===null?e:o}function Z(o,e){return o??e}function Et(o){return new Promise(e=>setTimeout(e,o))}const Rn={5:1e4,4:2e4,3:3e4,2:3e4,1:3e4},_n=()=>window.location.origin;class B{static get(e,t,i){return B.call("GET",e,t,i)}static post(e,t,i){return B.call("POST",e,t,i)}static put(e,t,i){return B.call("PUT",e,t,i)}static delete(e,t,i){return B.call("DELETE",e,t,i)}static patch(e,t,i){return B.call("PATCH",e,t,i)}static call(e,t,i,n){if(!this.requestHasAppId(t,i))return Promise.reject(new Wt(Vt.MissingAppId));const s=new Headers;if(s.append("Origin",_n()),s.append("SDK-Version",`onesignal/web/${re}`),s.append("Content-Type","application/json;charset=UTF-8"),s.append("Accept","application/vnd.onesignal.v1+json"),n)for(const c of Object.keys(n))s.append(c,n[c]);const r={method:e||"NO_METHOD_SPECIFIED",headers:s,cache:"no-cache"};i&&(r.body=JSON.stringify(i));const d=`${It({action:t}).toString()}${t}`;return B.executeFetch(d,r)}static async executeFetch(e,t,i=5){if(i===0)return Promise.reject(new Wt(Vt.RetryLimitReached));try{const n=await fetch(e,t),{status:s,headers:r}=n,d=await n.json(),c=r?.get("Retry-After");return{ok:n.ok,result:d,status:s,retryAfterSeconds:c?parseInt(c):void 0}}catch(n){if(n instanceof Error&&n.name==="TypeError")return await Et(Rn[i]),a.error(`OneSignal: Network timed out while calling ${e}. Retrying...`),B.executeFetch(e,t,i-1);throw new M(`OneSignalApiBase: failed to execute HTTP call: ${n}`)}}static requestHasAppId(e,t){if(e.startsWith("apps/")){const i=e.split("/");return $t(i[1])}if(e.startsWith("sync/")){const i=e.split("/");return $t(i[1])}return t&&typeof t.app_id=="string"?$t(t.app_id):!1}}const Q={InvalidAppId:0,AppNotConfiguredForWebPush:1,WrongSiteUrl:2,MultipleInitialization:3,MissingSafariWebId:4,Unknown:5},Dn=Object.fromEntries(Object.entries(Q).map(([o,e])=>[e,o]));class he extends M{reason;constructor(e,t){let i;switch(e){case Q.InvalidAppId:i="OneSignal: This app ID does not match any existing app. Double check your app ID.";break;case Q.AppNotConfiguredForWebPush:i="OneSignal: This app ID does not have any web platforms enabled. Double check your app ID, or see step 1 on our setup guide (https://tinyurl.com/2x5jzk83).";break;case Q.WrongSiteUrl:t&&t.siteUrl?i=`OneSignal: This web push config can only be used on ${new URL(t.siteUrl).origin}. Your current origin is ${location.origin}.`:i="OneSignal: This web push config can not be used on the current site.";break;case Q.MultipleInitialization:i="OneSignal: The OneSignal web SDK can only be initialized once. Extra initializations are ignored. Please remove calls initializing the SDK more than once.";break;case Q.MissingSafariWebId:i="OneSignal: Safari browser support on Mac OS X requires the Safari web platform to be enabled. Please see the Safari Support steps in our web setup guide.";break;case Q.Unknown:i="OneSignal: An unknown initialization error occurred.";break}super(i),this.reason=Dn[e],Object.setPrototypeOf(this,he.prototype)}}function Un(o){const e="=".repeat((4-o.length%4)%4),t=(o+e).replace(/-/g,"+").replace(/_/g,"/"),i=atob(t),n=new Uint8Array(i.length);for(let s=0;s<i.length;++s)n[s]=i.charCodeAt(s);return n}function ji(o){return encodeURIComponent(o).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}class ae{static async createUser(e,t){const{appId:i,subscriptionId:n}=e,s=n?{"OneSignal-Subscription-Id":n}:void 0;let r={};return s&&(r={...r,...s}),e.jwtHeader&&(r={...r,...e.jwtHeader}),t.refresh_device_metadata=!0,B.post(`apps/${i}/users`,t,r)}static async getUser(e,t){const{appId:i}=e;return B.get(`apps/${i}/users/by/${t.label}/${t.id}`,e.jwtHeader)}static async updateUser(e,t,i){const{appId:n,subscriptionId:s}=e;if(!V.isValidUuid(n))throw new he(Q.InvalidAppId);const r=s?{"OneSignal-Subscription-Id":s}:void 0;let d={};r&&(d={...d,...r}),e.jwtHeader&&(d={...d,...e.jwtHeader});const c={label:ji(t.label),id:ji(t.id)};return B.patch(`apps/${n}/users/by/${c.label}/${c.id}`,i,d)}static async deleteUser(e,t){const{appId:i}=e;return B.delete(`apps/${i}/users/by/${t.label}/${t.id}`,e.jwtHeader)}static async addAlias(e,t,i){const{appId:n}=e;return B.patch(`apps/${n}/users/by/${t.label}/${t.id}/identity`,{identity:i},e.jwtHeader)}static async getUserIdentity(e,t){const{appId:i}=e;return B.get(`apps/${i}/users/by/${t.label}/${t.id}/identity`,e.jwtHeader)}static async deleteAlias(e,t,i){const{appId:n}=e;return B.delete(`apps/${n}/users/by/${t.label}/${t.id}/identity/${i}`,e.jwtHeader)}static async createSubscription(e,t,i){const{appId:n}=e;return B.post(`apps/${n}/users/by/${t.label}/${t.id}/subscriptions`,i,e.jwtHeader)}static async updateSubscription(e,t,i){const{appId:n}=e;return B.patch(`apps/${n}/subscriptions/${t}`,{subscription:i})}static async deleteSubscription(e,t){const{appId:i}=e;return B.delete(`apps/${i}/subscriptions/${t}`)}static async transferSubscription(e,t,i,n){const{appId:s}=e;return B.patch(`apps/${s}/subscriptions/${t}/owner`,{identity:{...i},retain_previous_owner:n},e.jwtHeader)}static async sendCustomEvent(e,t){const{appId:i}=e;return B.post(`apps/${i}/custom_events`,{events:[t]},e.jwtHeader)}}const Ce={Direct:1,Indirect:2,Unattributed:3,NotSupported:4};class Ht{static async sendOutcome(e){a.info("Outcome payload:",e);try{await B.post("outcomes/measure",e)}catch(t){a.error("sendOutcome",t)}}}class qi{static async downloadServerAppConfig(e){return H.enforceAppId(e),(await B.get(`sync/${e}/web`,null))?.result}static getUserIdFromSubscriptionIdentifier(e,t,i){return H.enforceAppId(e),B.post("players",{app_id:e,device_type:t,identifier:i,notification_types:J.TemporaryWebRecord}).then(n=>n?.result?.id?n.result.id:null).catch(n=>(a.debug("Error getting user ID from subscription identifier:",n),null))}static async updateUserSession(e,t,i){const n=new te(te.ONESIGNAL_ID,t),s={refresh_device_metadata:!0,deltas:{session_count:1}};H.enforceAppId(e),H.enforceAlias(n);try{await ae.updateUser({appId:e,subscriptionId:i},n,s)}catch(r){a.debug("Error updating user session:",r)}}static async sendSessionDuration(e,t,i,n,s){const r={refresh_device_metadata:!0,deltas:{session_time:n}},d=new te(te.ONESIGNAL_ID,t),c={id:"os__session_duration",app_id:e,session_time:n,notification_ids:s.notificationIds,subscription:{id:i,type:rt()},onesignal_id:t};c.direct=s.type===Ce.Direct;try{await ae.updateUser({appId:e,subscriptionId:i},d,r),c.notification_ids&&c.notification_ids.length>0&&await Ht.sendOutcome(c)}catch(l){a.debug("Error sending session duration:",l)}}}class ui{static jsonpLib(e,t){Nn(e,void 0,t)}static async downloadServerAppConfig(e){return await new Promise((t,i)=>{ui.jsonpLib(`${It().toString()}sync/${e}/web`,(n,s)=>{n?i(n):s.success?t(s):i(s)})})}}function Ln(o){const e=!self.isSecureContext;if(o.hasUnsupportedSubdomain||e)throw e?new Error("OneSignalSDK: HTTP sites are no longer supported starting with version 16 (User Model), your public site must start with https://."):new Error('OneSignalSDK: The "My site is not fully HTTPS" option is no longer supported starting with version 16 (User Model) of the OneSignal SDK.')}function Bn(o){if(o.restrictedOriginEnabled&&!Fn(o.origin))throw new he(Q.WrongSiteUrl,{siteUrl:o.origin})}function Fn(o){try{return location.origin===new URL(o).origin}catch{return!1}}const f={Native:"native",Push:"push",Category:"category",Sms:"sms",Email:"email",SmsAndEmail:"smsAndEmail"},ce={pageViews:1,timeDelay:0},ie={actionMessage:"We'd like to show you notifications for the latest news and updates.",acceptButton:"Allow",cancelButton:"Cancel",errorButton:"Try Again",categoryDefaults:{updateMessage:"Update your push notification subscription preferences.",positiveUpdateButton:"Save Preferences",negativeUpdateButton:"Cancel"},savingText:"Saving...",confirmMessage:"Thank You!"},pi={type:f.Push,text:{actionMessage:ie.actionMessage,acceptButton:ie.acceptButton,cancelButton:ie.cancelButton},autoPrompt:!1,delay:ce};function Vn(o){const e=o.config.staticPrompts,t=e.native?{enabled:e.native.enabled,autoPrompt:e.native.enabled&&e.native.autoPrompt!==!1,pageViews:Z(e.native.pageViews,ce.pageViews),timeDelay:Z(e.native.timeDelay,ce.timeDelay)}:{enabled:!1,autoPrompt:!1,pageViews:ce.pageViews,timeDelay:ce.timeDelay},{prompts:i}=e.slidedown;return{autoPrompt:t.autoPrompt||Ki(i),native:t,slidedown:{prompts:i},fullscreen:{enabled:e.fullscreen.enabled,actionMessage:e.fullscreen.actionMessage,acceptButton:e.fullscreen.acceptButton,cancelButton:e.fullscreen.cancelButton,title:e.fullscreen.title,message:e.fullscreen.message,caption:e.fullscreen.caption,autoAcceptTitle:e.fullscreen.autoAcceptTitle},customlink:Wn(o)}}function Ki(o){if(!o)return!1;for(let e=0;e<o.length;e++)if(o[e].autoPrompt)return!0;return!1}function Wn(o){const e={enabled:!1,style:"button",size:"medium",unsubscribeEnabled:!1,text:{explanation:"",subscribe:"",unsubscribe:""},color:{button:"",text:""}};if(!o||!o.config||!o.config.staticPrompts||!o.config.staticPrompts.customlink||!o.config.staticPrompts.customlink.enabled)return e;const t=o.config.staticPrompts.customlink;return{enabled:t.enabled,style:t.style,size:t.size,unsubscribeEnabled:t.unsubscribeEnabled,text:t.text?{subscribe:t.text.subscribe,unsubscribe:t.text.unsubscribe,explanation:t.text.explanation}:e.text,color:t.color?{button:t.color.button,text:t.color.text}:e.color}}const $n=10,at={Dashboard:0,JavaScript:1};function Hn(o){return o.config.integration?o.config.integration.kind:hi.Custom}function jn(o,e,t){switch(Gi(o).configuration){case at.Dashboard:return t.config.siteInfo.proxyOriginEnabled;case at.JavaScript:return!!e.subdomainName}}function Gi(o){switch(o){case hi.Custom:case hi.WordPress:return{configuration:at.JavaScript};default:return{configuration:at.Dashboard}}}function qn(o,e,t){switch(Gi(o).configuration){case at.Dashboard:{const{path:n,serviceWorkerPath:s,serviceWorkerParam:r}=Kn(e,t);return{appId:t.app_id,autoRegister:!1,autoResubscribe:t.config.autoResubscribe,path:n,serviceWorkerPath:s,serviceWorkerParam:r,subdomainName:t.config.siteInfo.proxyOrigin,promptOptions:Vn(t),welcomeNotification:{disable:!t.config.welcomeNotification.enable,title:t.config.welcomeNotification.title,message:t.config.welcomeNotification.message,url:t.config.welcomeNotification.url},notifyButton:{enable:t.config.staticPrompts.bell.enabled,displayPredicate:t.config.staticPrompts.bell.hideWhenSubscribed?()=>!OneSignal.User.PushSubscription.optedIn:null,size:t.config.staticPrompts.bell.size,position:t.config.staticPrompts.bell.location,showCredit:!1,offset:{bottom:`${t.config.staticPrompts.bell.offset.bottom}px`,left:`${t.config.staticPrompts.bell.offset.left}px`,right:`${t.config.staticPrompts.bell.offset.right}px`},colors:{"circle.background":t.config.staticPrompts.bell.color.main,"circle.foreground":t.config.staticPrompts.bell.color.accent,"badge.background":"black","badge.foreground":"white","badge.bordercolor":"black","pulse.color":t.config.staticPrompts.bell.color.accent,"dialog.button.background.hovering":t.config.staticPrompts.bell.color.main,"dialog.button.background.active":t.config.staticPrompts.bell.color.main,"dialog.button.background":t.config.staticPrompts.bell.color.main,"dialog.button.foreground":"white"},text:{"tip.state.unsubscribed":t.config.staticPrompts.bell.tooltip.unsubscribed,"tip.state.subscribed":t.config.staticPrompts.bell.tooltip.subscribed,"tip.state.blocked":t.config.staticPrompts.bell.tooltip.blocked,"message.prenotify":t.config.staticPrompts.bell.tooltip.unsubscribed,"message.action.subscribing":t.config.staticPrompts.bell.message.subscribing,"message.action.subscribed":t.config.staticPrompts.bell.message.subscribing,"message.action.resubscribed":t.config.staticPrompts.bell.message.subscribing,"message.action.unsubscribed":t.config.staticPrompts.bell.message.unsubscribing,"dialog.main.title":t.config.staticPrompts.bell.dialog.main.title,"dialog.main.button.subscribe":t.config.staticPrompts.bell.dialog.main.subscribeButton,"dialog.main.button.unsubscribe":t.config.staticPrompts.bell.dialog.main.unsubscribeButton,"dialog.blocked.title":t.config.staticPrompts.bell.dialog.blocked.title,"dialog.blocked.message":t.config.staticPrompts.bell.dialog.blocked.message}},persistNotification:t.config.notificationBehavior?t.config.notificationBehavior.display.persist:void 0,webhooks:{cors:t.config.webhooks.corsEnable,"notification.willDisplay":t.config.webhooks.notificationDisplayedHook,"notification.clicked":t.config.webhooks.notificationClickedHook,"notification.dismissed":t.config.webhooks.notificationDismissedHook},notificationClickHandlerMatch:t.config.notificationBehavior?t.config.notificationBehavior.click.match:void 0,notificationClickHandlerAction:t.config.notificationBehavior?t.config.notificationBehavior.click.action:void 0,outcomes:{direct:t.config.outcomes.direct,indirect:{enabled:t.config.outcomes.indirect.enabled,influencedTimePeriodMin:t.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:t.config.outcomes.indirect.notification_attribution.limit},unattributed:t.config.outcomes.unattributed}}}case at.JavaScript:{const n={scope:"/"},r={...e,promptOptions:Gn(e.promptOptions,t.config.staticPrompts,e),serviceWorkerParam:e.serviceWorkerParam?e.serviceWorkerParam:n,serviceWorkerPath:e.serviceWorkerPath?e.serviceWorkerPath:"OneSignalSDKWorker.js",path:e.path?e.path:"/",outcomes:{direct:t.config.outcomes.direct,indirect:{enabled:t.config.outcomes.indirect.enabled,influencedTimePeriodMin:t.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:t.config.outcomes.indirect.notification_attribution.limit},unattributed:t.config.outcomes.unattributed}};return e.hasOwnProperty("autoResubscribe")?r.autoResubscribe=!!e.autoResubscribe:e.hasOwnProperty("autoRegister")?r.autoResubscribe=!!e.autoRegister:r.autoResubscribe=!!t.config.autoResubscribe,r}}}function Kn(o,e){const t=o.serviceWorkerOverrideForTypical,i=t?z(o.path,e.config.serviceWorker.path):e.config.serviceWorker.path,n=t?z(o.serviceWorkerParam,{scope:e.config.serviceWorker.registrationScope}):{scope:e.config.serviceWorker.registrationScope},s=t?z(o.serviceWorkerPath,e.config.serviceWorker.workerName):e.config.serviceWorker.workerName;return{path:i,serviceWorkerParam:n,serviceWorkerPath:s}}function Gn(o,e,t){let i={enabled:!1};o&&o.customlink&&(i=o.customlink);const n=e.customlink,s={...o,customlink:{enabled:z(i.enabled,n.enabled),style:z(i.style,n.style),size:z(i.size,n.size),unsubscribeEnabled:z(i.unsubscribeEnabled,n.unsubscribeEnabled),text:{subscribe:z(i.text?i.text.subscribe:void 0,n.text.subscribe),unsubscribe:z(i.text?i.text.unsubscribe:void 0,n.text.unsubscribe),explanation:z(i.text?i.text.explanation:void 0,n.text.explanation)},color:{button:z(i.color?i.color.button:void 0,n.color.button),text:z(i.color?i.color.text:void 0,n.color.text)}}};return s.slidedown?s.slidedown.prompts=s.slidedown?.prompts?.map(r=>{if(r.type=z(r.type,f.Push),r.type===f.Category&&(r.text={...r.text,positiveUpdateButton:z(r.text?.positiveUpdateButton,ie.categoryDefaults.positiveUpdateButton),negativeUpdateButton:Z(r.text?.negativeUpdateButton,ie.categoryDefaults.negativeUpdateButton),updateMessage:Z(r.text?.updateMessage,ie.categoryDefaults.updateMessage)}),r.text={...r.text,actionMessage:Z(r.text?.actionMessage,ie.actionMessage),acceptButton:Z(r.text?.acceptButton,ie.acceptButton),cancelButton:Z(r.text?.cancelButton,ie.cancelButton),confirmMessage:Z(r.text?.confirmMessage,ie.confirmMessage)},r.autoPrompt=Z(r.autoPrompt,!0),r.delay={pageViews:Z(r.delay?.pageViews,ce.pageViews),timeDelay:Z(r.delay?.timeDelay,ce.timeDelay)},r.categories){const{categories:d}=r;r.categories=zn(d,$n)}return r}):(s.slidedown={prompts:[]},s.slidedown.prompts=[pi]),s.native?(s.native.enabled=!!s.native.enabled,s.native.autoPrompt=s.native.hasOwnProperty("autoPrompt")?!!s.native.enabled&&!!s.native.autoPrompt:!!s.native.enabled,s.native.pageViews=Z(s.native.pageViews,ce.pageViews),s.native.timeDelay=Z(s.native.timeDelay,ce.timeDelay)):s.native={enabled:!1,autoPrompt:!1,pageViews:ce.pageViews,timeDelay:ce.timeDelay},t.autoRegister===!0&&(s.native.enabled=!0,s.native.autoPrompt=!0),s.autoPrompt=s.native.autoPrompt||Ki(s.slidedown.prompts),s}function zn(o,e){return structuredClone(o).slice(0,e)}function Yn(o){Jn(o.promptOptions)&&(o.promptOptions=Zn(o.promptOptions)),Qn(o.promptOptions?.slidedown)&&o.promptOptions?.slidedown&&(o.promptOptions.slidedown=Xn(o.promptOptions?.slidedown))}function Jn(o){if(o){const e=["acceptButtonText","cancelButtonText","actionMessage"];for(let t=0;t<e.length;t++)if(o.hasOwnProperty(e[t]))return!0}return!1}function Zn(o){o.slidedown||(o.slidedown={});const{acceptButtonText:e,cancelButtonText:t,actionMessage:i}=o.slidedown,n=o.acceptButtonText||o.acceptButton,s=o.cancelButtonText||o.cancelButton;return o.slidedown.acceptButtonText=e||n,o.slidedown.cancelButtonText=t||s,o.slidedown.actionMessage=i||o.actionMessage,o}function Qn(o){if(o){const e=["enabled","autoPrompt","pageViews","timeDelay","acceptButton","acceptButtonText","cancelButton","cancelButtonText","actionMessage","customizeTextEnabled","categories"];for(let t=0;t<e.length;t++)if(o.hasOwnProperty(e[t]))return!0}return!1}function Xn(o){const e=es(o)?f.Category:f.Push;let t,i;return e===f.Category&&(t=o.categories?.positiveUpdateButton,i=o.categories?.negativeUpdateButton),{prompts:[...o.prompts||[],{type:e,autoPrompt:o.autoPrompt,text:{actionMessage:o.actionMessage,acceptButton:o.acceptButton||o.acceptButtonText,cancelButton:o.cancelButton||o.cancelButtonText,positiveUpdateButton:t,negativeUpdateButton:i,updateMessage:o?.categories?.updateMessage},delay:{pageViews:o.pageViews,timeDelay:o.timeDelay},categories:o?.categories?.tags}]}}function es(o){return(o?.categories?.tags?.length||0)>0}const gi={reportingThreshold:30,enableOnSessionForUnsubcribed:!1,enableOnFocus:!0};async function ts(o){return is(o,ui.downloadServerAppConfig)}async function is(o,e){try{if(!o||!o.appId||!$t(o.appId))throw new he(Q.InvalidAppId);const t=await e(o.appId);Yn(o);const i=ns(o,t);return Ln(i),Bn(i),i}catch(t){if(t instanceof Object&&"code"in t){if(t.code===1)throw new he(Q.InvalidAppId);if(t.code===2)throw new he(Q.AppNotConfiguredForWebPush)}throw t}}function ns(o,e){const t=Hn(e),i=jn(t,o,e),n=qn(t,o,e);return{appId:e.app_id,hasUnsupportedSubdomain:i,siteName:e.config.siteInfo.name,origin:e.config.origin,restrictedOriginEnabled:e.features.restrict_origin&&e.features.restrict_origin.enable,safariWebId:e.config.safari_web_id,vapidPublicKey:e.config.vapid_public_key,onesignalVapidPublicKey:e.config.onesignal_vapid_public_key,userConfig:n,enableOnSession:z(e.features.enable_on_session,gi.enableOnSessionForUnsubcribed),sessionThreshold:z(e.features.session_threshold,gi.reportingThreshold),enableSessionDuration:z(e.features.web_on_focus_enabled,gi.enableOnFocus)}}const hi={WordPress:"wordpress",Custom:"custom"};class jt{_events;constructor(){this._events={}}on(e,t){return this._events[e]=this._events[e]||[],this._events[e].push(t),this}once(e,t){const i=this;function n(){i.off(e,n),t.apply(this,arguments)}return n.listener=t,this.on(e,n),this}off(e,t){const i=this._events[e];if(i!==void 0){for(let n=0;n<i.length;n+=1)if(i[n]===t||i[n].listener===t){i.splice(n,1);break}i.length===0&&this.removeAllListeners(e)}return this}removeAllListeners(e){return e?delete this._events[e]:this._events={},this}listeners(e){try{return this._events[e]}catch{return}}numberOfListeners(e){const t=this.listeners(e);return t?t.length:0}async emit(...e){const t=e.shift();let i=this._events[t];if(i!==void 0){i=i.slice(0);const n=i.length;for(let s=0;s<n;s+=1)await i[s].apply(this,e)}return this}}const fe={Operations:"operations",Identity:"identity",Properties:"properties",Subscriptions:"subscriptions"},A={NORMAL:"NORMAL",HYDRATE:"HYDRATE"},ss=7,qt={PushSubscriptions:"pushSubscriptions",EmailSubscriptions:"emailSubscriptions",SmsSubscriptions:"smsSubscriptions"};class os{emitter;database;openLock;databaseName;dbVersion;constructor(e,t=ss){this.emitter=new jt,this.databaseName=e,this.dbVersion=t}open(e){return new Promise(t=>{let i;try{i=indexedDB.open(e,this.dbVersion)}catch{}if(!i)return null;i.onerror=this.onDatabaseOpenError.bind(this),i.onblocked=this.onDatabaseOpenBlocked.bind(this),i.onupgradeneeded=this.onDatabaseUpgradeNeeded.bind(this),i.onsuccess=()=>{this.database=i.result,this.database.onerror=this.onDatabaseError,this.database.onversionchange=this.onDatabaseVersionChange,t(this.database)}})}async close(){(await this.ensureDatabaseOpen()).close(),this.database?.close()}async ensureDatabaseOpen(){return this.openLock||(this.openLock=this.open(this.databaseName)),await this.openLock}onDatabaseOpenError(e){e.preventDefault();const t=e.target.error;H.contains(t.message,"The operation failed for reasons unrelated to the database itself and not covered by any other error code")||H.contains(t.message,"A mutation operation was attempted on a database that did not allow mutations")?a.warn("OneSignal: IndexedDb web storage is not available on this origin since this profile's IndexedDb schema has been upgraded in a newer version of Firefox. See: https://bugzilla.mozilla.org/show_bug.cgi?id=1236557#c6"):a.warn("OneSignal: Fatal error opening IndexedDb database:",t)}objectStoreNames(){return Array.from(this.database?.objectStoreNames||[])}onDatabaseError(e){a.debug("IndexedDb: Generic database error",e.target.errorCode)}onDatabaseOpenBlocked(){a.debug("IndexedDb: Blocked event")}onDatabaseVersionChange(){a.debug("IndexedDb: versionchange event")}onDatabaseUpgradeNeeded(e){a.debug("IndexedDb: Database is being rebuilt or upgraded (upgradeneeded event).");const t=e.target,i=t.transaction;if(!i)throw Error("Can't migrate DB without a transaction");const n=t.result,s=e.newVersion||Number.MAX_SAFE_INTEGER;s>=1&&e.oldVersion<1&&(n.createObjectStore("Ids",{keyPath:"type"}),n.createObjectStore("NotificationOpened",{keyPath:"url"}),n.createObjectStore("Options",{keyPath:"key"})),s>=2&&e.oldVersion<2&&(n.createObjectStore("Sessions",{keyPath:"sessionKey"}),n.createObjectStore("NotificationReceived",{keyPath:"notificationId"}),n.createObjectStore("NotificationClicked",{keyPath:"notificationId"})),s>=3&&e.oldVersion<3&&n.createObjectStore("SentUniqueOutcome",{keyPath:"outcomeName"}),s>=4&&e.oldVersion<4&&(n.createObjectStore(fe.Identity,{keyPath:"modelId"}),n.createObjectStore(fe.Properties,{keyPath:"modelId"}),n.createObjectStore(qt.PushSubscriptions,{keyPath:"modelId"}),n.createObjectStore(qt.SmsSubscriptions,{keyPath:"modelId"}),n.createObjectStore(qt.EmailSubscriptions,{keyPath:"modelId"})),s>=5&&e.oldVersion<5&&(this.migrateOutcomesNotificationClickedTableForV5(n,i),this.migrateOutcomesNotificationReceivedTableForV5(n,i)),s>=6&&e.oldVersion<6&&this.migrateModelNameSubscriptionsTableForV6(n,i),s>=7&&e.oldVersion<7&&n.createObjectStore(fe.Operations,{keyPath:"modelId"}),typeof OneSignal<"u"&&(OneSignal._isNewVisitor=!0)}migrateOutcomesNotificationClickedTableForV5(e,t){const i="Outcomes.NotificationClicked";e.createObjectStore(i,{keyPath:"notificationId"});const n="NotificationClicked",s=t.objectStore(n).openCursor();s.onsuccess=()=>{if(!s.result){e.deleteObjectStore(n);return}const r=s.result.value;t.objectStore(i).put({notificationId:r.notificationId||r.notification.id,appId:r.appId,timestamp:r.timestamp}),s.result.continue()},s.onerror=()=>{console.error("Could not migrate NotificationClicked records",s.error)}}migrateOutcomesNotificationReceivedTableForV5(e,t){const i="Outcomes.NotificationReceived";e.createObjectStore(i,{keyPath:"notificationId"});const n="NotificationReceived",s=t.objectStore(n).openCursor();s.onsuccess=()=>{if(!s.result){e.deleteObjectStore(n);return}t.objectStore(i).put(s.result.value),s.result.continue()},s.onerror=()=>{console.error("Could not migrate NotificationReceived records",s.error)}}migrateModelNameSubscriptionsTableForV6(e,t){const i=fe.Subscriptions;e.createObjectStore(i,{keyPath:"modelId"});let n;const s=t.objectStore(fe.Identity).openCursor();s.onsuccess=()=>{s.result&&(n=s.result.value.externalId)},s.onerror=()=>{console.error("Could not find "+fe.Identity+" records",s.error)},Object.values(qt).forEach(r=>{const d=t.objectStore(r).openCursor();d.onsuccess=()=>{if(!d.result){e.deleteObjectStore(r);return}const c=d.result.value;t.objectStore(i).put({...c,modelName:fe.Subscriptions,externalId:n}),d.result.continue()},d.onerror=()=>{console.error("Could not migrate "+r+" records",d.error)}})}async dbOperation(e,t,i){const n=await this.ensureDatabaseOpen();return await new Promise((s,r)=>{try{const d=n.transaction(e,t==="get"||t==="getAll"?"readonly":"readwrite").objectStore(e),c=t==="getAll"||t==="clear"?d[t]():d[t](i);c.onsuccess=()=>{s(c.result)},c.onerror=l=>{a.error("Database "+t.toUpperCase()+" Transaction Error:",l),r(l)}}catch(d){a.error("Database "+t.toUpperCase()+" Error:",d),r(d)}})}async get(e,t){return t?this.dbOperation(e,"get",t):this.dbOperation(e,"getAll")}async getAll(e){return this.dbOperation(e,"getAll")}async put(e,t){return this.dbOperation(e,"put",t)}async remove(e,t){return t?this.dbOperation(e,"delete",t):this.dbOperation(e,"clear")}}class zi{static toDatabase(e){const t=e.notification,i=e.result;return{action:i.actionId,badge:t.badgeIcon,buttons:this.toDatabaseButtons(t.actionButtons),content:t.body,data:t.additionalData,heading:t.title,icon:t.icon,id:t.notificationId,image:t.image,rr:t.confirmDelivery,tag:t.topic,timestamp:e.timestamp,url:i.url}}static toDatabaseButtons(e){return e?.map(t=>({action:t.actionId,title:t.text,icon:t.icon,url:t.launchURL}))}static fromDatabase(e){return{result:{actionId:e.action,url:e.url},notification:{notificationId:e.id,title:e.heading,body:e.content,additionalData:e.data,launchURL:e.url,confirmDelivery:e.rr,icon:e.icon,image:e.image,topic:e.tag,badgeIcon:e.badge,actionButtons:this.toOSNotificationButtons(e.buttons)},timestamp:e.timestamp}}static toOSNotificationButtons(e){return e?.map(t=>({actionId:t.action,text:t.title,icon:t.icon,launchURL:t.url}))}}class Yi{static toDatabase(e,t){return{appId:e,notificationId:t.notification.notificationId,timestamp:t.timestamp}}static fromDatabase(e){return{appId:e.appId,notificationId:e.notificationId,timestamp:e.timestamp}}}class Ji{static toDatabase(e,t,i){return{appId:e,notificationId:t.notificationId,timestamp:i}}static fromDatabase(e){return{appId:e.appId,notificationId:e.notificationId,timestamp:e.timestamp}}}class rs{defaultNotificationUrl;defaultNotificationTitle;lastKnownPushEnabled;lastKnownPushToken;lastKnownPushId;lastKnownOptedIn=!0;pendingNotificationClickEvents}const ct={Active:"active",Inactive:"inactive"},De={UserCreate:1,UserNewSession:2,VisibilityVisible:3,VisibilityHidden:4,BeforeUnload:5,Focus:7,Blur:8},fi="oneSignalSession";function Zi(o){const e=new Date().getTime(),t=o&&o.notificationId||null;return{accumulatedDuration:0,appId:o.appId,lastActivatedTimestamp:e,lastDeactivatedTimestamp:null,notificationId:t,sessionKey:fi,startTimestamp:e,status:ct.Active}}class mi{deviceId;subscriptionToken;optedOut;createdAt;expirationTime;serialize(){return{deviceId:this.deviceId,subscriptionToken:this.subscriptionToken,optedOut:this.optedOut,createdAt:this.createdAt,expirationTime:this.expirationTime}}static deserialize(e){const t=new mi;return t.deviceId=e.deviceId,t.subscriptionToken=e.subscriptionToken,t.optedOut=e.optedOut,t.createdAt=e.createdAt,t.expirationTime=e.expirationTime,t}}class as{previousOneSignalId;previousExternalId}const cs={SET:0},ls="ONE_SIGNAL_SDK_DB",Si="Outcomes.NotificationClicked",bi="Outcomes.NotificationReceived",Kt="NotificationOpened",wi="Sessions";class u{emitter;database;databaseName;static databaseInstanceName;static databaseInstance;static EVENTS=cs;constructor(e){this.databaseName=e,this.emitter=new jt,this.database=new os(this.databaseName)}static resetInstance(){u.databaseInstance=null}static get singletonInstance(){return u.databaseInstanceName||(u.databaseInstanceName=ls),u.databaseInstance||(u.databaseInstance=new u(u.databaseInstanceName)),u.databaseInstance}static applyDbResultFilter(e,t,i){switch(e){case"Options":return i&&t?i.value:i&&!t?i:null;case"Ids":return i&&t?i.id:i&&!t?i:null;default:return i||null}}async get(e,t){const i=await this.database.get(e,t);return u.applyDbResultFilter(e,t,i)}async getAll(e){return await this.database.getAll(e)}async put(e,t){await new Promise(i=>{this.database.put(e,t).then(()=>i())}),this.emitter.emit(u.EVENTS.SET,t)}remove(e,t){return this.database.remove(e,t)}async getAppConfig(){const e={},t=await this.get("Ids","appId");return e.appId=t,e.vapidPublicKey=await this.get("Options","vapidPublicKey"),e}async setAppConfig(e){e.appId&&await this.put("Ids",{type:"appId",id:e.appId}),e.vapidPublicKey&&await this.put("Options",{key:"vapidPublicKey",value:e.vapidPublicKey})}async getAppState(){const e=new rs;return e.defaultNotificationUrl=await this.get("Options","defaultUrl"),e.defaultNotificationTitle=await this.get("Options","defaultTitle"),e.lastKnownPushEnabled=await this.get("Options","isPushEnabled"),e.pendingNotificationClickEvents=await this.getAllPendingNotificationClickEvents(),e.lastKnownPushId=await this.get("Options","lastPushId"),e.lastKnownPushToken=await this.get("Options","lastPushToken"),e.lastKnownOptedIn=await this.get("Options","lastOptedIn"),e}async setIsPushEnabled(e){await this.put("Options",{key:"isPushEnabled",value:e})}async setAppState(e){if(e.defaultNotificationUrl&&await this.put("Options",{key:"defaultUrl",value:e.defaultNotificationUrl}),(e.defaultNotificationTitle||e.defaultNotificationTitle==="")&&await this.put("Options",{key:"defaultTitle",value:e.defaultNotificationTitle}),e.lastKnownPushEnabled!=null&&await this.setIsPushEnabled(e.lastKnownPushEnabled),e.lastKnownPushId!=null&&await this.put("Options",{key:"lastPushId",value:e.lastKnownPushId}),e.lastKnownPushToken!=null&&await this.put("Options",{key:"lastPushToken",value:e.lastKnownPushToken}),e.lastKnownOptedIn!=null&&await this.put("Options",{key:"lastOptedIn",value:e.lastKnownOptedIn}),e.pendingNotificationClickEvents){const t=Object.keys(e.pendingNotificationClickEvents);for(const i of t){const n=e.pendingNotificationClickEvents[i];n?await this.put(Kt,{url:i,data:n.data,timestamp:n.timestamp}):n===null&&await this.remove(Kt,i)}}}async getUserState(){const e=new as;return e.previousOneSignalId="",e.previousExternalId="",e.previousOneSignalId=await this.get("Options","previousOneSignalId"),e.previousExternalId=await this.get("Options","previousExternalId"),e}async setUserState(e){await this.put("Options",{key:"previousOneSignalId",value:e.previousOneSignalId}),await this.put("Options",{key:"previousExternalId",value:e.previousExternalId})}async getSubscription(){const e=new mi;e.deviceId=await this.get("Ids","userId"),e.subscriptionToken=await this.get("Ids","registrationId");const t=await this.get("Options","optedOut"),i=await this.get("Options","subscription"),n=await this.get("Options","subscriptionCreatedAt"),s=await this.get("Options","subscriptionExpirationTime");return t!=null?e.optedOut=t:i==null?e.optedOut=!1:e.optedOut=!i,e.createdAt=n,e.expirationTime=s,e}async setDeviceId(e){await this.put("Ids",{type:"userId",id:e})}async setSubscription(e){e.deviceId&&await this.setDeviceId(e.deviceId),typeof e.subscriptionToken<"u"&&await this.put("Ids",{type:"registrationId",id:e.subscriptionToken}),e.optedOut!=null&&await this.put("Options",{key:"optedOut",value:e.optedOut}),e.createdAt!=null&&await this.put("Options",{key:"subscriptionCreatedAt",value:e.createdAt}),e.expirationTime!=null?await this.put("Options",{key:"subscriptionExpirationTime",value:e.expirationTime}):await this.remove("Options","subscriptionExpirationTime")}async setJWTToken(e){await this.put("Ids",{type:"jwtToken",id:e})}async getJWTToken(){return await this.get("Ids","jwtToken")}async setProvideUserConsent(e){await this.put("Options",{key:"userConsent",value:e})}async getConsentGiven(){return await this.get("Options","userConsent")}async getSession(e){return await this.get(wi,e)}async setSession(e){await this.put(wi,e)}async removeSession(e){await this.remove(wi,e)}async getLastNotificationClickedForOutcomes(e){let t=[];try{t=await this.getAllNotificationClickedForOutcomes()}catch(n){a.error("Database.getLastNotificationClickedForOutcomes",n)}const i=n=>n.appId===e;return t.find(i)||null}async getAllNotificationClickedForOutcomes(){return(await this.getAll(Si)).map(t=>Yi.fromDatabase(t))}async putNotificationClickedForOutcomes(e,t){await this.put(Si,Yi.toDatabase(e,t))}async putNotificationClickedEventPendingUrlOpening(e){await this.put(Kt,zi.toDatabase(e))}async getAllPendingNotificationClickEvents(){const e={},t=await this.getAll(Kt);for(const i of t){const n=zi.fromDatabase(i),s=n.result.url;s&&(e[s]=n)}return e}async removeAllNotificationClickedForOutcomes(){await this.remove(Si)}async getAllNotificationReceivedForOutcomes(){return(await this.getAll(bi)).map(t=>Ji.fromDatabase(t))}async putNotificationReceivedForOutcomes(e,t){await this.put(bi,Ji.toDatabase(e,t,new Date().getTime()))}async resetSentUniqueOutcomes(){const t=(await this.getAll("SentUniqueOutcome")).map(i=>(i.sentDuringSession=null,u.put("SentUniqueOutcome",i)));await Promise.all(t)}static async clear(){const e=await u.singletonInstance.database.objectStoreNames();for(const t of e)await u.singletonInstance.database.remove(t)}static async getPushId(){return this.get("Options","lastPushId")}static async setPushId(e){await this.put("Options",{key:"lastPushId",value:e})}static async getPushToken(){return this.get("Options","lastPushToken")}static async setPushToken(e){await this.put("Options",{key:"lastPushToken",value:e})}static async setIsPushEnabled(e){return u.singletonInstance.setIsPushEnabled(e)}static async getCurrentSession(){return await u.singletonInstance.getSession(fi)}static async upsertSession(e){await u.singletonInstance.setSession(e)}static async cleanupCurrentSession(){await u.singletonInstance.removeSession(fi)}static async setSubscription(e){return await u.singletonInstance.setSubscription(e)}static async getSubscription(){return await u.singletonInstance.getSubscription()}static async setJWTToken(e){return await u.singletonInstance.setJWTToken(e)}static async getJWTToken(){return await u.singletonInstance.getJWTToken()}static async setConsentGiven(e){return await u.singletonInstance.setProvideUserConsent(e)}static async getConsentGiven(){return await u.singletonInstance.getConsentGiven()}static async setAppState(e){return await u.singletonInstance.setAppState(e)}static async getAppState(){return await u.singletonInstance.getAppState()}static async setUserState(e){return await u.singletonInstance.setUserState(e)}static async getUserState(){return await u.singletonInstance.getUserState()}static async setAppConfig(e){return await u.singletonInstance.setAppConfig(e)}static async getAppConfig(){return await u.singletonInstance.getAppConfig()}static async getLastNotificationClickedForOutcomes(e){return await u.singletonInstance.getLastNotificationClickedForOutcomes(e)}static async removeAllNotificationClickedForOutcomes(){return await u.singletonInstance.removeAllNotificationClickedForOutcomes()}static async getAllNotificationReceivedForOutcomes(){return await u.singletonInstance.getAllNotificationReceivedForOutcomes()}static async putNotificationReceivedForOutcomes(e,t){return await u.singletonInstance.putNotificationReceivedForOutcomes(e,t)}static async getAllNotificationClickedForOutcomes(){return await u.singletonInstance.getAllNotificationClickedForOutcomes()}static async putNotificationClickedForOutcomes(e,t){return await u.singletonInstance.putNotificationClickedForOutcomes(e,t)}static async putNotificationClickedEventPendingUrlOpening(e){return await u.singletonInstance.putNotificationClickedEventPendingUrlOpening(e)}static async resetSentUniqueOutcomes(){return await u.singletonInstance.resetSentUniqueOutcomes()}static async setDeviceId(e){await u.singletonInstance.setDeviceId(e)}static async remove(e,t){return await u.singletonInstance.remove(e,t)}static async put(e,t){return await u.singletonInstance.put(e,t)}static async get(e,t){return await u.singletonInstance.get(e,t)}static async getAll(e){return await u.singletonInstance.getAll(e)}}const ds=["notifyButtonHovering","notifyButtonHover","notifyButtonButtonClick","notifyButtonLauncherClick","animatedElementHiding","animatedElementHidden","animatedElementShowing","animatedElementShown","activeAnimatedElementActivating","activeAnimatedElementActive","activeAnimatedElementInactivating","activeAnimatedElementInactive"];class O{static async trigger(e,t,i){if(!H.contains(ds,e)){const n=t;n||n===!1?a.debug(`(${Lt}) » ${e}:`,n):a.debug(`(${Lt}) » ${e}`)}{if(e===OneSignal.EVENTS.SDK_INITIALIZED){if(OneSignal.initialized)return;OneSignal.initialized=!0}i?await i.emit(e,t):await OneSignal.emitter.emit(e,t)}}}class Pe{static executing=!1;static async triggerNotificationPermissionChanged(e=!1){if(!Pe.executing){Pe.executing=!0;try{await Pe.privateTriggerNotificationPermissionChanged(e)}finally{Pe.executing=!1}}}static async privateTriggerNotificationPermissionChanged(e){const t=await OneSignal.context.permissionManager.getPermissionStatus(),i=await u.get("Options","notificationPermission");(t!==i||e)&&(await u.put("Options",{key:"notificationPermission",value:t}),O.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,t),this.triggerBooleanPermissionChangeEvent(i,t,e))}static triggerBooleanPermissionChangeEvent(e,t,i){const n=t==="granted";(n!==(e==="granted")||i)&&O.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN,n)}}function He(o){const e=document.querySelectorAll(o);if(e.length>0)for(let t=0;t<e.length;t++){const i=e[t].parentNode;i&&i.removeChild(e[t])}}async function le(){return new Promise(o=>{OneSignal.initialized?o():OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,o)})}async function us(o=!1){return Pe.triggerNotificationPermissionChanged(o)}function ps(o,...e){if(o)return o.apply(null,e)}function I(o,...e){return V.logMethodCall(o,...e)}function gs(o){return!!o&&!!o.match(/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*$/)}function ne(o,e,t){let i;if(typeof o=="string"?i=document.querySelector(o):i=o,i){i.insertAdjacentHTML(e,t);return}throw new Error(`${o} must be a CSS selector string or DOM Element object.`)}function hs(o){if(typeof o=="string"){const e=document.querySelector(o);if(e===null)throw new Error(`Cannot find element with selector "${o}"`);for(;e.firstChild;)e.removeChild(e.firstChild)}else if(typeof o=="object")for(;o.firstChild;)o.removeChild(o.firstChild);else throw new Error(`${o} must be a CSS selector string or DOM Element object.`)}function m(o,e){if(typeof o=="string"){const t=document.querySelector(o);if(t===null)throw new Error(`Cannot find element with selector "${o}"`);t.classList.add(e)}else if(typeof o=="object")o.classList.add(e);else throw new Error(`${o} must be a CSS selector string or DOM Element object.`)}function de(o,e){if(typeof o=="string"){const t=document.querySelector(o);if(t===null)throw new Error(`Cannot find element with selector "${o}"`);t.classList.remove(e)}else if(typeof o=="object")o.classList.remove(e);else throw new Error(`${o} must be a CSS selector string or DOM Element object.`)}function yi(o,e){if(typeof o=="string"){const t=document.querySelector(o);if(t===null)throw new Error(`Cannot find element with selector "${o}"`);return t.classList.contains(e)}else{if(typeof o=="object")return o.classList.contains(e);throw new Error(`${o} must be a CSS selector string or DOM Element object.`)}}function lt(o){return new Promise(e=>{setTimeout(e,o)})}function dt(){return Promise.resolve()}function je(o,e){return H.contains(o,e)}function ye(o,e,t,i=!1){if(e||a.error("Cannot call on() with no event: ",e),t||a.error("Cannot call on() with no task: ",t),typeof o=="string"){const n=document.querySelectorAll(o);if(n.length>0)for(let s=0;s<n.length;s++)ye(n[s],e,t)}else if(Array.isArray(o))for(let n=0;n<o.length;n++)ye(o[n],e,t);else if(typeof o=="object"){const n=function(){return function(r){const d=function(){o.removeEventListener(r.type,n)};i||d(),t?.(r,d)}}();o.addEventListener(e,n)}else throw new Error(`${o} must be a CSS selector string or DOM Element object.`)}function Ii(){return window.__oneSignalSdkLoadCount||0}function fs(){window.__oneSignalSdkLoadCount=Ii()+1}function Ei(o){return o?P().name=="safari"&&o.safari?o.safari:P().name==="firefox"&&o.firefox?o.firefox:o.chrome||o.firefox||o.safari||"default-icon":"default-icon"}function L(o){const e=document.querySelector(o);return e||(a.debug(`No instance of ${o} found. Returning stub.`),document.createElement("div"))}function ms(){return Intl.DateTimeFormat().resolvedOptions().timeZone}function Qi(o){return typeof o=="object"&&o!==null&&!Array.isArray(o)}function Ss(o){if(!Qi(o))return!1;try{return JSON.stringify(o),!0}catch{return!1}}class Gt{static isValidUrl(e,t){if(t&&t.allowNull&&e===null)return!0;if(t&&t.allowEmpty&&e==null)return!0;try{const i=new URL(e);return t&&t.requireHttps?i.protocol==="https:":!0}catch{return!1}}static isValidBoolean(e,t){return t&&t.allowNull&&e===null?!0:e===!0||e===!1}static isValidArray(e,t){return t&&t.allowNull&&e===null||t&&t.allowEmpty&&e==null?!0:e instanceof Array}}const N={Empty:0,Malformed:1,EnumOutOfRange:2,WrongType:3,Reserved:4},bs=Object.fromEntries(Object.entries(N).map(([o,e])=>[e,o]));class _ extends M{argument;reason;constructor(e,t,i=""){let n;switch(t){case N.Empty:n=`Supply a non-empty value to '${e}'.`;break;case N.Malformed:n=`The value for '${e}' was malformed.`;break;case N.EnumOutOfRange:n=`The value for '${e}' was out of range of the expected input enum.`;break;case N.WrongType:n=`The value for '${e}' was of the wrong type.`;break;case N.Reserved:n=`The value for '${e}' is reserved.`;break}i&&(n+=` ${i}`),super(n),this.argument=e,this.reason=bs[t],Object.setPrototypeOf(this,_.prototype)}}const ws={HttpsPermissionRequest:"HTTPS permission request",SlidedownPermissionMessage:"slidedown permission message",SubscriptionBell:"subscription bell"},Ie={MissingAppId:0,RedundantPermissionMessage:1,PushPermissionAlreadyGranted:2,UnsupportedEnvironment:3,MissingDomElement:4,ServiceWorkerNotActivated:5},ys=Object.fromEntries(Object.entries(Ie).map(([o,e])=>[e,o]));class qe extends M{description;reason;constructor(e,t){let i;switch(e){case Ie.MissingAppId:i="Missing required app ID.";break;case Ie.RedundantPermissionMessage:{let n="";t&&t.permissionPromptType&&(n=`(${ws[t.permissionPromptType]})`),i=`Another permission message ${n} is being displayed.`;break}case Ie.PushPermissionAlreadyGranted:i="Push permission has already been granted.";break;case Ie.UnsupportedEnvironment:i="The current environment does not support this operation.";break;case Ie.ServiceWorkerNotActivated:i="The service worker must be activated first.";break}super(i),this.description=ys[e],this.reason=e,Object.setPrototypeOf(this,qe.prototype)}}const et={Unknown:0,NoDeviceId:1,NoEmailSet:2,NoSMSSet:3,OptedOut:4},Is=Object.fromEntries(Object.entries(et).map(([o,e])=>[e,o]));class zt extends M{reason;constructor(e){let t;switch(e){case et.NoDeviceId:t="This operation can only be performed after the user is subscribed.";break;case et.NoEmailSet:t="No email is currently set.";break;case et.NoSMSSet:t="No sms is currently set.";break;case et.OptedOut:t="The user has manually opted out of receiving of notifications. This operation can only be performed after the user is fully resubscribed.";break}super(t),this.reason=Is[e],Object.setPrototypeOf(this,zt.prototype)}}class F{static async showLocalNotification(e,t,i,n,s,r){if(I("MainHelper:showLocalNotification: ",e,t,i,n,s,r),!(await u.getAppConfig()).appId)throw new qe(Ie.MissingAppId);if(!OneSignal.Notifications.permission)throw new zt(et.NoDeviceId);if(!Gt.isValidUrl(i))throw new _("url",N.Malformed);if(!Gt.isValidUrl(n,{allowEmpty:!0,requireHttps:!0}))throw new _("icon",N.Malformed);if(!n){const g=await F.getNotificationIcons();n=Ei(g)}const c=g=>{const b=[];for(let h=0;h<g.length;h++){const E=g[h];b.push({action:E.id,title:E.text,icon:E.icon,url:E.url})}return b},l={data:s,launchURL:i,buttons:r?c(r):void 0};OneSignal.context.serviceWorkerManager.getRegistration().then(async g=>{if(!g){a.error("Service worker registration not available.");return}const b={body:t,data:l,icon:n,actions:r?c(r):[]};g.showNotification(e,b)})}static async checkAndTriggerNotificationPermissionChanged(){const e=await u.get("Options","notificationPermission"),t=await OneSignal.context.permissionManager.getPermissionStatus();e!==t&&(await Pe.triggerNotificationPermissionChanged(),await u.put("Options",{key:"notificationPermission",value:t}))}static async getNotificationIcons(){const e=F.getAppId();if(!e)throw new qe(Ie.MissingAppId);const t=`${It().toString()}apps/${e}/icon`,n=await(await fetch(t)).json();if(n.errors)throw a.error(`API call ${t}`,"failed with:",n.errors),new Error("Failed to get notification icons.");return n}static getSlidedownOptions(e){return Z(e.slidedown,{prompts:[]})}static getFullscreenPermissionMessageOptions(e){return e?e.fullscreen?{autoAcceptTitle:e.fullscreen.autoAcceptTitle,actionMessage:e.fullscreen.actionMessage,exampleNotificationTitleDesktop:e.fullscreen.title,exampleNotificationTitleMobile:e.fullscreen.title,exampleNotificationMessageDesktop:e.fullscreen.message,exampleNotificationMessageMobile:e.fullscreen.message,exampleNotificationCaption:e.fullscreen.caption,acceptButton:e.fullscreen.acceptButton,cancelButton:e.fullscreen.cancelButton}:e:null}static getPromptOptionsQueryString(){const e=F.getFullscreenPermissionMessageOptions(OneSignal.config?.userConfig.promptOptions);let t="";if(e){const i=F.getPromptOptionsPostHash();for(const n of Object.keys(i)){const s=i[n];t+="&"+n+"="+s}}return t}static getPromptOptionsPostHash(){const e=F.getFullscreenPermissionMessageOptions(OneSignal.config?.userConfig.promptOptions),t={};if(e){const i={exampleNotificationTitleDesktop:"exampleNotificationTitle",exampleNotificationMessageDesktop:"exampleNotificationMessage",exampleNotificationTitleMobile:"exampleNotificationTitle",exampleNotificationMessageMobile:"exampleNotificationMessage"};for(const s of Object.keys(i)){const r=i[s];e[s]&&(e[r]=e[s])}const n=["autoAcceptTitle","siteName","autoAcceptTitle","subscribeText","showGraphic","actionMessage","exampleNotificationTitle","exampleNotificationMessage","exampleNotificationCaption","acceptButton","cancelButton","timeout"];for(let s=0;s<n.length;s++){const r=n[s],d=e[r],c=encodeURIComponent(d);(d||d===!1||d==="")&&(t[r]=c)}}return t}static getAppId(){return OneSignal.config?.appId||""}static async getDeviceId(){return(await OneSignal.database.getSubscription()).deviceId||void 0}static async getCurrentPushToken(){if(Xe)return window.safari?.pushNotification?.permission(OneSignal.config?.safariWebId).deviceToken?.toLowerCase()||void 0;const e=await OneSignal.context.serviceWorkerManager.getRegistration();return e?(await e.pushManager.getSubscription())?.endpoint:void 0}}const k={SET_ALIAS:"set-alias",DELETE_ALIAS:"delete-alias",SET_PROPERTY:"set-property",REFRESH_USER:"refresh-user",LOGIN_USER:"login-user",CREATE_SUBSCRIPTION:"create-subscription",UPDATE_SUBSCRIPTION:"update-subscription",DELETE_SUBSCRIPTION:"delete-subscription",TRANSFER_SUBSCRIPTION:"transfer-subscription",CUSTOM_EVENT:"custom-event"},Ne={EXTERNAL_ID:"external_id",ONESIGNAL_ID:"onesignal_id"};class vi{subscribers=[];get hasSubscribers(){return this.subscribers.length>0}subscribe(e){this.subscribers.push(e)}unsubscribe(e){const t=this.subscribers.indexOf(e);t!==-1&&this.subscribers.splice(t,1)}subscribeAll(e){for(const t of e.subscribers)this.subscribe(t)}fire(e){for(const t of this.subscribers)e(t)}async suspendingFire(e){for(const t of this.subscribers)await e(t)}}class Yt{modelId;data=new Map;changeNotifier=new vi;constructor(){this.modelId=Math.random().toString(36).substring(2)}initializeFromJson(e){const{modelId:t,modelName:i,...n}=e;this.data.clear(),this.data=new Map(Object.entries(n)),t&&(this.modelId=t)}initializeFromModel(e,t){const i=new Map;t.data.forEach((n,s)=>{i.set(s,n)}),e!==null&&(this.modelId=e),this.data.clear(),this.data=i}setProperty(e,t,i=A.NORMAL,n=!1){const s=this.data.get(e);s===t&&!n||(t!==void 0?this.data.set(e,t):this.data.has(e)&&this.data.delete(e),this.notifyChanged(e,i,s,t))}hasProperty(e){return this.data.has(e)}getProperty(e,t){return this.data.get(e)??t}notifyChanged(e,t,i,n){const s={model:this,property:e,oldValue:i,newValue:n};this.changeNotifier.fire(r=>r.onChanged(s,t))}toJSON(){return Object.fromEntries(this.data.entries())}subscribe(e){return this.changeNotifier.subscribe(e)}unsubscribe(e){this.changeNotifier.unsubscribe(e)}get hasSubscribers(){return this.changeNotifier.hasSubscribers}mergeData(e){for(const[t,i]of Object.entries(e))this.data.set(t,i)}}class Jt extends Yt{get onesignalId(){return this.getProperty(Ne.ONESIGNAL_ID)}set onesignalId(e){this.setProperty(Ne.ONESIGNAL_ID,e)}get externalId(){return this.getProperty(Ne.EXTERNAL_ID)}set externalId(e){this.setProperty(Ne.EXTERNAL_ID,e)}}class Xi{modelName;changeSubscription=new vi;models=[];hasLoadedFromCache=!1;constructor(e){this.modelName=e}add(e,t=A.NORMAL){const i=this.models.find(n=>n.modelId===e.modelId);i&&this.removeItem(i,t),this.addItem(e,t)}addAt(e,t,i=A.NORMAL){const n=this.models.find(s=>s.modelId===t.modelId);n&&this.removeItem(n,i),this.addItem(t,i,e)}list(){return this.models}get(e){return this.models.find(t=>t.modelId===e)}remove(e,t=A.NORMAL){const i=this.models.find(n=>n.modelId===e);i&&this.removeItem(i,t)}onChanged(e,t){this.persist(),this.changeSubscription.fire(i=>i.onModelUpdated(e,t))}replaceAll(e,t=A.NORMAL){this.clear(t);for(const i of e)this.add(i,t)}clear(e=A.NORMAL){for(const t of this.models)t.unsubscribe(this),this.changeSubscription.fire(i=>i.onModelRemoved(t,e)),u.remove(this.modelName,t.modelId);this.models=[]}addItem(e,t,i){i!==void 0?this.models.splice(i,0,e):this.models.push(e),e.subscribe(this),this.persist(),this.changeSubscription.fire(n=>n.onModelAdded(e,t))}async removeItem(e,t){const i=this.models.findIndex(n=>n.modelId===e.modelId);i!==-1&&this.models.splice(i,1),e.unsubscribe(this),await u.remove(this.modelName,e.modelId),this.persist(),this.changeSubscription.fire(n=>n.onModelRemoved(e,t))}async load(){if(!this.modelName)return;const e=await u.getAll(this.modelName),t=this.models.length>0;for(let i=e.length-1;i>=0;i--){const n=this.create(e[i]);n&&(this.models.unshift(n),n.subscribe(this))}this.hasLoadedFromCache=!0,t&&this.persist()}async persist(){if(!(!this.modelName||!this.hasLoadedFromCache))for(const e of this.models)await u.put(this.modelName,{modelId:e.modelId,modelName:this.modelName,...e.toJSON()})}subscribe(e){this.changeSubscription.subscribe(e)}unsubscribe(e){this.changeSubscription.unsubscribe(e)}get hasSubscribers(){return this.changeSubscription.hasSubscribers}}class Oi extends Xi{_create;constructor(e,t){super(t),this._create=e,this.load()}create(e){const t=this._create();return e!=null&&t.initializeFromJson(e),t}}class en{store;changeSubscription=new vi;constructor(e){this.store=e,e.subscribe(this)}get model(){const e=this.store.list()[0];if(e)return e;const t=this.store.create();if(!t)throw new Error(`Unable to initialize model from store ${this.store}`);return this.store.add(t),t}replace(e,t){const i=this.model;i.initializeFromModel(i.modelId,e),this.store.persist(),this.changeSubscription.fire(n=>n.onModelReplaced(i,t))}subscribe(e){this.changeSubscription.subscribe(e)}unsubscribe(e){this.changeSubscription.unsubscribe(e)}get hasSubscribers(){return this.changeSubscription.hasSubscribers}onModelAdded(){}onModelUpdated(e,t){this.changeSubscription.fire(i=>i.onModelUpdated(e,t))}onModelRemoved(){}}class Es extends en{constructor(){super(new Oi(()=>new Jt,fe.Identity))}}const Ee={LOCAL_PREFIX:"local-",createLocalId(){return`${this.LOCAL_PREFIX}${crypto.randomUUID()}`},isLocalId(o){return o?.startsWith(this.LOCAL_PREFIX)??!1}},ke={CREATE:0,ALTER:1,NONE:2};class ut extends Yt{constructor(e,t,i){super(),this.name=e,t&&(this.appId=t),i&&(this.onesignalId=i)}get name(){return this.getProperty("name")}set name(e){this.setProperty("name",e)}get appId(){return this.getProperty("appId")}set appId(e){this.setProperty("appId",e)}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(e){this.setProperty("onesignalId",e)}get applyToRecordId(){return this.onesignalId}get createComparisonKey(){return""}get groupComparisonType(){return ke.ALTER}get canStartExecute(){return!Ee.isLocalId(this.onesignalId)}translateIds(e){e[this.onesignalId]&&(this.onesignalId=e[this.onesignalId])}toString(){return JSON.stringify(this.toJSON())}}class Ti extends ut{constructor(e){super(k.CUSTOM_EVENT,e?.appId,e?.onesignalId),e?.externalId&&(this.externalId=e.externalId),e?.timestamp&&(this.timestamp=e.timestamp),e?.event&&(this.event=e.event)}get externalId(){return this.getProperty("externalId")}set externalId(e){this.setProperty("externalId",e)}get timestamp(){return this.getProperty("timestamp")}set timestamp(e){this.setProperty("timestamp",e)}get event(){return this.getProperty("event")}set event(e){this.setProperty("event",e)}get key(){return`${this.appId}.User.${this.onesignalId}.CustomEvent.${this.event.name}`}get createComparisonKey(){return this.key}get modifyComparisonKey(){return this.key}get groupComparisonType(){return ke.NONE}get canStartExecute(){return!Ee.isLocalId(this.onesignalId)}get applyToRecordId(){return this.onesignalId}translateIds(e){e[this.onesignalId]&&(this.onesignalId=e[this.onesignalId])}}class vs{_identityModelStore;_opRepo;constructor(e,t){this._identityModelStore=e,this._opRepo=t}sendCustomEvent(e){const t=F.getAppId(),i=this._identityModelStore.model,n=new Ti({appId:t,onesignalId:i.onesignalId,externalId:i.externalId,timestamp:new Date().toISOString(),event:e});this._opRepo.enqueue(n)}}const x={INVALID:"INVALID",RETRYABLE:"RETRYABLE",UNAUTHORIZED:"UNAUTHORIZED",MISSING:"MISSING",CONFLICT:"CONFLICT"};function Ue(o){switch(o){case 400:case 402:return x.INVALID;case 401:case 403:return x.UNAUTHORIZED;case 404:case 410:return x.MISSING;case 409:return x.CONFLICT;case 429:default:return x.RETRYABLE}}class y{result;idTranslations;operations;retryAfterSeconds;constructor(e,t,i,n){this.result=e,this.retryAfterSeconds=t,this.operations=i,this.idTranslations=n}}const S={SUCCESS:0,SUCCESS_STARTING_ONLY:1,FAIL_RETRY:2,FAIL_NORETRY:3,FAIL_UNAUTHORIZED:4,FAIL_CONFLICT:5,FAIL_PAUSE_OPREPO:6};class Os{constructor(){}get operations(){return[k.CUSTOM_EVENT]}get eventMetadata(){return{sdk:re,device_model:Ft(),device_os:Bt(),type:rt()}}async execute(e){a.debug(`CustomEventsOperationExecutor(operations: ${JSON.stringify(e)})`);const t=e[0];if(!(t instanceof Ti))throw new Error(`Unrecognized operation! Expected TrackEventOperation, got: ${t.constructor.name}`);const i=await ae.sendCustomEvent({appId:t.appId},{name:t.event.name,onesignal_id:t.onesignalId,external_id:t.externalId,timestamp:t.timestamp,payload:{...t.event.properties??{},os_sdk:this.eventMetadata}}),{ok:n,status:s}=i,r=Ue(s);if(n)return new y(S.SUCCESS);switch(r){case x.RETRYABLE:return new y(S.FAIL_RETRY);default:return new y(S.FAIL_NORETRY)}}}const Ts=5e3,tn=3e3,Cs=3e3,Ps=3e4;class Ns{_records=new Map;get records(){return this._records}add(e){this._records.set(e,Date.now())}canAccess(e){if(!e)return!0;const t=this._records.get(e);return t?Date.now()-t>=tn:!0}isInMissingRetryWindow(e){const t=this._records.get(e);return t?Date.now()-t<=Ps:!1}}class nn extends ut{constructor(e,t,i,n){super(e,t,i),n&&(this.label=n)}get label(){return this.getProperty("label")}set label(e){this.setProperty("label",e)}}class Zt extends nn{constructor(e,t,i){super(k.DELETE_ALIAS,e,t,i)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Alias.${this.label}`}get groupComparisonType(){return ke.NONE}}class pt extends nn{constructor(e,t,i,n){super(k.SET_ALIAS,e,t,i),n&&(this.value=n)}get value(){return this.getProperty("value")}set value(e){this.setProperty("value",e)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Identity.${this.label}`}}class ks{_identityModelStore;_buildUserService;_newRecordState;constructor(e,t,i){this._identityModelStore=e,this._buildUserService=t,this._newRecordState=i}get operations(){return[k.SET_ALIAS,k.DELETE_ALIAS]}async execute(e){if(a.debug(`IdentityOperationExecutor(operations: ${JSON.stringify(e)})`),e.filter(h=>!(h instanceof pt||h instanceof Zt)).length>0)throw new Error(`Unrecognized operation(s)! Attempted operations:
${JSON.stringify(e)}`);const i=e.some(h=>h instanceof pt),n=e.some(h=>h instanceof Zt);if(i&&n)throw new Error("Can't process SetAliasOperation and DeleteAliasOperation at the same time.");const s=e[e.length-1],r=s instanceof pt,d=r?ae.addAlias({appId:s.appId},new te(te.ONESIGNAL_ID,s.onesignalId),{[s.label]:s.value}):ae.deleteAlias({appId:s.appId},new te(te.ONESIGNAL_ID,s.onesignalId),s.label),{ok:c,status:l,retryAfterSeconds:g}=await d;if(c)return this._identityModelStore.model.onesignalId===s.onesignalId&&this._identityModelStore.model.setProperty(s.label,r?s.value:void 0,A.HYDRATE),new y(S.SUCCESS);switch(Ue(l)){case x.RETRYABLE:return new y(S.FAIL_RETRY,g);case x.INVALID:return new y(S.FAIL_NORETRY);case x.CONFLICT:return r?new y(S.FAIL_CONFLICT,g):new y(S.SUCCESS);case x.UNAUTHORIZED:return new y(S.FAIL_UNAUTHORIZED,g);case x.MISSING:{if(l===404&&this._newRecordState.isInMissingRetryWindow(s.onesignalId))return new y(S.FAIL_RETRY,g);if(r){const h=await this._buildUserService.getRebuildOperationsIfCurrentUser(s.appId,s.onesignalId);return h==null?new y(S.FAIL_NORETRY):new y(S.FAIL_RETRY,g,h)}return new y(S.SUCCESS)}}}}class Qt{}function tt(o){return o?.type!==void 0&&o?.id!==void 0}class sn extends Qt{_id;_token;_optedIn;_permission;constructor(e,t,i){if(super(),!e||!t){a.warn(`PushSubscriptionNamespace: skipping initialization. One or more required params are falsy: initialize: ${e}, subscription: ${t}`);return}this._optedIn=!t.optedOut,this._permission=i,this._token=t.subscriptionToken,OneSignal.coreDirector.getPushSubscriptionModel().then(n=>{tt(n)&&(this._id=n.id)}).catch(n=>{a.error(n)}),OneSignal.emitter.on(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,async n=>{this._id=n?.current.id,this._token=n?.current.token}),OneSignal.emitter.on(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,async n=>{this._permission=n})}get id(){return this._id}get token(){return this._token}get optedIn(){return!!this._optedIn&&this._permission==="granted"}async optIn(){if(I("optIn"),await le(),this._optedIn=!0,await OneSignal.context.permissionManager.getPermissionStatus()!=="granted"){await OneSignal.Notifications.requestPermission();return}await this._enable(!0)}async optOut(){I("optOut"),await le(),this._optedIn=!1,await this._enable(!1)}addEventListener(e,t){OneSignal.emitter.on(e,t)}removeEventListener(e,t){OneSignal.emitter.off(e,t)}async _enable(e){await le();const t=await u.getAppConfig(),i=await u.getSubscription();if(!t.appId)throw new qe(Ie.MissingAppId);if(!Gt.isValidBoolean(e))throw new _("enabled",N.Malformed);i.optedOut=!e,await u.setSubscription(i),Y.onInternalSubscriptionSet(i.optedOut).catch(n=>{a.error(n)}),Y.checkAndTriggerSubscriptionChanged().catch(n=>{a.error(n)})}}class vt extends Yt{constructor(){super(),this.sdk=re,this.device_model=Ft(),this.device_os=Bt()}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(e){this.setProperty("onesignalId",e)}get id(){return this.getProperty("id")}set id(e){this.setProperty("id",e)}get enabled(){return this.getProperty("enabled")}set enabled(e){this.setProperty("enabled",e)}get type(){return this.getProperty("type")}set type(e){this.setProperty("type",e)}get token(){return this.getProperty("token")}set token(e){this.setProperty("token",e)}get notification_types(){return this.getProperty("notification_types")}set notification_types(e){this.setProperty("notification_types",e)}get sdk(){return this.getProperty("sdk")}set sdk(e){this.setProperty("sdk",e)}get device_model(){return this.getProperty("device_model")}set device_model(e){this.setProperty("device_model",e)}get device_os(){return this.getProperty("device_os")}set device_os(e){this.setProperty("device_os",e)}get web_auth(){return this.getProperty("web_auth")}set web_auth(e){this.setProperty("web_auth",e)}get web_p256(){return this.getProperty("web_p256")}set web_p256(e){this.setProperty("web_p256",e)}}class me{static singletonInstance=void 0;static createOrGetInstance(){return me.singletonInstance||(me.singletonInstance=new me),me.singletonInstance}get onesignalId(){const e=OneSignal.coreDirector.getIdentityModel().onesignalId;return Ee.isLocalId(e)?void 0:e}validateStringLabel(e,t){if(typeof e!="string")throw new _(t,N.WrongType);if(!e)throw new _(t,N.Empty)}validateArray(e,t){if(!Array.isArray(e))throw new _(t,N.WrongType);if(e.length===0)throw new _(t,N.Empty);for(const i of e)this.validateLabel(i,"label")}validateObject(e,t){if(!Qi(e))throw new _(t,N.WrongType);if(!e||Object.keys(e).length===0)throw new _(t,N.Empty)}validateLabel(e,t){if(this.validateStringLabel(e,t),e==="external_id"||e==="onesignal_id")throw new _(e,N.Reserved)}updateIdentityModel(e){const t=OneSignal.coreDirector.getIdentityModel();Object.keys(e).forEach(i=>{t.setProperty(i,e[i])})}addAlias(e,t){I("addAlias",{label:e,id:t}),this.validateStringLabel(e,"label"),this.validateStringLabel(t,"id"),this.addAliases({[e]:t})}addAliases(e){I("addAliases",{aliases:e}),this.validateObject(e,"aliases");for(const t of Object.keys(e))this.validateStringLabel(e[t],`key: ${t}`),this.validateLabel(t,`key: ${t}`);this.updateIdentityModel(e)}removeAlias(e){I("removeAlias",{label:e}),this.removeAliases([e])}removeAliases(e){I("removeAliases",{aliases:e}),this.validateArray(e,"aliases");const t=Object.fromEntries(e.map(i=>[i,void 0]));this.updateIdentityModel(t)}async addSubscriptionToModels({type:e,token:t}){if(OneSignal.coreDirector.subscriptionModelStore.list().find(r=>r.token===t&&r.type===e))return;const n={id:Ee.createLocalId(),enabled:!0,notification_types:J.Subscribed,onesignalId:OneSignal.coreDirector.getIdentityModel().onesignalId,token:t,type:e},s=new vt;s.mergeData(n),OneSignal.coreDirector.addSubscriptionModel(s)}validateUserExists(){const e=!!OneSignal.coreDirector.getIdentityModel().onesignalId;return e||a.error("User must be logged in first."),e}async addEmail(e){if(this.validateUserExists()){if(I("addEmail",{email:e}),this.validateStringLabel(e,"email"),!gs(e))throw new _("email",N.Malformed);this.addSubscriptionToModels({type:ee.Email,token:e})}}async addSms(e){this.validateUserExists()&&(I("addSms",{sms:e}),this.validateStringLabel(e,"sms"),this.addSubscriptionToModels({type:ee.SMS,token:e}))}removeEmail(e){I("removeEmail",{email:e}),this.validateStringLabel(e,"email"),OneSignal.coreDirector.getEmailSubscriptionModels().forEach(i=>{i.token===e&&OneSignal.coreDirector.removeSubscriptionModel(i.modelId)})}removeSms(e){I("removeSms",{smsNumber:e}),this.validateStringLabel(e,"smsNumber"),OneSignal.coreDirector.getSmsSubscriptionModels().forEach(i=>{i.token===e&&OneSignal.coreDirector.removeSubscriptionModel(i.modelId)})}addTag(e,t){I("addTag",{key:e,value:t}),this.validateStringLabel(e,"key"),this.validateStringLabel(t,"value"),this.addTags({[e]:t})}addTags(e){I("addTags",{tags:e}),this.validateObject(e,"tags");const t=OneSignal.coreDirector.getPropertiesModel(),i={...t.tags,...e};t.tags=i}removeTag(e){I("removeTag",{tagKey:e}),this.validateStringLabel(e,"tagKey"),this.removeTags([e])}removeTags(e){I("removeTags",{tagKeys:e}),this.validateArray(e,"tagKeys");const t=OneSignal.coreDirector.getPropertiesModel(),i={...t.tags};e.forEach(n=>{i[n]=""}),t.tags=i}getTags(){return I("getTags"),OneSignal.coreDirector.getPropertiesModel().tags}setLanguage(e){I("setLanguage",{language:e}),this.validateStringLabel(e,"language");const t=OneSignal.coreDirector.getPropertiesModel();t.language=e}getLanguage(){return I("getLanguage"),OneSignal.coreDirector.getPropertiesModel().language}trackEvent(e,t={}){if(this.validateUserExists()){if(!Ss(t))return a.error("Custom event properties must be a JSON-serializable object");I("trackEvent",{name:e,properties:t}),OneSignal.coreDirector.customEventController.sendCustomEvent({name:e,properties:t})}}}class gt extends Qt{_currentUser;PushSubscription=new sn(!1);static emitter=new jt;constructor(e,t,i){super(),e&&(this._currentUser=me.createOrGetInstance(),this.PushSubscription=new sn(!0,t,i))}get onesignalId(){return this._currentUser?.onesignalId}get externalId(){return OneSignal.coreDirector.getIdentityModel()?.externalId}addAlias(e,t){this._currentUser?.addAlias(e,t)}addAliases(e){this._currentUser?.addAliases(e)}removeAlias(e){this._currentUser?.removeAlias(e)}removeAliases(e){this._currentUser?.removeAliases(e)}addEmail(e){this._currentUser?.addEmail(e)}removeEmail(e){this._currentUser?.removeEmail(e)}addSms(e){this._currentUser?.addSms(e)}removeSms(e){this._currentUser?.removeSms(e)}addTag(e,t){this._currentUser?.addTag(e,t)}addTags(e){this._currentUser?.addTags(e)}removeTag(e){this._currentUser?.removeTag(e)}removeTags(e){this._currentUser?.removeTags(e)}getTags(){return this._currentUser?.getTags()||{}}setLanguage(e){this._currentUser?.setLanguage(e)}getLanguage(){return this._currentUser?.getLanguage()||""}trackEvent(e,t){return this._currentUser?.trackEvent(e,t)}addEventListener(e,t){gt.emitter.on(e,t)}removeEventListener(e,t){gt.emitter.off(e,t)}}const Ci={Stylesheet:0,Script:1},Ot={Loaded:0,Failed:1},As=()=>"OneSignalSDK.page.styles.css",xs=()=>{let o;return o="https://onesignal.com",new URL(`${o}/sdks/web/v16`)};class Pi{cache;constructor(){this.cache={}}getCache(){return{...this.cache}}async loadSdkStylesheet(){const e=xs(),t=As();return this.loadIfNew(Ci.Stylesheet,new URL(`${e}/${t}?v=${re}`))}async loadIfNew(e,t){return this.cache[t.toString()]||(this.cache[t.toString()]=Pi.load(e,t)),this.cache[t.toString()]}static async load(e,t){try{let i;return await new Promise((n,s)=>{switch(e){case Ci.Script:i=document.createElement("script"),i.setAttribute("type","text/javascript"),i.setAttribute("async","async"),i.setAttribute("src",t.toString());break;case Ci.Stylesheet:i=document.createElement("link"),i.setAttribute("rel","stylesheet"),i.setAttribute("href",t.toString());break}i.onerror=s,i.onload=n,document.querySelector("head")?.appendChild(i)}),Ot.Loaded}catch{return Ot.Failed}}}const D={body:"slidedown-body",buttonIndicatorHolder:"onesignal-button-indicator-holder",container:"onesignal-slidedown-container",dialog:"onesignal-slidedown-dialog",footer:"slidedown-footer",reset:"onesignal-reset",savingStateButton:"onesignal-saving-state-button",slideUp:"slide-up",slideDown:"slide-down",closeSlidedown:"close-slidedown",icon:"slidedown-body-icon",message:"slidedown-body-message",defaultIcon:"default-icon",loadingContainer:"onesignal-loading-container",clearfix:"clearfix"},Ms={toastText:"onesignal-toast-text"},Rs={toastText:"onesignal-toast-text"},C={allowButton:"onesignal-slidedown-allow-button",body:"slidedown-body",buttonIndicatorHolder:"onesignal-button-indicator-holder",cancelButton:"onesignal-slidedown-cancel-button",container:"onesignal-slidedown-container",dialog:"onesignal-slidedown-dialog",footer:"slidedown-footer",normalSlidedown:"normal-slidedown",loadingContainer:"onesignal-loading-container"},ht={alignRight:"align-right",primary:"primary",secondary:"secondary",slidedownButton:"slidedown-button"},Ae={categoryLabelInput:"onesignal-category-label-input",categoryLabelText:"onesignal-category-label-text",categoryLabel:"onesignal-category-label",checkmark:"onesignal-checkmark",taggingContainer:"tagging-container",taggingContainerCol:"tagging-container-col",loadingMessage:"onesignal-loading-message"},_s={taggingContainer:"tagging-container"},Ds="data:image/svg+xml,%3Csvg fill='none' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Cg clip-path='url(%23clip0)'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M33.232 28.434a2.5 2.5 0 001.768.733 1.667 1.667 0 010 3.333H5a1.667 1.667 0 110-3.333 2.5 2.5 0 002.5-2.5v-8.104A13.262 13.262 0 0118.333 5.122V1.667a1.666 1.666 0 113.334 0v3.455A13.262 13.262 0 0132.5 18.563v8.104a2.5 2.5 0 00.732 1.767zM16.273 35h7.454a.413.413 0 01.413.37 4.167 4.167 0 11-8.28 0 .417.417 0 01.413-.37z' fill='%23BDC4CB'/%3E%3C/g%3E%3Cdefs%3E%3CclipPath id='clip0'%3E%3Cpath fill='%23fff' d='M0 0h40v40H0z'/%3E%3C/clipPath%3E%3C/defs%3E%3C/svg%3E",Us="data:image/svg+xml;charset=UTF-8,%3csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M7.98775 -0.00114406C5.85015 0.0338508 3.81219 0.908665 2.31442 2.43419C1.565 3.18031 0.973715 4.06987 0.575897 5.04969C0.17808 6.02952 -0.0180997 7.07949 -0.000914196 8.13686C-0.00214385 9.17005 0.200528 10.1933 0.595487 11.148C0.990446 12.1028 1.56993 12.9702 2.30072 13.7005C3.03151 14.4309 3.89925 15.0098 4.85421 15.4042C5.80916 15.7986 6.83256 16.0007 7.86575 15.9989H8.00842C10.1467 15.9769 12.1889 15.1075 13.6869 13.5816C15.185 12.0557 16.0165 9.99781 15.9991 7.85952C16.0015 6.8138 15.7949 5.77814 15.3913 4.81345C14.9876 3.84876 14.3952 2.97451 13.6488 2.24213C12.9023 1.50974 12.017 0.933994 11.0448 0.548751C10.0726 0.163508 9.03324 -0.0234551 7.98775 -0.00114406ZM6.99909 11.0269C6.99428 10.8961 7.01558 10.7658 7.06175 10.6434C7.10792 10.521 7.17803 10.4091 7.26797 10.3141C7.35792 10.2191 7.4659 10.143 7.58559 10.0903C7.70529 10.0375 7.8343 10.0092 7.96509 10.0069H7.98309C8.24616 10.0074 8.49882 10.1097 8.6881 10.2924C8.87739 10.4751 8.9886 10.724 8.99842 10.9869C9.00331 11.1176 8.98207 11.248 8.93594 11.3704C8.8898 11.4928 8.8197 11.6048 8.72974 11.6998C8.63978 11.7948 8.53176 11.8709 8.41202 11.9236C8.29229 11.9763 8.16323 12.0046 8.03242 12.0069H8.01442C7.75145 12.006 7.49897 11.9036 7.30976 11.721C7.12054 11.5383 7.00923 11.2896 6.99909 11.0269ZM7.33242 8.33219V4.33219C7.33242 4.15538 7.40266 3.98581 7.52768 3.86079C7.65271 3.73576 7.82227 3.66552 7.99909 3.66552C8.1759 3.66552 8.34547 3.73576 8.47049 3.86079C8.59551 3.98581 8.66575 4.15538 8.66575 4.33219V8.33219C8.66575 8.509 8.59551 8.67857 8.47049 8.80359C8.34547 8.92862 8.1759 8.99886 7.99909 8.99886C7.82227 8.99886 7.65271 8.92862 7.52768 8.80359C7.40266 8.67857 7.33242 8.509 7.33242 8.33219Z' fill='%23E54B4D'/%3e%3c/svg%3e",on={greyLoadingIndicator:"#95A1AC",whiteLoadingIndicator:"#FFFFFF"},Ls={fetchingPreferences:"Fetching your preferences"},j={channelCaptureContainer:"channel-capture-container",inputWithValidationElement:"input-with-validation-element",onesignalErrorInput:"onesignal-error-input",onesignalSmsInput:"iti-onesignal-sms-input",onesignalEmailInput:"onesignal-email-input",onesignalValidationElementHidden:"onesignal-validation-element-hidden",onesignalValidationElement:"onesignal-validation-element"},G={smsInputWithValidationElement:"sms-input-with-validation-element",emailInputWithValidationElement:"email-input-with-validation-element",onesignalSmsInput:"iti-onesignal-sms-input",onesignalEmailInput:"onesignal-email-input",onesignalSmsValidationElement:"onesignal-sms-validation-element",onesignalEmailValidationElement:"onesignal-email-validation-element"},xe={containerClass:"onesignal-customlink-container",subscribeClass:"onesignal-customlink-subscribe",explanationClass:"onesignal-customlink-explanation",resetClass:"onesignal-reset",hide:"hide",state:{subscribed:"state-subscribed",unsubscribed:"state-unsubscribed"}},Bs={containerSelector:`.${xe.containerClass}`};class rn{config;constructor(e){this.config=e}async initialize(){if(!this.config?.enabled||!await this.loadSdkStyles())return;a.info("OneSignal: initializing customlink");const e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();if(!this.config?.unsubscribeEnabled&&e){this.hideCustomLinkContainers();return}for(let t=0;t<this.customlinkContainerElements.length;t++)await this.injectMarkup(this.customlinkContainerElements[t])}async injectMarkup(e){e.innerHTML="",await this.mountExplanationNode(e),await this.mountSubscriptionNode(e)}async mountExplanationNode(e){if(!this.config?.text){a.error("CustomLink: required property 'text' is missing in the config");return}if(this.config.text.explanation){const t=document.createElement("p");t.textContent=this.config.text.explanation,m(t,xe.resetClass),m(t,xe.explanationClass),this.config.size&&m(t,this.config.size),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?m(t,xe.state.subscribed):m(t,xe.state.unsubscribed),e.appendChild(t)}}async mountSubscriptionNode(e){if(!this.config?.text){a.error("CustomLink: required property 'text' is missing in the config");return}if(this.config.text.subscribe){const t=document.createElement("button");m(t,xe.resetClass),m(t,xe.subscribeClass),this.config.size&&m(t,this.config.size),this.config.style&&m(t,this.config.style),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?m(t,xe.state.subscribed):m(t,xe.state.unsubscribed),this.setCustomColors(t),await this.setTextFromPushStatus(t),t.addEventListener("click",async()=>{a.info("CustomLink: subscribe clicked"),await this.handleClick(t)}),t.setAttribute("type","button"),e.appendChild(t)}}async loadSdkStyles(){return await OneSignal.context.dynamicResourceLoader.loadSdkStylesheet()!==Ot.Loaded?(a.debug("Not initializing custom link button because styles failed to load."),!1):!0}hideElement(e){m(e,xe.hide)}hideCustomLinkContainers(){this.customlinkContainerElements.forEach(e=>{this.hideElement(e)})}async handleClick(e){if(OneSignal.User.PushSubscription.optedIn)await OneSignal.User.PushSubscription.optOut(),await this.setTextFromPushStatus(e);else{await OneSignal.User.PushSubscription.optIn(),this.config?.unsubscribeEnabled||this.hideCustomLinkContainers();return}}async setTextFromPushStatus(e){this.config?.text?.subscribe&&(await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()||(e.textContent=this.config.text.subscribe)),this.config?.text?.unsubscribe&&await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()&&(e.textContent=this.config.text.unsubscribe)}setCustomColors(e){!this.config?.color||!this.config.color.text||(this.config?.style==="button"&&this.config?.color.button?(e.style.backgroundColor=this.config?.color.button,e.style.color=this.config?.color.text):this.config?.style==="link"&&(e.style.color=this.config?.color.text))}get customlinkContainerElements(){const e=document.querySelectorAll(Bs.containerSelector);return Array.prototype.slice.call(e)}}class W{static store={};static LIMIT=2;static put(e,t){return W.store[e]===void 0&&(W.store[e]=[null,null]),W.store[e].push(t),W.store[e].length==W.LIMIT+1&&W.store[e].shift(),W.store[e]}static get(e){return W.store[e]===void 0&&(W.store[e]=[null,null]),W.store[e]}static getFirst(e){return W.get(e)[0]}static getLast(e){return W.get(e)[1]}static remove(e){delete W.store[e]}static isEmpty(e){const t=W.get(e);return t[0]===null&&t[1]===null}}class Tt{static decodeHtmlEntities(e){return typeof DOMParser>"u"?e:new DOMParser().parseFromString(e,"text/html").documentElement.textContent||""}}class Le{static isCategorySlidedownConfigured(e){if(!e)return!1;const t=Le.getFirstSlidedownPromptOptionsWithType(e,f.Category);return t?!!t.categories&&t.categories.length>0:!1}static getFirstSlidedownPromptOptionsWithType(e,t){return e?e.filter(i=>i.type===t)[0]:void 0}static isSlidedownPushDependent(e){return e===f.Push||e===f.Category}}class Y{static onNotificationPermissionChange(){Y.checkAndTriggerSubscriptionChanged()}static async onInternalSubscriptionSet(e){W.put("subscription.optedOut",e)}static async checkAndTriggerSubscriptionChanged(){V.logMethodCall("checkAndTriggerSubscriptionChanged");const e=OneSignal.context,t=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),i=await OneSignal.context.subscriptionManager.isOptedIn(),n=await u.getAppState(),{lastKnownPushEnabled:s,lastKnownPushId:r,lastKnownPushToken:d,lastKnownOptedIn:c}=n,l=await F.getCurrentPushToken(),b=(await OneSignal.coreDirector.getPushSubscriptionModel())?.id;if(!(s===null||t!==s||l!==d||b!==r))return;await e.subscriptionManager.updateNotificationTypes(),n.lastKnownPushEnabled=t,n.lastKnownPushToken=l,n.lastKnownPushId=b,n.lastKnownOptedIn=i,await u.setAppState(n);const E={previous:{id:r,token:d,optedIn:c??!0},current:{id:b,token:l,optedIn:i}};a.info("Push Subscription state changed: ",E),Y.triggerSubscriptionChanged(E)}static async _onSubscriptionChanged(e){Y.onSubscriptionChanged_showWelcomeNotification(e?.current?.optedIn,e?.current?.id),Y.onSubscriptionChanged_sendCategorySlidedownTags(e?.current?.optedIn),Y.onSubscriptionChanged_evaluateNotifyButtonDisplayPredicate(),Y.onSubscriptionChanged_updateCustomLink()}static async onSubscriptionChanged_sendCategorySlidedownTags(e){if(e!==!0)return;const t=OneSignal.context.appConfig.userConfig.promptOptions?.slidedown?.prompts;Le.isCategorySlidedownConfigured(t)&&await OneSignal.context.tagManager.sendTags()}static async onSubscriptionChanged_showWelcomeNotification(e,t){if(OneSignal.__doNotShowWelcomeNotification){a.debug("Not showing welcome notification because user has previously subscribed.");return}const i=OneSignal.config?.userConfig.welcomeNotification;if(i!==void 0&&i.disable===!0||e!==!0||!t)return;let s=i!==void 0&&i.title!==void 0&&i.title!==null?i.title:"",r=i!==void 0&&i.message!==void 0&&i.message!==null&&i.message.length>0?i.message:"Thanks for subscribing!";const d=new URL(location.href).origin+"?_osp=do_not_open",c=i&&i.url&&i.url.length>0?i.url:d;s=Tt.decodeHtmlEntities(s),r=Tt.decodeHtmlEntities(r),a.debug("Sending welcome notification."),F.showLocalNotification(s,r,c,void 0,{__isOneSignalWelcomeNotification:!0},void 0),O.trigger(OneSignal.EVENTS.WELCOME_NOTIFICATION_SENT,{title:s,message:r,url:c})}static async onSubscriptionChanged_evaluateNotifyButtonDisplayPredicate(){if(!OneSignal.config?.userConfig.notifyButton)return;const e=OneSignal.config.userConfig.notifyButton.displayPredicate;e&&typeof e=="function"&&OneSignal.notifyButton&&(await e()!==!1?(a.debug("Showing notify button because display predicate returned true."),OneSignal.notifyButton.launcher.show()):(a.debug("Hiding notify button because display predicate returned false."),OneSignal.notifyButton.launcher.hide()))}static async onSubscriptionChanged_updateCustomLink(){OneSignal.config?.userConfig.promptOptions&&new rn(OneSignal.config?.userConfig.promptOptions.customlink).initialize()}static triggerSubscriptionChanged(e){O.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,e)}static triggerUserChanged(e){O.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,e,gt.emitter)}static triggerNotificationClick(e){const t={notification:e.notification,result:e.result};return O.trigger(OneSignal.EVENTS.NOTIFICATION_CLICKED,t)}static async fireStoredNotificationClicks(){await le();const e=OneSignal.config?.pageUrl||OneSignal.config?.userConfig.pageUrl||document.URL;async function t(s){const r=await u.getAppState();r.pendingNotificationClickEvents[s.result.url]=null,await u.setAppState(r);const d=s.timestamp;d&&(Date.now()-d)/1e3/60>5||Y.triggerNotificationClick(s)}const i=await u.getAppState();if(await u.get("Options","notificationClickHandlerMatch")==="origin"){for(const s of Object.keys(i.pendingNotificationClickEvents))if(new URL(s).origin===location.origin){const r=i.pendingNotificationClickEvents[s];await t(r)}}else{let s=i.pendingNotificationClickEvents?.[e];if(s)await t(s);else if(!s&&e.endsWith("/")){const r=e.substring(0,e.length-1);s=i.pendingNotificationClickEvents?.[r],s&&await t(s)}}}static async checkAndTriggerUserChanged(){V.logMethodCall("checkAndTriggerUserChanged");const e=await u.getUserState(),{previousOneSignalId:t,previousExternalId:i}=e,n=await OneSignal.coreDirector.getIdentityModel(),s=n?.onesignalId,r=n?.externalId;if(!(s!==t||r!==i))return;e.previousOneSignalId=s,e.previousExternalId=r,await u.setUserState(e);const c={current:{onesignalId:s,externalId:r}};a.info("User state changed: ",c),Y.triggerUserChanged(c)}}const Fs="isOptedOut",Vs="isPushNotificationsEnabled",an="os_pageViews",cn="requiresPrivacyConsent";class ft{static removeLegacySubscriptionOptions(){localStorage.removeItem(Fs),localStorage.removeItem(Vs)}static setConsentRequired(e){localStorage.setItem(cn,e.toString())}static getConsentRequired(){return localStorage.getItem(cn)==="true"}static setLocalPageViewCount(e){localStorage.setItem(an,e.toString())}static getLocalPageViewCount(){return Number(localStorage.getItem(an))}}class Xt extends Yt{constructor(){super()}get onesignalId(){return this.getProperty("onesignalId")}set onesignalId(e){this.setProperty("onesignalId",e)}get ip(){return this.getProperty("ip")}set ip(e){this.setProperty("ip",e)}get country(){return this.getProperty("country")}set country(e){this.setProperty("country",e)}get language(){return this.getProperty("language")}set language(e){this.setProperty("language",e)}get timezone_id(){return this.getProperty("timezone_id")}set timezone_id(e){this.setProperty("timezone_id",e)}get tags(){return this.getProperty("tags")??{}}set tags(e){this.setProperty("tags",e)}}class Ws extends en{constructor(){super(new Oi(()=>new Xt,fe.Properties))}}const ei={ResubscribeExisting:0,SubscribeNew:1};class it{static async registerForPush(){return await it.internalRegisterForPush()}static async internalRegisterForPush(){const e=OneSignal.context;let t=null;try{const i=await e.subscriptionManager.subscribe(ei.ResubscribeExisting);t=await e.subscriptionManager.registerSubscription(i),e.pageViewManager.incrementPageViewCount(),await Pe.triggerNotificationPermissionChanged(),await Y.checkAndTriggerSubscriptionChanged()}catch(i){a.error(i)}return t}static isPushSubscriptionType(e){switch(e){case ee.ChromePush:case ee.SafariPush:case ee.SafariLegacyPush:case ee.FirefoxPush:return!0;default:return!1}}static toSubscriptionChannel(e){switch(e){case ee.Email:return $e.Email;case ee.SMS:return $e.SMS;default:return this.isPushSubscriptionType(e)?$e.Push:void 0}}}class $s extends Oi{constructor(){super(()=>new vt,fe.Subscriptions)}getBySubscriptionId(e){return super.list().find(t=>t.id===e)}replaceAll(e,t){if(t!==A.HYDRATE)return super.replaceAll(e,t);for(const i of e)if(it.isPushSubscriptionType(i.type)){const n=this.get(i.modelId);n&&(i.sdk=n.sdk,i.device_os=n.device_os);break}super.replaceAll(e,t)}}class Ni extends ut{constructor(e,t,i,n){super(e,t,i),n&&(this.subscriptionId=n)}get subscriptionId(){return this.getProperty("subscriptionId")}set subscriptionId(e){this.setProperty("subscriptionId",e)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Subscription.${this.subscriptionId}`}get canStartExecute(){return!Ee.isLocalId(this.onesignalId)&&!Ee.isLocalId(this.subscriptionId)}get applyToRecordId(){return this.subscriptionId}translateIds(e){super.translateIds(e),e[this.subscriptionId]&&(this.subscriptionId=e[this.subscriptionId])}}class ln extends Ni{constructor(e,t,i,n){super(e,t,i),n&&(this.sdk=re,this.device_model=Ft(),this.device_os=Bt(),this.enabled=n.enabled,this.notification_types=n.notification_types,this.subscriptionId=n.subscriptionId,this.token=n.token,this.type=n.type,this.web_auth=n.web_auth,this.web_p256=n.web_p256)}get type(){return this.getProperty("type")}set type(e){this.setProperty("type",e)}get token(){return this.getProperty("token")}set token(e){this.setProperty("token",e)}get enabled(){return this.getProperty("enabled")}set enabled(e){this.setProperty("enabled",e)}get notification_types(){return this.getProperty("notification_types")}set notification_types(e){this.setProperty("notification_types",e)}get sdk(){return this.getProperty("sdk")}set sdk(e){this.setProperty("sdk",e)}get device_model(){return this.getProperty("device_model")}set device_model(e){this.setProperty("device_model",e)}get device_os(){return this.getProperty("device_os")}set device_os(e){this.setProperty("device_os",e)}get web_auth(){return this.getProperty("web_auth")}set web_auth(e){this.setProperty("web_auth",e)}get web_p256(){return this.getProperty("web_p256")}set web_p256(e){this.setProperty("web_p256",e)}}class Ke extends ln{constructor(e){super(k.CREATE_SUBSCRIPTION,e?.appId,e?.onesignalId,e)}get canStartExecute(){return!Ee.isLocalId(this.onesignalId)}get applyToRecordId(){return this.onesignalId}translateIds(e){e[this.onesignalId]&&(this.onesignalId=e[this.onesignalId])}}class mt extends Ni{constructor(e,t,i){super(k.DELETE_SUBSCRIPTION,e,t),i&&(this.subscriptionId=i)}get groupComparisonType(){return ke.NONE}}class St extends ut{constructor(e,t,i,n){super(k.LOGIN_USER,e,t),i&&(this.externalId=i),n&&(this.existingOnesignalId=n)}get externalId(){return this.getProperty("externalId")}set externalId(e){this.setProperty("externalId",e)}get existingOnesignalId(){return this.getProperty("existingOnesignalId")}set existingOnesignalId(e){this.setProperty("existingOnesignalId",e)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}get modifyComparisonKey(){return""}get groupComparisonType(){return ke.CREATE}get canStartExecute(){return!this.existingOnesignalId||!Ee.isLocalId(this.existingOnesignalId)}get applyToRecordId(){return this.existingOnesignalId??this.onesignalId}translateIds(e){this.existingOnesignalId&&e[this.existingOnesignalId]&&(this.existingOnesignalId=e[this.existingOnesignalId])}}class Ct extends ut{constructor(e,t){super(k.REFRESH_USER,e,t)}get createComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Refresh`}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}.Refresh`}get groupComparisonType(){return ke.CREATE}}class Pt extends Ni{constructor(e,t,i){super(k.TRANSFER_SUBSCRIPTION,e,t),i&&(this.subscriptionId=i)}get groupComparisonType(){return ke.NONE}get modifyComparisonKey(){return`${this.appId}.Subscription.${this.subscriptionId}.Transfer`}}class bt extends ln{constructor(e){super(k.UPDATE_SUBSCRIPTION,e?.appId,e?.onesignalId,e)}}class Hs{_identityOperationExecutor;_identityModelStore;_propertiesModelStore;_subscriptionsModelStore;constructor(e,t,i,n){this._identityOperationExecutor=e,this._identityModelStore=t,this._propertiesModelStore=i,this._subscriptionsModelStore=n}get operations(){return[k.LOGIN_USER]}async execute(e){a.debug(`LoginUserOperationExecutor(operation: ${JSON.stringify(e)})`);const t=e[0];if(t instanceof St)return this.loginUser(t,e.slice(1));throw new Error(`Unrecognized operation: ${t.name}`)}async loginUser(e,t){const i=ft.getConsentRequired(),n=await u.getConsentGiven();if(i&&!n)throw new M("Login: Consent required but not given, skipping login");if(!e.existingOnesignalId||!e.externalId)return this.createUser(e,t);const s=await this._identityOperationExecutor.execute([new pt(e.appId,e.existingOnesignalId,Ne.EXTERNAL_ID,e.externalId)]);switch(s.result){case S.SUCCESS:{const r=e.existingOnesignalId,d=e.onesignalId;return this._identityModelStore.model.onesignalId===d&&this._identityModelStore.model.setProperty(Ne.ONESIGNAL_ID,r,A.HYDRATE),this._propertiesModelStore.model.onesignalId===d&&this._propertiesModelStore.model.setProperty("onesignalId",r,A.HYDRATE),new y(S.SUCCESS_STARTING_ONLY,void 0,void 0,{[e.onesignalId]:r})}case S.FAIL_CONFLICT:return a.debug(`Handling 409 for externalId: ${e.externalId}`),this.createUser(e,t);case S.FAIL_NORETRY:return a.error(`Recovering from SetAlias failure for externalId: ${e.externalId}`),this.createUser(e,t);default:return new y(s.result)}}async createUser(e,t){const i={};let n={};const s={timezone_id:ms(),language:Ks()};e.externalId&&(i[Ne.EXTERNAL_ID]=e.externalId);for(const b of t)if(b instanceof Ke||b instanceof Pt||b instanceof bt||b instanceof mt)n=this.createSubscriptionsFromOperation(b,n);else throw new Error(`Unrecognized operation: ${b.name}`);const r=Object.entries(n),d=await ae.createUser({appId:e.appId},{identity:i,subscriptions:r.map(([,b])=>b),properties:s});if(d.ok){const b=d.result.identity.onesignal_id,h=e.onesignalId,E={[e.onesignalId]:b};this._identityModelStore.model.onesignalId===h&&this._identityModelStore.model.setProperty(Ne.ONESIGNAL_ID,b,A.HYDRATE),this._propertiesModelStore.model.onesignalId===h&&this._propertiesModelStore.model.setProperty("onesignalId",b,A.HYDRATE);const w=d.result.properties;if(w)for(const[ge,we]of Object.entries(w))this._propertiesModelStore.model.setProperty(ge,we,A.HYDRATE);for(let ge=0;ge<r.length;ge++){const[we]=r[ge],We=d.result.subscriptions?.[ge];if(!We||!("id"in We))continue;E[we]=We.id,await u.getPushId()===we&&(await u.setPushId(We.id),await u.setPushToken(We.token));const _t=this._subscriptionsModelStore.getBySubscriptionId(we);_t?.setProperty("id",We.id,A.HYDRATE),_t?.setProperty("onesignalId",b,A.HYDRATE)}Y.checkAndTriggerUserChanged();const U=Object.keys(i).length>0?[new Ct(e.appId,b)]:void 0;return new y(S.SUCCESS,void 0,U,E)}const{status:c,retryAfterSeconds:l}=d;switch(Ue(c)){case x.RETRYABLE:return new y(S.FAIL_RETRY,l);case x.UNAUTHORIZED:return new y(S.FAIL_UNAUTHORIZED,l);default:return new y(S.FAIL_PAUSE_OPREPO)}}createSubscriptionsFromOperation(e,t){switch(!0){case e instanceof Ke:{const i=e.subscriptionId;return{...t,[i]:{enabled:e.enabled,device_model:e.device_model,device_os:e.device_os,notification_types:e.notification_types,sdk:e.sdk,token:e.token,type:e.type,web_auth:e.web_auth,web_p256:e.web_p256}}}case e instanceof bt:{const i=e.subscriptionId;return t[i]?{...t,[i]:{...t[i],enabled:e.enabled,notification_types:e.notification_types,token:e.token}}:t}case e instanceof Pt:{const i=e.subscriptionId;return{...t,[i]:{...t[i],id:i}}}case e instanceof mt:{const i={...t};return delete i[e.subscriptionId],i}default:return t}}}const js=["tw","hant"],qs=["cn","hans"],Ks=()=>{let o=navigator.language;if(o){o=o.toLowerCase();const e=o.split("-");if(e[0]=="zh"){for(const t of js)if(e.indexOf(t)!==-1)return"zh-Hant";for(const t of qs)if(e.indexOf(t)!==-1)return"zh-Hans";return"zh-Hant"}else return e[0].substring(0,2)}else return"en"};class Gs{_identityModelStore;_propertiesModelStore;_subscriptionsModelStore;_buildUserService;_newRecordState;constructor(e,t,i,n,s){this._identityModelStore=e,this._propertiesModelStore=t,this._subscriptionsModelStore=i,this._buildUserService=n,this._newRecordState=s}get operations(){return[k.REFRESH_USER]}async execute(e){if(a.debug(`RefreshUserOperationExecutor(operation: ${JSON.stringify(e)})`),e.some(i=>!(i instanceof Ct)))throw new Error(`Unrecognized operation(s)! Attempted operations:
${JSON.stringify(e)}`);const t=e[0];return this.getUser(t)}async getUser(e){const t=await ae.getUser({appId:e.appId},new te(Ne.ONESIGNAL_ID,e.onesignalId)),{ok:i,result:n,retryAfterSeconds:s,status:r}=t;if(i){if(e.onesignalId!==this._identityModelStore.model.onesignalId)return new y(S.SUCCESS);const c=new Jt;for(const[w,U]of Object.entries(n.identity))c.setProperty(w,U);const l=new Xt;l.onesignalId=e.onesignalId;const{properties:g={},subscriptions:b=[]}=n;Object.entries(g).forEach(([w,U])=>{l.setProperty(w,U)});const h=[];for(const w of b){const U=new vt;U.id=w.id,U.token=w.token??"",U.notification_types=w.notification_types??J.Subscribed,U.type=w.type,U.enabled=U.notification_types!==J.UserOptedOut,U.sdk=w.sdk,U.device_os=w.device_os,U.device_model=w.device_model,U.onesignalId=e.onesignalId,it.isPushSubscriptionType(U.type)||h.push(U)}const E=await u.getPushId();if(E){const w=this._subscriptionsModelStore.getBySubscriptionId(E);w&&(w.onesignalId=e.onesignalId,h.push(w))}return this._identityModelStore.replace(c,A.HYDRATE),this._propertiesModelStore.replace(l,A.HYDRATE),this._subscriptionsModelStore.replaceAll(h,A.HYDRATE),new y(S.SUCCESS)}switch(Ue(r)){case x.RETRYABLE:return new y(S.FAIL_RETRY,s);case x.UNAUTHORIZED:return new y(S.FAIL_UNAUTHORIZED,s);case x.MISSING:{if(r===404&&this._newRecordState.isInMissingRetryWindow(e.onesignalId))return new y(S.FAIL_RETRY,s);const c=await this._buildUserService.getRebuildOperationsIfCurrentUser(e.appId,e.onesignalId);return c?new y(S.FAIL_RETRY,s,c):new y(S.FAIL_NORETRY)}default:return new y(S.FAIL_NORETRY)}}}class zs{_subscriptionModelStore;_buildUserService;_newRecordState;constructor(e,t,i){this._subscriptionModelStore=e,this._buildUserService=t,this._newRecordState=i}get operations(){return[k.CREATE_SUBSCRIPTION,k.UPDATE_SUBSCRIPTION,k.DELETE_SUBSCRIPTION,k.TRANSFER_SUBSCRIPTION]}async execute(e){a.debug(`SubscriptionOperationExecutor(operations: ${e})`);const t=e[0];if(t instanceof Ke)return this.createSubscription(t,e);if(e.some(i=>i instanceof mt)){if(e.length>1)throw new Error(`Only supports one operation! Attempted operations:
${e}`);return this.deleteSubscription(e[0])}if(t instanceof bt)return this.updateSubscription(e);if(t instanceof Pt){if(e.length>1)throw new Error(`TransferSubscriptionOperation only supports one operation! Attempted operations:
${e}`);return this.transferSubscription(t)}throw new Error(`Unrecognized operation: ${t}`)}async createSubscription(e,t){if(t.some(h=>h instanceof mt))return new y(S.SUCCESS);const i=t.toReversed().find(h=>h instanceof bt),n=i?.enabled??e.enabled,s=i?.token??e.token,r=i?.notification_types??e.notification_types,d={sdk:e.sdk,type:e.type,enabled:n,token:s,notification_types:r},c=await ae.createSubscription({appId:e.appId},new te(Ne.ONESIGNAL_ID,e.onesignalId),{subscription:d});if(c.ok){const{subscription:h}=c.result,E=this._subscriptionModelStore.getBySubscriptionId(e.subscriptionId),w=h?.id;return w&&(E?.setProperty("id",w,A.HYDRATE),E?.setProperty("onesignalId",e.onesignalId,A.HYDRATE)),await u.getPushId()===e.subscriptionId&&(await u.setPushId(w),await u.setPushToken(h?.token)),new y(S.SUCCESS,void 0,w?void 0:[new Ct(e.appId,e.onesignalId)],w?{[e.subscriptionId]:w}:void 0)}const{retryAfterSeconds:l,status:g}=c;switch(Ue(g)){case x.RETRYABLE:return new y(S.FAIL_RETRY,l);case x.UNAUTHORIZED:return new y(S.FAIL_UNAUTHORIZED,l);case x.CONFLICT:case x.INVALID:return new y(S.FAIL_NORETRY);case x.MISSING:{if(g===404&&this._newRecordState.isInMissingRetryWindow(e.onesignalId))return new y(S.FAIL_RETRY,l);const h=await this._buildUserService.getRebuildOperationsIfCurrentUser(e.appId,e.onesignalId);return h?new y(S.FAIL_RETRY,l,h):new y(S.FAIL_NORETRY)}}}async updateSubscription(e){const t=e[e.length-1],i={type:t.type,enabled:t.enabled,token:t.token,notification_types:t.notification_types,web_auth:t.web_auth,web_p256:t.web_p256},n=await ae.updateSubscription({appId:t.appId},t.subscriptionId,i);if(n.ok)return new y(S.SUCCESS);const{retryAfterSeconds:s,status:r}=n;switch(Ue(r)){case x.RETRYABLE:return new y(S.FAIL_RETRY,s);case x.MISSING:return r===404&&[t.onesignalId,t.subscriptionId].some(c=>this._newRecordState.isInMissingRetryWindow(c))?new y(S.FAIL_RETRY,s):new y(S.FAIL_NORETRY,void 0,[new Ke({appId:t.appId,enabled:t.enabled,notification_types:t.notification_types,onesignalId:t.onesignalId,subscriptionId:t.subscriptionId,token:t.token,type:t.type})]);default:return new y(S.FAIL_NORETRY)}}async transferSubscription(e){const t=await ae.transferSubscription({appId:e.appId},e.subscriptionId,{onesignal_id:e.onesignalId},!1);if(t.ok)return new y(S.SUCCESS);const{retryAfterSeconds:i,status:n}=t;switch(Ue(n)){case x.RETRYABLE:return new y(S.FAIL_RETRY,i);default:return new y(S.FAIL_NORETRY)}}async deleteSubscription(e){const t=await ae.deleteSubscription({appId:e.appId},e.subscriptionId);if(t.ok)return this._subscriptionModelStore.remove(e.subscriptionId,A.HYDRATE),new y(S.SUCCESS);const{retryAfterSeconds:i,status:n}=t;switch(Ue(n)){case x.MISSING:return[e.onesignalId,e.subscriptionId].some(r=>this._newRecordState.isInMissingRetryWindow(r))?new y(S.FAIL_RETRY,i):new y(S.SUCCESS);case x.RETRYABLE:return new y(S.FAIL_RETRY,i);default:return new y(S.FAIL_NORETRY)}}}class ki{ip;tags;language;timezone_id;country;constructor(e={}){this.ip=e.ip,this.tags=e.tags,this.language=e.language,this.timezone_id=e.timezone_id,this.country=e.country}get hasAtLeastOnePropertySet(){return Object.values(this).some(e=>e!==void 0)}}class Nt extends ut{constructor(e,t,i,n){super(k.SET_PROPERTY,e,t),i&&n&&(this.property=i,this.value=n)}get property(){return this.getProperty("property")}set property(e){this.setProperty("property",e)}get value(){return this.getProperty("value")}set value(e){this.setProperty("value",e)}get modifyComparisonKey(){return`${this.appId}.User.${this.onesignalId}`}}class Ys{static createPropertiesFromOperation(e,t){if(e instanceof Nt){const i=e.property;return Object.keys(t).includes(i)?new ki({...t,[i]:e.value}):new ki({...t})}throw new Error(`Unsupported operation type: ${e.name}`)}}class Js{_identityModelStore;_propertiesModelStore;_buildUserService;_newRecordState;constructor(e,t,i,n){this._identityModelStore=e,this._propertiesModelStore=t,this._buildUserService=i,this._newRecordState=n}get operations(){return[k.SET_PROPERTY]}processOperations(e){let t=null,i=null,n=new ki;const s=!1;for(const r of e)if(r instanceof Nt)t||(t=r.appId,i=r.onesignalId),n=Ys.createPropertiesFromOperation(r,n);else throw new Error(`Unrecognized operation: ${r}`);return{appId:t,onesignalId:i,propertiesObject:n,refreshDeviceMetadata:s}}async execute(e){a.debug(`UpdateUserOperationExecutor(operation: ${e})`);const{appId:t,onesignalId:i,propertiesObject:n,refreshDeviceMetadata:s}=this.processOperations(e);if(!t||!i)return new y(S.SUCCESS);const r=await ae.updateUser({appId:t},new te(te.ONESIGNAL_ID,i),{properties:n,refresh_device_metadata:s}),{ok:d,retryAfterSeconds:c,status:l}=r,g=h=>h.property==="tags";if(d){if(this._identityModelStore.model.onesignalId===i){for(const h of e)if(h instanceof Nt){let E=h.value;if(g(h)){E={...h.value};for(const w in E)E[w]===""&&delete E[w]}this._propertiesModelStore.model.setProperty(h.property,E,A.HYDRATE)}}return new y(S.SUCCESS)}switch(Ue(l)){case x.RETRYABLE:return new y(S.FAIL_RETRY,c);case x.UNAUTHORIZED:return new y(S.FAIL_UNAUTHORIZED,c);case x.MISSING:{if(l===404&&this._newRecordState.isInMissingRetryWindow(i))return new y(S.FAIL_RETRY,c);const h=await this._buildUserService.getRebuildOperationsIfCurrentUser(t,i);return h?new y(S.FAIL_RETRY,c,h):new y(S.FAIL_NORETRY)}default:return new y(S.FAIL_NORETRY)}}}class dn{store;opRepo;constructor(e,t){this.store=e,this.opRepo=t,this.store.subscribe(this)}onModelReplaced(e,t){if(t!==A.NORMAL)return;const i=this.getReplaceOperation(e);i!=null&&this.opRepo.enqueue(i)}onModelUpdated(e,t){if(t!==A.NORMAL)return;const i=this.getUpdateOperation(e.model,e.property,e.oldValue,e.newValue);i!=null&&this.opRepo.enqueue(i)}}class Zs extends dn{constructor(e,t){super(e,t)}getReplaceOperation(e){return null}getUpdateOperation(e,t,i,n){const s=F.getAppId();return n!=null&&typeof n=="string"?new pt(s,e.onesignalId,t,n):new Zt(s,e.onesignalId,t)}}class Qs{store;opRepo;constructor(e,t){this.store=e,this.opRepo=t,this.store.subscribe(this)}close(){this.store.unsubscribe(this)}onModelAdded(e,t){if(t!==A.NORMAL)return;const i=this.getAddOperation(e);i!=null&&this.opRepo.enqueue(i)}async onModelUpdated(e,t){if(t!==A.NORMAL)return;const i=await this.getUpdateOperation(e.model,e.property,e.oldValue,e.newValue);i!=null&&this.opRepo.enqueue(i)}async onModelRemoved(e,t){if(t!==A.NORMAL)return;const i=await this.getRemoveOperation(e);i!=null&&this.opRepo.enqueue(i)}}class Xs extends dn{constructor(e,t){super(e,t)}getReplaceOperation(e){return null}getUpdateOperation(e,t,i,n){const s=F.getAppId();return new Nt(s,e.onesignalId,t,n)}}class ti extends Qs{_identityModelStore;constructor(e,t,i){super(e,t),this._identityModelStore=i}getAddOperation(e){const{enabled:t,notification_types:i}=ti.getSubscriptionEnabledAndStatus(e),n=F.getAppId();return new Ke({appId:n,onesignalId:this._identityModelStore.model.onesignalId,subscriptionId:e.id,type:e.type,enabled:t,token:e.token,notification_types:i})}getRemoveOperation(e){const t=F.getAppId();return new mt(t,this._identityModelStore.model.onesignalId,e.id)}getUpdateOperation(e){const{enabled:t,notification_types:i}=ti.getSubscriptionEnabledAndStatus(e),n=F.getAppId();return new bt({appId:n,onesignalId:this._identityModelStore.model.onesignalId,subscriptionId:e.id,type:e.type,enabled:t,token:e.token,notification_types:i,web_auth:e.web_auth,web_p256:e.web_p256})}static getSubscriptionEnabledAndStatus(e){let t,i;return e.enabled&&e.notification_types===J.Subscribed&&e.token?(t=!0,i=J.Subscribed):(t=!1,i=e.enabled?e.notification_types:J.UserOptedOut),{enabled:t,notification_types:i}}}class eo extends Xi{constructor(){super(fe.Operations)}async loadOperations(){return this.load()}create(e){if(e===null)return a.error("null jsonObject sent to OperationModelStore.create"),null;if(!this.isValidOperation(e))return null;const t=e.name;let i;switch(t){case k.SET_ALIAS:i=new pt;break;case k.DELETE_ALIAS:i=new Zt;break;case k.CREATE_SUBSCRIPTION:i=new Ke;break;case k.UPDATE_SUBSCRIPTION:i=new bt;break;case k.DELETE_SUBSCRIPTION:i=new mt;break;case k.TRANSFER_SUBSCRIPTION:i=new Pt;break;case k.LOGIN_USER:i=new St;break;case k.REFRESH_USER:i=new Ct;break;case k.SET_PROPERTY:i=new Nt;break;case k.CUSTOM_EVENT:i=new Ti;break;default:throw new Error(`Unrecognized operation: ${t}`)}return i.initializeFromJson(e),i}isValidOperation(e){const t=e?.name;if(!t)return a.error("jsonObject must have 'name' attribute"),!1;const i=new Set([k.LOGIN_USER]);return!e.onesignalId&&!i.has(t)?(a.error(`${t} jsonObject must have 'onesignalId' attribute`),!1):!0}}class to{_identityModelStore;_propertiesModelStore;_subscriptionsModelStore;constructor(e,t,i){this._identityModelStore=e,this._propertiesModelStore=t,this._subscriptionsModelStore=i}async getRebuildOperationsIfCurrentUser(e,t){const i=new Jt;i.initializeFromModel(null,this._identityModelStore.model),new Xt().initializeFromModel(null,this._propertiesModelStore.model);const s=[];for(const l of this._subscriptionsModelStore.list()){const g=new vt;g.initializeFromModel(null,l),s.push(g)}if(i.onesignalId!==t)return null;const r=[];r.push(new St(e,t,i.externalId));const d=await u.getPushId(),c=s.find(l=>l.id===d);return c&&r.push(new Ke({appId:e,onesignalId:t,subscriptionId:c.id,type:c.type,enabled:c.enabled,token:c.token,notification_types:c.notification_types})),r.push(new Ct(e,t)),r}}const un=o=>{u.remove(fe.Operations,o.modelId)};class ii{operation;bucket;retries;resolver;constructor(e){this.operation=e.operation,this.bucket=e.bucket,this.retries=e.retries??0,this.resolver=e.resolver}toString(){return`bucket:${this.bucket}, retries:${this.retries}, operation:${this.operation}
`}}class io{executorsMap;queue=[];paused=!0;enqueueIntoBucket=0;operationModelStore;newRecordState;constructor(e,t,i){this.operationModelStore=t,this.newRecordState=i,this.executorsMap=new Map;for(const n of e)for(const s of n.operations)this.executorsMap.set(s,n)}get isPaused(){return this.paused}get records(){return this.newRecordState.records}get executeBucket(){return this.enqueueIntoBucket===0?0:this.enqueueIntoBucket-1}containsInstanceOf(e){return this.queue.some(t=>t.operation instanceof e)}async start(){this.paused=!1,await this.loadSavedOperations(),this.processQueueForever()}enqueue(e){a.debug(`OperationRepo.enqueue(operation: ${e})`),this.internalEnqueue(new ii({operation:e,bucket:this.enqueueIntoBucket}),!0)}async enqueueAndWait(e){a.debug(`OperationRepo.enqueueAndWaitoperation: ${e})`),await new Promise(t=>{this.internalEnqueue(new ii({operation:e,bucket:this.enqueueIntoBucket,resolver:t}),!0)})}internalEnqueue(e,t,i){if(this.queue.some(s=>s.operation.modelId===e.operation.modelId)){a.debug(`OperationRepo: internalEnqueue - operation.modelId: ${e.operation.modelId} already exists in the queue.`);return}i!==void 0?this.queue.splice(i,0,e):this.queue.push(e),t&&this.operationModelStore.add(e.operation)}async processQueueForever(){this.enqueueIntoBucket++;let e=!1;setInterval(async()=>{if(this.paused)return a.debug("OpRepo is paused");if(e)return a.debug("Operations in progress");const t=this.getNextOps(this.executeBucket);a.debug(`processQueueForever:ops:
${t}`),t?(e=!0,await this.executeOperations(t),e=!1):this.enqueueIntoBucket++},Cs)}async executeOperations(e){try{const t=e[0],i=this.executorsMap.get(t.operation.name);if(!i)throw new Error(`Could not find executor for operation ${t.operation.name}`);const n=e.map(c=>c.operation),s=await i.execute(n),r=s.idTranslations;a.debug(`OperationRepo: execute response = ${s.result}`),r&&(e.forEach(c=>c.operation.translateIds(r)),this.queue.forEach(c=>c.operation.translateIds(r)),Object.values(r).forEach(c=>this.newRecordState.add(c)));let d=0;switch(s.result){case S.SUCCESS:e.forEach(c=>{this.operationModelStore.remove(c.operation.modelId)}),e.forEach(c=>c.resolver?.(!0));break;case S.FAIL_UNAUTHORIZED:case S.FAIL_NORETRY:case S.FAIL_CONFLICT:a.error(`Operation execution failed without retry: ${n}`),e.forEach(c=>{this.operationModelStore.remove(c.operation.modelId)}),e.forEach(c=>c.resolver?.(!1));break;case S.SUCCESS_STARTING_ONLY:this.operationModelStore.remove(t.operation.modelId),t.resolver?.(!0),e.filter(c=>c!==t).reverse().forEach(c=>this.queue.unshift(c));break;case S.FAIL_RETRY:a.error(`Operation execution failed, retrying: ${n}`),e.toReversed().forEach(c=>{un(c.operation),c.retries++,c.retries>d&&(d=c.retries),this.queue.unshift(c)});break;case S.FAIL_PAUSE_OPREPO:a.error(`Operation execution failed with eventual retry, pausing the operation repo: ${n}`),this.paused=!0,e.toReversed().forEach(c=>{un(c.operation),this.queue.unshift(c)});break}if(s.operations)for(const c of s.operations.toReversed()){const l=new ii({operation:c,bucket:0});this.queue.unshift(l),this.operationModelStore.addAt(0,l.operation)}await this.delayBeforeNextExecution(d,s.retryAfterSeconds),s.idTranslations&&await lt(tn)}catch(t){a.error(`Error attempting to execute operation: ${e}`,t),e.forEach(i=>{this.operationModelStore.remove(i.operation.modelId)}),e.forEach(i=>i.resolver?.(!1))}}async delayBeforeNextExecution(e,t){a.debug(`retryAfterSeconds: ${t}`);const i=(t||0)*1e3,n=e*Ts,s=Math.max(n,i);s<1||(a.error(`Operations being delay for: ${s} ms`),await lt(s))}getNextOps(e){const t=this.queue.findIndex(i=>i.operation.canStartExecute&&this.newRecordState.canAccess(i.operation.applyToRecordId)&&i.bucket<=e);if(t!==-1){const i=this.queue[t];return this.queue.splice(t,1),this.getGroupableOperations(i)}return null}getGroupableOperations(e){const t=[e];if(e.operation.groupComparisonType===ke.NONE)return t;const i=e.operation.groupComparisonType===ke.CREATE?e.operation.createComparisonKey:e.operation.modifyComparisonKey,n=[...this.queue];for(const s of n){const r=e.operation.groupComparisonType===ke.CREATE?s.operation.createComparisonKey:s.operation.modifyComparisonKey;if(r===""&&i==="")throw new Error("Both comparison keys cannot be blank!");if(this.newRecordState.canAccess(s.operation.applyToRecordId)&&r===i){const d=this.queue.indexOf(s);d!==-1&&(this.queue.splice(d,1),t.push(s))}}return t}async loadSavedOperations(){await this.operationModelStore.loadOperations();const e=this.operationModelStore.list().toReversed();for(const t of e)this.internalEnqueue(new ii({operation:t,bucket:this.enqueueIntoBucket}),!1,0)}}class no{operationModelStore;operationRepo;newRecordsState;subscriptionModelStore;identityModelStore;propertiesModelStore;customEventController;initPromise;rebuildUserService;executors;listeners;constructor(){this.newRecordsState=new Ns,this.operationModelStore=new eo,this.identityModelStore=new Es,this.propertiesModelStore=new Ws,this.subscriptionModelStore=new $s,this.rebuildUserService=new to(this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore),this.executors=this.initializeExecutors(),this.operationRepo=new io(this.executors,this.operationModelStore,this.newRecordsState),this.customEventController=new vs(this.identityModelStore,this.operationRepo),this.listeners=this.initializeListeners(),this.initPromise=this.operationRepo.start()}async init(){return I("CoreModule.init"),this.initPromise}initializeListeners(){return this.operationRepo?[new Zs(this.identityModelStore,this.operationRepo),new Xs(this.propertiesModelStore,this.operationRepo),new ti(this.subscriptionModelStore,this.operationRepo,this.identityModelStore)]:[]}initializeExecutors(){const e=new ks(this.identityModelStore,this.rebuildUserService,this.newRecordsState),t=new Hs(e,this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore),i=new Gs(this.identityModelStore,this.propertiesModelStore,this.subscriptionModelStore,this.rebuildUserService,this.newRecordsState),n=new zs(this.subscriptionModelStore,this.rebuildUserService,this.newRecordsState),s=new Js(this.identityModelStore,this.propertiesModelStore,this.rebuildUserService,this.newRecordsState),r=new Os;return[e,t,i,n,s,r]}}class nt{w3cEndpoint;w3cP256dh;w3cAuth;safariDeviceToken;static setFromW3cSubscription(e){const t=new nt;if(e&&(t.w3cEndpoint=new URL(e.endpoint),e.getKey)){let i=null;try{i=e.getKey("p256dh")}catch{}let n=null;try{n=e.getKey("auth")}catch{}if(i){const s=btoa(String.fromCharCode(...new Uint8Array(i)));t.w3cP256dh=s}if(n){const s=btoa(String.fromCharCode(...new Uint8Array(n)));t.w3cAuth=s}}return t}setFromSafariSubscription(e){e&&(this.safariDeviceToken=e)}serialize(){return{w3cEndpoint:this.w3cEndpoint?this.w3cEndpoint.toString():null,w3cP256dh:this.w3cP256dh,w3cAuth:this.w3cAuth,safariDeviceToken:this.safariDeviceToken}}static deserialize(e){const t=new nt;if(!e)return t;try{t.w3cEndpoint=new URL(e.w3cEndpoint)}catch{}return t.w3cP256dh=e.w3cP256dh,t.w3cAuth=e.w3cAuth,t.safariDeviceToken=e.safariDeviceToken,t}}class pn{type;token;enabled;notificationTypes;sdk;deviceModel;deviceOs;webAuth;webp256;constructor(e){this.token=this._getToken(e),this.type=rt(),this.enabled=!0,this.notificationTypes=J.Subscribed,this.sdk=re,this.deviceModel=Ft(),this.deviceOs=Bt(),this.webAuth=e.w3cAuth,this.webp256=e.w3cP256dh}_getToken(e){return e.w3cEndpoint?e.w3cEndpoint.toString():e.safariDeviceToken}serialize(){return{type:this.type,token:this.token,enabled:this.enabled,notification_types:this.notificationTypes,sdk:this.sdk,device_model:this.deviceModel,device_os:this.deviceOs,web_auth:this.webAuth,web_p256:this.webp256}}}class so{core;constructor(e){this.core=e}get operationRepo(){return this.core.operationRepo}get identityModelStore(){return this.core.identityModelStore}get propertiesModelStore(){return this.core.propertiesModelStore}get subscriptionModelStore(){return this.core.subscriptionModelStore}get customEventController(){return this.core.customEventController}generatePushSubscriptionModel(e){I("CoreModuleDirector.generatePushSubscriptionModel",{rawPushSubscription:e});const t=new vt;return t.initializeFromJson(new pn(e).serialize()),t.id=Ee.createLocalId(),u.setPushId(t.id),this.core.subscriptionModelStore.add(t,A.HYDRATE),t}addSubscriptionModel(e){this.core.subscriptionModelStore.add(e)}removeSubscriptionModel(e){this.core.subscriptionModelStore.remove(e)}getNewRecordsState(){return this.core.newRecordsState}getEmailSubscriptionModels(){return I("CoreModuleDirector.getEmailSubscriptionModels"),this.core.subscriptionModelStore.list().filter(t=>t.type===ee.Email)}async hasEmail(){const e=this.getEmailSubscriptionModels();return Object.keys(e).length>0}getSmsSubscriptionModels(){return I("CoreModuleDirector.getSmsSubscriptionModels"),this.core.subscriptionModelStore.list().filter(t=>t.type===ee.SMS)}async hasSms(){const e=this.getSmsSubscriptionModels();return Object.keys(e).length>0}getAllPushSubscriptionModels(){return I("CoreModuleDirector.getAllPushSubscriptionModels"),this.core.subscriptionModelStore.list().filter(t=>it.isPushSubscriptionType(t.type))}async getPushSubscriptionModelByCurrentToken(){I("CoreModuleDirector.getPushSubscriptionModelByCurrentToken");const e=await F.getCurrentPushToken();if(e)return this.getSubscriptionOfTypeWithToken($e.Push,e)}async getPushSubscriptionModelByLastKnownToken(){I("CoreModuleDirector.getPushSubscriptionModelByLastKnownToken");const e=await u.getPushToken();if(e)return this.getSubscriptionOfTypeWithToken($e.Push,e)}async getPushSubscriptionModel(){return I("CoreModuleDirector.getPushSubscriptionModel"),await this.getPushSubscriptionModelByCurrentToken()||await this.getPushSubscriptionModelByLastKnownToken()}getIdentityModel(){return I("CoreModuleDirector.getIdentityModel"),this.core.identityModelStore.model}getPropertiesModel(){return I("CoreModuleDirector.getPropertiesModel"),this.core.propertiesModelStore.model}async getAllSubscriptionsModels(){I("CoreModuleDirector.getAllSubscriptionsModels");const e=this.getEmailSubscriptionModels(),t=this.getSmsSubscriptionModels(),i=await this.getPushSubscriptionModel();return[...e,...t,...i?[i]:[]]}getSubscriptionOfTypeWithToken(e,t){I("CoreModuleDirector.getSubscriptionOfTypeWithToken",{type:e,token:t});let i;switch(e){case $e.Email:i=this.getEmailSubscriptionModels();break;case $e.SMS:i=this.getSmsSubscriptionModels();break;case $e.Push:i=this.getAllPushSubscriptionModels();break;default:return}return i.find(n=>n.token===t)}}class kt{static async createUserOnServer(){const e=OneSignal.coreDirector.getIdentityModel(),t=F.getAppId(),n=(await OneSignal.coreDirector.getAllSubscriptionsModels()).length>0,s=!!e.externalId;if(!n&&!s)return a.info("No subscriptions or external ID found, skipping user creation");const r=await OneSignal.coreDirector.getPushSubscriptionModel();if(r){const d=r.toJSON();OneSignal.coreDirector.operationRepo.enqueue(new St(t,e.onesignalId,e.externalId)),await OneSignal.coreDirector.operationRepo.enqueueAndWait(new Ke({...d,appId:t,onesignalId:e.onesignalId,subscriptionId:r.id}))}else OneSignal.coreDirector.operationRepo.enqueue(new St(t,e.onesignalId,e.externalId))}static resetUserModels(){const e=new Jt,t=new Xt,i=Ee.createLocalId();e.onesignalId=i,t.onesignalId=i,OneSignal.coreDirector.identityModelStore.replace(e),OneSignal.coreDirector.propertiesModelStore.replace(t)}}class ve{static switchingUsersPromise=Promise.resolve();static async login(e,t){await(this.switchingUsersPromise=ve._login(e,t))}static async _login(e,t){t&&u.setJWTToken(t);let i=v.coreDirector.getIdentityModel();const n=i.onesignalId,s=i.externalId;if(s===e){a.debug("Login: External ID already set, skipping login");return}kt.resetUserModels(),i=v.coreDirector.getIdentityModel(),i.setProperty("external_id",e,A.HYDRATE);const r=i.onesignalId,d=F.getAppId(),c=await v.coreDirector.getPushSubscriptionModel();c&&v.coreDirector.operationRepo.enqueue(new Pt(d,r,c.id)),await v.coreDirector.operationRepo.enqueueAndWait(new St(d,r,e,s?void 0:n))}static async logout(){await(this.switchingUsersPromise=ve._logout())}static async _logout(){return v.coreDirector.getIdentityModel().externalId?(kt.resetUserModels(),kt.createUserOnServer()):a.debug("Logout: User is not logged in, skipping logout")}}class At{static async getRegistration(e){try{const t=location.origin+e;return await navigator.serviceWorker.getRegistration(t)}catch(t){a.warn("[Service Worker Status] Error Checking service worker registration",e,t);return}}static getAvailableServiceWorker(e){const t=e.active||e.installing||e.waiting;return t||a.warn("Could not find an available ServiceWorker instance!"),t}static waitUntilActive(e){return new Promise(t=>{const i=e.installing||e.waiting;i&&i.addEventListener("statechange",()=>{a.debug("OneSignal Service Worker state changed:",i.state),e.active&&t()}),e.active&&t()})}}class ni extends M{status;statusText;constructor(e,t){super("Registration of a Service Worker failed."),this.status=e,this.statusText=t,Object.setPrototypeOf(this,ni.prototype)}}class Me{static debug(...e){self.shouldLog&&console.debug(...e)}static trace(...e){self.shouldLog&&console.trace(...e)}static info(...e){self.shouldLog&&console.info(...e)}static warn(...e){self.shouldLog&&console.warn(...e)}static error(...e){self.shouldLog&&console.error(...e)}}function gn(o,e){const t=e*1e3;let i,n=()=>{};return{promise:new Promise((r,d)=>{let c=!1;i=self.setTimeout(async()=>{c=!0;try{await o(),r()}catch(l){Me.error("Failed to execute callback",l),d()}},t),n=()=>{Me.debug("Cancel called"),self.clearTimeout(i),c||r()}}),cancel:n}}class st{static QUERY_STRING="?";path;constructor(e){if(!e)throw new _("path",N.Empty);this.path=e.trim()}getQueryString(){const e=this.path.indexOf("?");return e===-1?null:this.path.length>e?this.path.substring(e+1):null}getWithoutQueryString(){return this.path.split(st.QUERY_STRING)[0]}getFileName(){return this.getWithoutQueryString().split("\\").pop()?.split("/").pop()}getFileNameWithQuery(){return this.path.split("\\").pop()?.split("/").pop()}getFullPath(){return this.path}}const oo="sendOutcome",ro="sendUniqueOutcome";class xt{outcomeName;config;appId;isUnique;constructor(e,t,i,n){this.outcomeName=i,this.config=t,this.appId=e,this.isUnique=n}async getAttribution(){return await xt.getAttribution(this.config)}async beforeOutcomeSend(){const e=this.isUnique?ro:oo;return I(e,this.outcomeName),this.config?this.outcomeName?(await le(),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?!0:(a.warn("Reporting outcomes is supported only for subscribed users."),!1)):(a.error("Outcome name is required"),!1):(a.debug("Outcomes feature not supported by main application yet."),!1)}async getAttributedNotifsByUniqueOutcomeName(){return(await u.getAll("SentUniqueOutcome")).filter(t=>t.outcomeName===this.outcomeName).reduce((t,i)=>{const n=i.notificationIds||[];return[...t,...n]},[])}async getNotifsToAttributeWithUniqueOutcome(e){const t=await this.getAttributedNotifsByUniqueOutcomeName();return e.filter(i=>t.indexOf(i)===-1)}shouldSendUnique(e,t){return e.type===Ce.Unattributed?!0:t.length>0}async saveSentUniqueOutcome(e){const t=this.outcomeName,i=await u.get("SentUniqueOutcome",t),n=await u.getCurrentSession(),r=[...i?i.notificationIds:[],...e],d=n?n.startTimestamp:null;await u.put("SentUniqueOutcome",{outcomeName:t,notificationIds:r,sentDuringSession:d})}async wasSentDuringSession(){const e=await u.get("SentUniqueOutcome",this.outcomeName);if(!e)return!1;const t=await u.getCurrentSession(),i=t&&e.sentDuringSession===t.startTimestamp,n=!t&&!!e.sentDuringSession;return i||n}async send(e){const{type:t,notificationIds:i,weight:n}=e;switch(t){case Ce.Direct:this.isUnique&&await this.saveSentUniqueOutcome(i),await OneSignal.context.updateManager.sendOutcomeDirect(this.appId,i,this.outcomeName,n);return;case Ce.Indirect:this.isUnique&&await this.saveSentUniqueOutcome(i),await OneSignal.context.updateManager.sendOutcomeInfluenced(this.appId,i,this.outcomeName,n);return;case Ce.Unattributed:if(this.isUnique){if(await this.wasSentDuringSession()){a.warn("(Unattributed) unique outcome was already sent during this session");return}await this.saveSentUniqueOutcome([])}await OneSignal.context.updateManager.sendOutcomeUnattributed(this.appId,this.outcomeName,n);return;default:a.warn("You are on a free plan. Please upgrade to use this functionality.");return}}static async getAttribution(e){if(e.direct&&e.direct.enabled){const t=await u.getAllNotificationClickedForOutcomes();if(t.length>0)return{type:Ce.Direct,notificationIds:[t[0].notificationId]}}if(e.indirect&&e.indirect.enabled){const t=e.indirect.influencedTimePeriodMin*60*1e3,n=new Date(new Date().getTime()-t).getTime(),s=await u.getAllNotificationReceivedForOutcomes();if(a.debug(`	Found total of ${s.length} received notifications`),s.length>0){const r=e.indirect.influencedNotificationsLimit,d=H.sortArrayOfObjects(s,g=>g.timestamp,!0,!1),c=d.filter(g=>g.timestamp>=n).slice(0,r).map(g=>g.notificationId);a.debug(`	Total of ${c.length} received notifications are within reporting window.`);const l=d.filter(g=>c.indexOf(g.notificationId)===-1).map(g=>g.notificationId);if(l.forEach(g=>u.remove(bi,g)),a.debug(`	${l.length} received notifications will be deleted.`),c.length>0)return{type:Ce.Indirect,notificationIds:c}}}return e.unattributed&&e.unattributed.enabled?{type:Ce.Unattributed,notificationIds:[]}:{type:Ce.NotSupported,notificationIds:[]}}}class Oe{static getServiceWorkerHref(e,t,i){return Oe.appendServiceWorkerParams(e.workerPath.getFullPath(),t,i)}static appendServiceWorkerParams(e,t,i){const n=new URL(e,V.getBaseUrl()).href,s=H.encodeHashAsUriComponent({appId:t}),r=H.encodeHashAsUriComponent({sdkVersion:i});return`${n}?${s}&${r}`}static async upsertSession(e,t,i,n,s,r,d){const c=await u.getCurrentSession();if(!c){const h=Zi({appId:e}),E=await u.getLastNotificationClickedForOutcomes(e);E&&(h.notificationId=E.notificationId),await u.upsertSession(h),await Oe.sendOnSessionCallIfNotPlayerCreate(e,t,i,r,h);return}if(c.status===ct.Active){Me.debug("Session already active",c);return}if(!c.lastDeactivatedTimestamp){Me.debug("Session is in invalid state",c);return}const l=new Date().getTime();if(Oe.timeInSecondsBetweenTimestamps(l,c.lastDeactivatedTimestamp)<=n){c.status=ct.Active,c.lastActivatedTimestamp=l,c.lastDeactivatedTimestamp=null,await u.upsertSession(c);return}await Oe.finalizeSession(e,t,i,c,s,d);const b=Zi({appId:e});await u.upsertSession(b),await Oe.sendOnSessionCallIfNotPlayerCreate(e,t,i,r,b)}static async deactivateSession(e,t,i,n,s,r){const d=await u.getCurrentSession();if(!d){Me.debug("No active session found. Cannot deactivate.");return}const c=()=>Oe.finalizeSession(e,t,i,d,s,r);if(d.status===ct.Inactive)return gn(c,n);if(d.status!==ct.Active){Me.warn(`Session in invalid state ${d.status}. Cannot deactivate.`);return}const l=new Date().getTime(),g=Oe.timeInSecondsBetweenTimestamps(l,d.lastActivatedTimestamp);d.lastDeactivatedTimestamp=l,d.accumulatedDuration+=g,d.status=ct.Inactive;const b=gn(c,n);return await u.upsertSession(d),b}static async sendOnSessionCallIfNotPlayerCreate(e,t,i,n,s){n!==De.UserCreate&&(u.upsertSession(s),u.resetSentUniqueOutcomes(),await qi.updateUserSession(e,t,i))}static async finalizeSession(e,t,i,n,s,r){if(Me.debug("Finalize session",`started: ${new Date(n.startTimestamp)}`,`duration: ${n.accumulatedDuration}s`),s){Me.debug(`send on_focus reporting session duration -> ${n.accumulatedDuration}s`);const d=await xt.getAttribution(r);Me.debug("send on_focus with attribution",d),await qi.sendSessionDuration(e,t,i,n.accumulatedDuration,d)}await Promise.all([u.cleanupCurrentSession(),u.removeAllNotificationClickedForOutcomes()]),Me.debug("Finalize session finished",`started: ${new Date(n.startTimestamp)}`)}static timeInSecondsBetweenTimestamps(e,t){return e<=t?0:Math.floor((e-t)/1e3)}}const Be={OneSignalWorker:"OneSignal Worker",ThirdParty:"3rd Party",None:"None"},Re={WorkerVersion:"GetWorkerVersion",NotificationWillDisplay:"notification.willDisplay",NotificationClicked:"notification.clicked",NotificationDismissed:"notification.dismissed",SessionUpsert:"os.session.upsert",SessionDeactivate:"os.session.deactivate",AreYouVisible:"os.page_focused_request",AreYouVisibleResponse:"os.page_focused_response"};class ao{replies;constructor(){this.replies={}}addListener(e,t,i){const n={callback:t,onceListenerOnly:i},s=this.replies[e.toString()];s?s.push(n):this.replies[e.toString()]=[n]}findListenersForMessage(e){return this.replies[e.toString()]||[]}deleteListenerRecords(e){this.replies[e.toString()]=null}deleteAllListenerRecords(){this.replies={}}deleteListenerRecord(e,t){const i=this.replies[e.toString()];if(i!=null)for(let n=i.length-1;n>=0;n--)i[n]===t&&i.splice(n,1)}}class co{context;replies;constructor(e,t=new ao){this.context=e,this.replies=t}async broadcast(e,t){}async unicast(e,t,i){a.debug(`[Worker Messenger] [Page -> SW] Unicasting '${e.toString()}' to service worker.`),this.directPostMessageToSW(e,t)}async directPostMessageToSW(e,t){a.debug(`[Worker Messenger] [Page -> SW] Direct command '${e.toString()}' to service worker.`);const i=await this.context?.serviceWorkerManager.getOneSignalRegistration();if(!i){a.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorkerRegistration to postMessage!");return}const n=At.getAvailableServiceWorker(i);if(!n){a.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorker to postMessage!");return}n.postMessage({command:e,payload:t})}async listen(){Hi()&&await this.listenForPage()}async listenForPage(){navigator.serviceWorker.addEventListener("message",this.onPageMessageReceivedFromServiceWorker.bind(this)),a.debug(`(${location.origin}) [Worker Messenger] Page is now listening for messages.`)}onWorkerMessageReceivedFromPage(e){const t=e.data;if(!t||!t.command)return;const i=this.replies.findListenersForMessage(t.command),n=[],s=[];a.debug("[Worker Messenger] Service worker received message:",e.data);for(const r of i)r.onceListenerOnly&&n.push(r),s.push(r);for(let r=n.length-1;r>=0;r--){const d=n[r];this.replies.deleteListenerRecord(t.command,d)}for(const r of s)r.callback.apply(null,[t.payload])}onPageMessageReceivedFromServiceWorker(e){const t=e.data;if(!t||!t.command)return;const i=this.replies.findListenersForMessage(t.command),n=[],s=[];a.debug("[Worker Messenger] Page received message:",e.data);for(const r of i)r.onceListenerOnly&&n.push(r),s.push(r);for(let r=n.length-1;r>=0;r--){const d=n[r];this.replies.deleteListenerRecord(t.command,d)}for(const r of s)r.callback.apply(null,[t.payload])}on(e,t){this.replies.addListener(e,t,!1)}once(e,t){this.replies.addListener(e,t,!0)}off(e){e?this.replies.deleteListenerRecords(e):this.replies.deleteAllListenerRecords()}}class Ai{context;config;constructor(e,t){this.context=e,this.config=t}async getRegistration(){return At.getRegistration(this.config.registrationOptions.scope)}async getOneSignalRegistration(){if(await this.getActiveState()===Be.OneSignalWorker)return this.getRegistration()}async getActiveState(){const e=await this.getRegistration();if(!e)return Be.None;const t=Ai.activeSwFileName(e);return this.swActiveStateByFileName(t)}static activeSwFileName(e){const t=At.getAvailableServiceWorker(e);if(!t)return null;const i=new URL(t.scriptURL).pathname,n=new st(i).getFileName();if(n=="akam-sw.js"){const r=new URLSearchParams(new URL(t.scriptURL).search).get("othersw");if(r)return a.debug("Found a ServiceWorker under Akamai's akam-sw.js?othersw=",r),new st(new URL(r).pathname).getFileName()}return n}swActiveStateByFileName(e){return e?e==this.config.workerPath.getFileName()||e=="OneSignalSDK.sw.js"?Be.OneSignalWorker:Be.ThirdParty:Be.None}async getWorkerVersion(){return new Promise(async e=>{this.context.workerMessenger.once(Re.WorkerVersion,t=>{e(t)}),await this.context.workerMessenger.unicast(Re.WorkerVersion)})}async shouldInstallWorker(){if(!Hi()||!OneSignal.config)return!1;const e=await this.getActiveState();if(a.debug("[shouldInstallWorker] workerState",e),e===Be.None||e===Be.ThirdParty){const i=await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)==="granted";return i&&a.info("[shouldInstallWorker] Notification Permissions enabled, will install ServiceWorker"),i}return await this.haveParamsChanged()?!0:this.workerNeedsUpdate()}async haveParamsChanged(){const e=await this.getRegistration();if(!e)return a.info("[changedServiceWorkerParams] workerRegistration not found at scope",this.config.registrationOptions.scope),!0;const t=new URL(e.scope).pathname,i=this.config.registrationOptions.scope;if(t!=i)return a.info("[changedServiceWorkerParams] ServiceWorker scope changing",{a_old:t,b_new:i}),!0;const n=At.getAvailableServiceWorker(e),s=Oe.getServiceWorkerHref(this.config,this.context.appConfig.appId,re);return n?.scriptURL?s!==n.scriptURL?(a.info("[changedServiceWorkerParams] ServiceWorker href changing:",{a_old:n?.scriptURL,b_new:s}),!0):!1:!0}async workerNeedsUpdate(){a.info("[Service Worker Update] Checking service worker version...");let e;try{e=await H.timeoutPromise(this.getWorkerVersion(),2e3)}catch{return a.info("[Service Worker Update] Worker did not reply to version query; assuming older version and updating."),!0}return e!==re?(a.info(`[Service Worker Update] Updating service worker from ${e} --> ${re}.`),!0):(a.info(`[Service Worker Update] Service worker version is current at ${e} (no update required).`),!1)}async establishServiceWorkerChannel(){a.debug("establishServiceWorkerChannel");const e=this.context.workerMessenger;e.off(),e.on(Re.NotificationWillDisplay,async i=>{a.debug(location.origin,"Received notification display event from service worker.");const n={notification:i.notification,preventDefault:function(){throw new Error("Browser does not support preventing display.")}};await O.trigger(OneSignal.EVENTS.NOTIFICATION_WILL_DISPLAY,n)}),e.on(Re.NotificationClicked,async i=>{OneSignal.emitter.numberOfListeners(OneSignal.EVENTS.NOTIFICATION_CLICKED)===0?(a.debug("notification.clicked event received, but no event listeners; storing event in IndexedDb for later retrieval."),await u.putNotificationClickedEventPendingUrlOpening(i)):await Y.triggerNotificationClick(i)}),e.on(Re.NotificationDismissed,async i=>{await O.trigger(OneSignal.EVENTS.NOTIFICATION_DISMISSED,i)});const t=V.isSafari();e.on(Re.AreYouVisible,async i=>{if(t){const n={timestamp:i.timestamp,focused:document.hasFocus()};await e.directPostMessageToSW(Re.AreYouVisibleResponse,n)}})}async installWorker(){if(!await this.shouldInstallWorker())return this.getOneSignalRegistration();a.info("Installing worker..."),await this.getActiveState()===Be.ThirdParty&&a.info("[Service Worker Installation] 3rd party service worker detected.");const t=Oe.getServiceWorkerHref(this.config,this.context.appConfig.appId,re),i=`${V.getBaseUrl()}${this.config.registrationOptions.scope}`;a.info(`[Service Worker Installation] Installing service worker ${t} ${i}.`);let n;try{n=await navigator.serviceWorker.register(t,{scope:i,type:void 0})}catch(s){a.error(`[Service Worker Installation] Installing service worker failed ${s}`),n=await this.fallbackToUserModelBetaWorker()}return a.debug("[Service Worker Installation] Service worker installed. Waiting for activation"),await At.waitUntilActive(n),a.debug("[Service Worker Installation] Service worker active"),await this.establishServiceWorkerChannel(),n}async fallbackToUserModelBetaWorker(){const e="OneSignalSDK.sw.js",t={workerPath:new st(`/${e}`),registrationOptions:this.config.registrationOptions},i=Oe.getServiceWorkerHref(t,this.context.appConfig.appId,re),n=`${V.getBaseUrl()}${this.config.registrationOptions.scope}`;a.info(`[Service Worker Installation] Attempting to install v16 Beta Worker ${i} ${n}.`);try{const s=await navigator.serviceWorker.register(i,{scope:n}),r=`
        [Service Worker Installation] Successfully installed v16 Beta Worker.
        Deprecation warning: support for the v16 beta worker name of ${e}
        will be removed May 5 2024. We have decided to keep the v15 name.
        To avoid breaking changes for your users, please host both worker files:
        OneSignalSDK.sw.js & OneSignalSDKWorker.js.
      `;return a.error(r),s}catch(s){const r=await fetch(i);throw r.status===403||r.status===404?new ni(r.status,r.statusText):s}}}class Mt extends M{constructor(){super("This code is not implemented yet."),Object.setPrototypeOf(this,Mt.prototype)}}const Fe={Blocked:0,Dismissed:1,Default:2};class Ge extends M{reason;constructor(e){let t;switch(e){case Fe.Dismissed:t="The user dismissed the permission prompt.";break;case Fe.Blocked:t="Notification permissions are blocked.";break;case Fe.Default:t="Notification permissions have not been granted yet.";break}super(t),this.reason=e,Object.setPrototypeOf(this,Ge.prototype)}}const si={InvalidSafariSetup:0,Blocked:1,Dismissed:2};class xi extends M{constructor(e){let t;switch(e){case si.InvalidSafariSetup:t="The Safari site URL, icon size, or push certificate is invalid, or Safari is in a private session.";break;case si.Blocked:t="Notification permissions are blocked.";break;case si.Dismissed:t="The notification permission prompt was dismissed.";break}super(t),Object.setPrototypeOf(this,xi.prototype)}}const ue={Default:"default",Granted:"granted",Denied:"denied"},hn={DestroySubscription:0,MarkUnsubscribed:1},lo="99999999-9999-9999-9999-999999999999",fn=async o=>{await ve.switchingUsersPromise;let e=await OneSignal.coreDirector.getPushSubscriptionModel();if(!e)return e=OneSignal.coreDirector.generatePushSubscriptionModel(o),kt.createUserOnServer();if(Ee.isLocalId(e.id))return kt.createUserOnServer();const t=new pn(o).serialize();for(const i in t){const n=i;e.setProperty(n,t[n])}};class Ve{context;config;safariPermissionPromptFailed=!1;constructor(e,t){this.context=e,this.config=t}async isPushNotificationsEnabled(){const e=await this.getSubscriptionState();return e.subscribed&&!e.optedOut}async isOptedIn(){const e=await this.getSubscriptionState();return await OneSignal.context.permissionManager.getPermissionStatus()==="granted"&&!e.optedOut}async isOptedOut(e){I("isOptedOut",e);const{optedOut:t}=await u.getSubscription();return ps(e,t),t}async subscribe(e){let t;{if(await OneSignal.context.permissionManager.getPermissionStatus()===ue.Denied)throw new Ge(Fe.Blocked);if(Xe){t=await this.subscribeSafari(),await fn(t),a.info("Installing SW on Safari");try{await this.context.serviceWorkerManager.installWorker(),a.info("SW on Safari successfully installed")}catch{a.error("SW on Safari failed to install.")}}else t=await this.subscribeFcmFromPage(e),await fn(t)}return t}async updateNotificationTypes(){const e=await this.getNotificationTypes();await this.updatePushSubscriptionNotificationTypes(e)}async getNotificationTypes(){const{optedOut:e}=await u.getSubscription();return e?J.UserOptedOut:await OneSignal.context.permissionManager.getPermissionStatus()==="granted"?J.Subscribed:J.NoNativePermission}async updatePushSubscriptionNotificationTypes(e){const t=await OneSignal.coreDirector.getPushSubscriptionModel();if(!t){a.info("No Push Subscription yet to update notification_types.");return}t.notification_types=e,t.enabled=e===J.Subscribed}async registerSubscription(e,t){e&&(e=nt.deserialize(e)),await this.isAlreadyRegisteredWithOneSignal()?await this.context.updateManager.sendPushDeviceRecordUpdate():this.context.sessionManager.upsertSession(De.UserCreate);const i=await u.getSubscription();return i.deviceId=lo,i.optedOut=!1,e?Xe?i.subscriptionToken=e.safariDeviceToken:i.subscriptionToken=e.w3cEndpoint?e.w3cEndpoint.toString():null:i.subscriptionToken=null,await u.setSubscription(i),O.trigger(OneSignal.EVENTS.REGISTERED),typeof OneSignal<"u"&&(OneSignal._sessionInitAlreadyRunning=!1),i}static async requestPresubscribeNotificationPermission(){return await Ve.requestNotificationPermission()}async unsubscribe(e){throw e===hn.DestroySubscription?new Mt:e===hn.MarkUnsubscribed?new Mt:new Mt}static async requestNotificationPermission(){return await window.Notification.requestPermission()}async isAlreadyRegisteredWithOneSignal(){const{deviceId:e}=await u.getSubscription();return!!e}async subscribeSafariPromptPermission(){const e=t=>new Promise(i=>{window.safari?.pushNotification?.requestPermission(t,this.config.safariWebId,{app_id:this.config.appId},n=>{n&&n.deviceToken?i(n.deviceToken.toLowerCase()):i(null)})});return this.safariPermissionPromptFailed?e(`${It({legacy:!0}).toString()}safari`):e(`${It({legacy:!0}).toString()}safari/apps/${this.config.appId}`)}async subscribeSafari(){const e=new nt;if(!this.config.safariWebId)throw new he(Q.MissingSafariWebId);const{deviceToken:t}=window.safari?.pushNotification?.permission(this.config.safariWebId)||{};if(t)return e.setFromSafariSubscription(t.toLowerCase()),e;O.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await this.subscribeSafariPromptPermission();if(Pe.triggerNotificationPermissionChanged(),i)e.setFromSafariSubscription(i);else throw this.safariPermissionPromptFailed=!0,new xi(si.InvalidSafariSetup);return e}async subscribeFcmFromPage(e){if(Notification.permission===ue.Default){await O.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await Ve.requestPresubscribeNotificationPermission(),n=i===ue.Default;switch(await Pe.triggerNotificationPermissionChanged(n),i){case ue.Default:throw a.debug("Exiting subscription and not registering worker because the permission was dismissed."),OneSignal._sessionInitAlreadyRunning=!1,new Ge(Fe.Dismissed);case ue.Denied:throw a.debug("Exiting subscription and not registering worker because the permission was blocked."),OneSignal._sessionInitAlreadyRunning=!1,new Ge(Fe.Blocked)}}let t;try{t=await this.context.serviceWorkerManager.installWorker()}catch(i){throw i instanceof ni&&(i.status===403?await this.context.subscriptionManager.registerFailedSubscription(J.ServiceWorkerStatus403,this.context):i.status===404&&await this.context.subscriptionManager.registerFailedSubscription(J.ServiceWorkerStatus404,this.context)),i}if(!t)throw new Error("OneSignal service worker not found!");return a.debug("[Subscription Manager] Service worker is ready to continue subscribing."),await this.subscribeWithVapidKey(t.pushManager,e)}async subscribeFcmFromWorker(e){const t=self.registration;if(!t.active&&P().name!=="firefox")throw new qe(Ie.ServiceWorkerNotActivated);const i=await t.pushManager.permissionState({userVisibleOnly:!0});if(i==="denied")throw new Ge(Fe.Blocked);if(i==="prompt")throw new Ge(Fe.Default);return await this.subscribeWithVapidKey(t.pushManager,e)}getVapidKeyForBrowser(){let e;if(P().name==="firefox"?e=this.config.onesignalVapidPublicKey:e=this.config.vapidPublicKey,e)return Un(e).buffer}async subscribeWithVapidKey(e,t){const i=await e.getSubscription();switch(t){case ei.ResubscribeExisting:if(!i)break;i.options?a.debug("[Subscription Manager] An existing push subscription exists and it's options is not null."):(a.debug("[Subscription Manager] An existing push subscription exists and options is null. Unsubscribing from push first now."),await Ve.doPushUnsubscribe(i));break;case ei.SubscribeNew:i&&await Ve.doPushUnsubscribe(i);break}const[n,s]=await Ve.doPushSubscribe(e,this.getVapidKeyForBrowser());return await Ve.updateSubscriptionTime(s,n.expirationTime),nt.setFromW3cSubscription(n)}static async updateSubscriptionTime(e,t){const i=await u.getSubscription();e&&(i.createdAt=new Date().getTime()),i.expirationTime=t,await u.setSubscription(i)}static async doPushUnsubscribe(e){a.debug("[Subscription Manager] Unsubscribing existing push subscription.");const t=await e.unsubscribe();return a.debug(`[Subscription Manager] Unsubscribing existing push subscription result: ${t}`),t}static async doPushSubscribe(e,t){if(!t)throw new Error("Missing required 'applicationServerKey' to subscribe for push notifications!");const i={userVisibleOnly:!0,applicationServerKey:t};a.debug("[Subscription Manager] Subscribing to web push with these options:",i);try{const n=await e.getSubscription();return[await e.subscribe(i),!n]}catch(n){if(n instanceof qe){a.warn("[Subscription Manager] Couldn't re-subscribe due to applicationServerKey changing, unsubscribe and attempting to subscribe with new key.",n);const s=await e.getSubscription();return s&&await Ve.doPushUnsubscribe(s),[await e.subscribe(i),!0]}else throw n}}async isSubscriptionExpiring(){if(await this.context.serviceWorkerManager.getActiveState()!==Be.OneSignalWorker)return!1;const t=await this.context.serviceWorkerManager.getOneSignalRegistration();if(!t||!t.pushManager)return!1;const i=await t.pushManager.getSubscription();if(!i||!i.expirationTime)return!1;let{createdAt:n}=await u.getSubscription();n||(n=new Date().getTime()+31536e6);const s=n+(i.expirationTime-n)/2;return!!i.expirationTime&&(new Date().getTime()>=i.expirationTime||new Date().getTime()>=s)}async getSubscriptionState(){return this.getSubscriptionStateFromBrowserContext()}async getSubscriptionStateFromBrowserContext(){const{optedOut:e,subscriptionToken:t}=await u.getSubscription(),i=await OneSignal.coreDirector.getPushSubscriptionModel(),n=tt(i);if(Xe){const c=window.safari?.pushNotification?.permission(this.config.safariWebId);return{subscribed:!!(n&&t&&c?.permission==="granted"&&c?.deviceToken),optedOut:!!e}}const s=await this.context.serviceWorkerManager.getOneSignalRegistration(),r=await this.context.permissionManager.getNotificationPermission(this.context.appConfig.safariWebId);return s?{subscribed:!!(n&&t&&r===ue.Granted),optedOut:!!e}:{subscribed:!1,optedOut:!!e}}async registerFailedSubscription(e,t){t.pageViewManager.isFirstPageView()&&(t.subscriptionManager.registerSubscription(new nt,e),t.pageViewManager.incrementPageViewCount())}}class mn{static getServiceWorkerManager(e){const t=e.appConfig,i={workerPath:new st("OneSignalSDKWorker.js"),registrationOptions:{scope:"/"}};return t.userConfig&&(t.userConfig.path&&(i.workerPath=new st(`${t.userConfig.path}${t.userConfig.serviceWorkerPath}`)),t.userConfig.serviceWorkerParam&&(i.registrationOptions=t.userConfig.serviceWorkerParam)),new Ai(e,i)}static getSubscriptionManager(e){const t=e.appConfig,i={safariWebId:t.safariWebId,appId:t.appId,vapidPublicKey:t.vapidPublicKey,onesignalVapidPublicKey:t.onesignalVapidPublicKey};return new Ve(e,i)}}class oi{static SESSION_STORAGE_KEY_NAME="onesignal-pageview-count";incrementedPageViewCount=!1;getPageViewCount(){try{const e=sessionStorage.getItem(oi.SESSION_STORAGE_KEY_NAME),t=e?parseInt(e):0;return isNaN(t)?0:t}catch{return 0}}setPageViewCount(e){try{sessionStorage.setItem(oi.SESSION_STORAGE_KEY_NAME,e.toString())}catch{}}incrementPageViewCount(){if(this.incrementedPageViewCount)return;const e=this.getPageViewCount()+1,t=this.getLocalPageViewCount()+1;this.setPageViewCount(e),this.setLocalPageViewCount(t),this.incrementedPageViewCount=!0,a.debug(`Incremented page view count: newCountSingleTab: ${e},
      newCountAccrossTabs: ${t}.`)}simulatePageNavigationOrRefresh(){this.incrementedPageViewCount=!1}isFirstPageView(){return this.getPageViewCount()===1}getLocalPageViewCount(){return ft.getLocalPageViewCount()}setLocalPageViewCount(e){ft.setLocalPageViewCount(e)}}class Mi{static get STORED_PERMISSION_KEY(){return"storedNotificationPermission"}async getPermissionStatus(){if(!OneSignal.context)throw new M("OneSignal.context is undefined. Make sure to call OneSignal.init() before calling getPermissionStatus().");return await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)}async getNotificationPermission(e){return Xe?Mi.getLegacySafariNotificationPermission(e):this.getW3cNotificationPermission()}static getLegacySafariNotificationPermission(e){if(e)return window.safari?.pushNotification?.permission(e).permission;throw new _("safariWebId",N.Empty)}getW3cNotificationPermission(){return Notification.permission}}class uo{context;onSessionSent;constructor(e){this.context=e,this.onSessionSent=e.pageViewManager.getPageViewCount()>1}async sendPushDeviceRecordUpdate(){if(!me.singletonInstance?.onesignalId){a.debug("Not sending the update because user is not registered with OneSignal (no onesignal_id)");return}this.onSessionSent||await this.sendOnSessionUpdate()}async sendOnSessionUpdate(){if(this.onSessionSent||!this.context.pageViewManager.isFirstPageView())return;if(!await this.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()){a.debug("Not sending the on session because user is not registered with OneSignal (no device id)");return}if(!((await OneSignal.coreDirector.getPushSubscriptionModel())?.notification_types!==J.Subscribed&&OneSignal.config?.enableOnSession!==!0))try{this.context.sessionManager.upsertSession(De.UserNewSession),this.onSessionSent=!0}catch(i){i instanceof Error&&a.error(`Failed to update user session. Error "${i.message}" ${i.stack}`)}}async sendOutcomeDirect(e,t,i,n){I("sendOutcomeDirect");const s=await OneSignal.coreDirector.getPushSubscriptionModel();if(s&&tt(s)){const r={id:i,app_id:e,notification_ids:t,direct:!0,subscription:{id:s.id,type:rt()}};n!==void 0&&(r.weight=n),await Ht.sendOutcome(r);return}a.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeInfluenced(e,t,i,n){I("sendOutcomeInfluenced");const s=await OneSignal.coreDirector.getPushSubscriptionModel();if(s&&tt(s)){const r={id:i,app_id:e,notification_ids:t,direct:!1,subscription:{id:s.id,type:rt()}};n!==void 0&&(r.weight=n),await Ht.sendOutcome(r);return}a.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeUnattributed(e,t,i){I("sendOutcomeUnattributed");const n=await OneSignal.coreDirector.getPushSubscriptionModel();if(n&&tt(n)){const s={id:t,app_id:e,subscription:{id:n.id,type:rt()}};i!==void 0&&(s.weight=i),await Ht.sendOutcome(s);return}a.warn("Send outcome aborted because pushSubscriptionModel is not available.")}}class po{context;onSessionSent=!1;constructor(e){this.context=e}async notifySWToUpsertSession(e,t,i){const n={onesignalId:e,subscriptionId:t,appId:this.context.appConfig.appId,sessionThreshold:this.context.appConfig.sessionThreshold||0,enableSessionDuration:!!this.context.appConfig.enableSessionDuration,sessionOrigin:i,isSafari:V.isSafari(),outcomesConfig:this.context.appConfig.userConfig.outcomes};this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers?(a.debug("Notify SW to upsert session"),await this.context.workerMessenger.unicast(Re.SessionUpsert,n)):a.debug("Notify upsert: do nothing")}async notifySWToDeactivateSession(e,t,i){const n={appId:this.context.appConfig.appId,subscriptionId:t,onesignalId:e,sessionThreshold:this.context.appConfig.sessionThreshold,enableSessionDuration:this.context.appConfig.enableSessionDuration,sessionOrigin:i,isSafari:V.isSafari(),outcomesConfig:this.context.appConfig.userConfig.outcomes};this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers?(a.debug("Notify SW to deactivate session"),await this.context.workerMessenger.unicast(Re.SessionDeactivate,n)):a.debug("Notify deactivate: do nothing")}async _getOneSignalAndSubscriptionIds(){const e=OneSignal.coreDirector.getIdentityModel(),t=await OneSignal.coreDirector.getPushSubscriptionModel();if(!e||!e.onesignalId)throw new M("Abort _getOneSignalAndSubscriptionIds: no identity");if(!t||!tt(t))throw new M("Abort _getOneSignalAndSubscriptionIds: no subscription");const{onesignalId:i}=e,{id:n}=t;return{onesignalId:i,subscriptionId:n}}async handleVisibilityChange(){if(await ve.switchingUsersPromise,!!me.singletonInstance?.onesignalId)try{const e=document.visibilityState,{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();if(e==="visible"){this.setupOnFocusAndOnBlurForSession(),a.debug("handleVisibilityChange","visible",`hasFocus: ${document.hasFocus()}`),document.hasFocus()&&await this.notifySWToUpsertSession(t,i,De.VisibilityVisible);return}if(e==="hidden"){a.debug("handleVisibilityChange","hidden"),OneSignal.cache.focusHandler&&OneSignal.cache.isFocusEventSetup&&(window.removeEventListener("focus",OneSignal.cache.focusHandler,!0),OneSignal.cache.isFocusEventSetup=!1),OneSignal.cache.blurHandler&&OneSignal.cache.isBlurEventSetup&&(window.removeEventListener("blur",OneSignal.cache.blurHandler,!0),OneSignal.cache.isBlurEventSetup=!1),await this.notifySWToDeactivateSession(t,i,De.VisibilityHidden);return}a.warn("Unhandled visibility state happened",e)}catch(e){a.error("Error handling visibility change:",e)}}async handleOnBeforeUnload(){if(await ve.switchingUsersPromise,!!me.singletonInstance?.onesignalId)try{const{onesignalId:e,subscriptionId:t}=await this._getOneSignalAndSubscriptionIds(),i={appId:this.context.appConfig.appId,onesignalId:e,subscriptionId:t,sessionThreshold:this.context.appConfig.sessionThreshold,enableSessionDuration:this.context.appConfig.enableSessionDuration,sessionOrigin:De.BeforeUnload,isSafari:V.isSafari(),outcomesConfig:this.context.appConfig.userConfig.outcomes};a.debug("Notify SW to deactivate session (beforeunload)"),this.context.workerMessenger.directPostMessageToSW(Re.SessionDeactivate,i)}catch(e){a.error("Error handling onbeforeunload:",e)}}async handleOnFocus(e){if(await ve.switchingUsersPromise,a.debug("handleOnFocus",e),!!me.singletonInstance?.onesignalId)try{if(e.target!==window)return;const{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();await this.notifySWToUpsertSession(t,i,De.Focus)}catch(t){a.error("Error handling focus:",t)}}async handleOnBlur(e){if(await ve.switchingUsersPromise,a.debug("handleOnBlur",e),!!me.singletonInstance?.onesignalId)try{if(e.target!==window)return;const{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();await this.notifySWToDeactivateSession(t,i,De.Blur)}catch(t){a.error("Error handling blur:",t)}}async upsertSession(e){if(await ve.switchingUsersPromise,me.singletonInstance?.onesignalId){const{onesignalId:t,subscriptionId:i}=await this._getOneSignalAndSubscriptionIds();await this.notifySWToUpsertSession(t,i,e)}this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers?this.setupSessionEventListeners():(this.onSessionSent=e===De.UserCreate,OneSignal.emitter.emit(OneSignal.EVENTS.SESSION_STARTED))}setupSessionEventListeners(){if(!this.context.environmentInfo?.isBrowserAndSupportsServiceWorkers){a.debug("Not setting session event listeners. No service worker possible.");return}this.setupOnFocusAndOnBlurForSession(),OneSignal.cache.isVisibilityChangeEventSetup||(document.addEventListener("visibilitychange",this.handleVisibilityChange.bind(this),!0),OneSignal.cache.isVisibilityChangeEventSetup=!0),OneSignal.cache.isBeforeUnloadEventSetup||(window.addEventListener("beforeunload",e=>{this.handleOnBeforeUnload(),delete e.returnValue},!0),OneSignal.cache.isBeforeUnloadEventSetup=!0)}setupOnFocusAndOnBlurForSession(){a.debug("setupOnFocusAndOnBlurForSession"),OneSignal.cache.focusHandler||(OneSignal.cache.focusHandler=this.handleOnFocus.bind(this)),OneSignal.cache.isFocusEventSetup||(window.addEventListener("focus",OneSignal.cache.focusHandler,!0),OneSignal.cache.isFocusEventSetup=!0),OneSignal.cache.blurHandler||(OneSignal.cache.blurHandler=this.handleOnBlur.bind(this)),OneSignal.cache.isBlurEventSetup||(window.addEventListener("blur",OneSignal.cache.blurHandler,!0),OneSignal.cache.isBlurEventSetup=!0)}async sendOnSessionUpdateFromPage(){if(this.onSessionSent||!this.context.pageViewManager.isFirstPageView())return;const i=OneSignal.coreDirector.getIdentityModel().onesignalId;if(!i){a.debug("Not sending the on session because user is not registered with OneSignal (no onesignal id)");return}const n=await OneSignal.coreDirector.getPushSubscriptionModel();if(n?.notification_types!==J.Subscribed&&OneSignal.config?.enableOnSession!==!0)return;let s;tt(n)&&(s=n?.id);try{const r=new te(te.ONESIGNAL_ID,i),d={refresh_device_metadata:!0,deltas:{session_count:1}},c=F.getAppId();H.enforceAppId(c),H.enforceAlias(r);try{await ae.updateUser({appId:c,subscriptionId:s},r,d),this.onSessionSent=!0}catch(l){a.debug("Error updating user session:",l)}}catch(r){r instanceof Error&&a.error(`Failed to update user session. Error "${r.message}" ${r.stack}`)}}}const se={Push:"push",NonPush:"nonPush"},Sn={PromptDismissCount:"promptDismissCount",NonPushPromptsDismissCount:"nonPushPromptsDismissCount"},ri={OneSignalNotificationPrompt:"onesignal-notification-prompt",OneSignalNonPushPrompt:"onesignal-non-push-prompt"};class ze{static isLocalStorageSupported(){try{return typeof localStorage>"u"?!1:(localStorage.getItem("test"),!0)}catch{return!1}}static setItem(e,t,i){if(!ze.isLocalStorageSupported())return;const n=typeof i<"u"?i*60*1e3:0,s={value:JSON.stringify(t),timestamp:typeof i<"u"?new Date().getTime()+n:void 0};localStorage.setItem(e,JSON.stringify(s))}static getItem(e){if(!ze.isLocalStorageSupported())return null;const t=localStorage.getItem(e);let i;try{i=JSON.parse(t)}catch{return null}if(i===null)return null;if(i.timestamp&&new Date().getTime()>=i.timestamp)return localStorage.removeItem(e),null;let n=i.value;try{n=JSON.parse(i.value)}catch{return n}return n}static removeItem(e){if(!ze.isLocalStorageSupported())return null;localStorage.removeItem(e)}}const go={[se.Push]:Sn.PromptDismissCount,[se.NonPush]:Sn.NonPushPromptsDismissCount},ho={[se.Push]:ri.OneSignalNotificationPrompt,[se.NonPush]:ri.OneSignalNonPushPrompt};class Ye{static async markPromptDismissedWithType(e){const t=go[e],i=ho[e];let n=await u.get("Options",t);n||(n=0),n+=1;let s=3;n==2?s=7:n>2&&(s=30),a.debug(`(${Lt} environment) OneSignal: User dismissed the ${e} notification prompt; reprompt after ${s} days.`),await u.put("Options",{key:t,value:n});const r=s*24*60;return ze.setItem(i,"dismissed",r)}static wasPromptOfTypeDismissed(e){switch(e){case se.Push:return ze.getItem(ri.OneSignalNotificationPrompt)==="dismissed";case se.NonPush:return ze.getItem(ri.OneSignalNonPushPrompt)==="dismissed"}return!1}}class Te{selector;showClass;hideClass;state;targetTransitionEvents;nestedContentSelector;transitionCheckTimeout;constructor(e,t,i,n="shown",s=["opacity","transform"],r,d=500){this.selector=e,this.showClass=t,this.hideClass=i,this.state=n,this.targetTransitionEvents=s,this.nestedContentSelector=r,this.transitionCheckTimeout=d}show(){return this.hidden?new Promise(e=>{this.state="showing",O.trigger(Te.EVENTS.SHOWING,this);const t=this.element;if(t?(this.hideClass&&de(t,this.hideClass),this.showClass&&m(t,this.showClass)):a.error(`(show) could not find animated element with selector ${this.selector}`),this.targetTransitionEvents.length==0)return e(this);{const i=setTimeout(()=>{a.debug(`Element did not completely show (state: ${this.state}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,s)=>{if(n.target===this.element&&je(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),s(),this.state="shown",O.trigger(Te.EVENTS.SHOWN,this),e(this)},!0)}}):Promise.resolve(this)}hide(){return this.shown?new Promise(e=>{this.state="hiding",O.trigger(Te.EVENTS.HIDING,this);const t=this.element;if(t?(this.showClass&&de(t,this.showClass),this.hideClass&&m(t,this.hideClass)):a.error(`(hide) could not find animated element with selector ${this.selector}`),this.targetTransitionEvents.length==0)return e(this);ye(this.element,"transitionend",(i,n)=>{const s=setTimeout(()=>{a.debug(`Element did not completely hide (state: ${this.state}).`)},this.transitionCheckTimeout);if(i.target===this.element&&je(this.targetTransitionEvents,i.propertyName))return clearTimeout(s),n(),this.state="hidden",O.trigger(Te.EVENTS.HIDDEN,this),e(this)},!0)}):Promise.resolve(this)}waitUntilShown(){return this.state==="shown"?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(Te.EVENTS.SHOWN,t=>{if(t===this)return e(this)})})}waitUntilHidden(){return this.state==="hidden"?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(Te.EVENTS.HIDDEN,t=>{if(t===this)return e(this)})})}static get EVENTS(){return{SHOWING:"animatedElementShowing",SHOWN:"animatedElementShown",HIDING:"animatedElementHiding",HIDDEN:"animatedElementHidden"}}get content(){if(!this.element)return"";if(this.nestedContentSelector){const e=this.element.querySelector(this.nestedContentSelector);return e?e.innerHTML:""}else return this.element.innerHTML}set content(e){if(this.element)if(this.nestedContentSelector){const t=this.element.querySelector(this.nestedContentSelector);t&&(t.textContent=e)}else this.element.textContent=e}get element(){return document.querySelector(this.selector)}get showing(){return this.state==="showing"}get shown(){return this.state==="shown"}get hiding(){return this.state==="hiding"}get hidden(){return this.state==="hidden"}}class Se extends Te{activeClass;inactiveClass;activeState;nestedContentSelector;constructor(e,t,i,n,s,r="shown",d="active",c=["opacity","transform"],l){super(e,t,i,r,c),this.activeClass=n,this.inactiveClass=s,this.activeState=d,this.nestedContentSelector=l}activate(){return!this.inactive||!this.shown?Promise.resolve(this):new Promise(e=>{this.activeState="activating",O.trigger(Se.EVENTS.ACTIVATING,this);const t=this.element;if(t?(this.inactiveClass&&de(t,this.inactiveClass),this.activeClass&&m(t,this.activeClass)):a.error("Could not find active animated element"),this.shown){if(this.targetTransitionEvents.length==0)return e(this);{const i=setTimeout(()=>{a.debug(`Element did not completely activate (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,s)=>{if(n.target===this.element&&je(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),s(),this.activeState="active",O.trigger(Se.EVENTS.ACTIVE,this),e(this)},!0)}}else return a.debug("Ending activate() transition (alternative)."),this.activeState="active",O.trigger(Se.EVENTS.ACTIVE,this),e(this)})}inactivate(){return this.active?new Promise(e=>{this.activeState="inactivating",O.trigger(Se.EVENTS.INACTIVATING,this);const t=this.element;if(t?(this.activeClass&&de(t,this.activeClass),this.inactiveClass&&m(t,this.inactiveClass)):a.error("Could not find active animated element"),this.shown){if(this.targetTransitionEvents.length==0)return e(this);{const i=setTimeout(()=>{a.debug(`Element did not completely inactivate (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,s)=>{if(n.target===this.element&&je(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),s(),this.activeState="inactive",O.trigger(Se.EVENTS.INACTIVE,this),e(this)},!0)}}else return this.activeState="inactive",O.trigger(Se.EVENTS.INACTIVE,this),e(this)}):Promise.resolve(this)}waitUntilActive(){return this.active?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(Se.EVENTS.ACTIVE,t=>{if(t===this)return e(this)})})}waitUntilInactive(){return this.inactive?Promise.resolve(this):new Promise(e=>{OneSignal.emitter.once(Se.EVENTS.INACTIVE,t=>{if(t===this)return e(this)})})}static get EVENTS(){return{...Te.EVENTS,ACTIVATING:"activeAnimatedElementActivating",ACTIVE:"activeAnimatedElementActive",INACTIVATING:"activeAnimatedElementInactivating",INACTIVE:"activeAnimatedElementInactive"}}get activating(){return this.activeState==="activating"}get active(){return this.activeState==="active"}get inactivating(){return this.activeState==="inactivating"}get inactive(){return this.activeState==="inactive"}}class fo extends Se{constructor(){super(".onesignal-bell-launcher-badge","onesignal-bell-launcher-badge-opened",void 0,"onesignal-bell-launcher-badge-active",void 0,"hidden")}increment(){if(!isNaN(this.content)){let e=+this.content;e+=1,this.content=e.toString()}}show(){const e=super.show();return OneSignal.notifyButton?.setCustomColorsIfSpecified(),e}decrement(){if(!isNaN(this.content)){let e=+this.content;e-=1,e>0?this.content=e.toString():this.content=""}}}class pe extends Te{bell;contentType;queued;constructor(e){super(".onesignal-bell-launcher-message","onesignal-bell-launcher-message-opened",void 0,"hidden",["opacity","transform"],".onesignal-bell-launcher-message-body"),this.bell=e,this.contentType="",this.queued=[]}static get TIMEOUT(){return 2500}static get TYPES(){return{TIP:"tip",MESSAGE:"message",QUEUED:"queued"}}display(e,t,i=0){return a.debug(`Calling display(${e}, ${t}, ${i}).`),(this.shown?this.hide():dt()).then(()=>{this.content=Tt.decodeHtmlEntities(t),this.contentType=e}).then(()=>this.show()).then(()=>lt(i)).then(()=>this.hide()).then(()=>{this.content=this.getTipForState(),this.contentType="tip"})}getTipForState(){return this.bell.state===T.STATES.UNSUBSCRIBED?this.bell.options.text["tip.state.unsubscribed"]:this.bell.state===T.STATES.SUBSCRIBED?this.bell.options.text["tip.state.subscribed"]:this.bell.state===T.STATES.BLOCKED?this.bell.options.text["tip.state.blocked"]:""}enqueue(e){return this.queued.push(Tt.decodeHtmlEntities(e)),new Promise(t=>{this.bell.badge.shown?this.bell.badge.hide().then(()=>this.bell.badge.increment()).then(()=>this.bell.badge.show()).then(t):(this.bell.badge.increment(),this.bell.initialized?this.bell.badge.show().then(t):t())})}dequeue(e){const t=this.queued.pop(e);return new Promise(i=>{this.bell.badge.shown?this.bell.badge.hide().then(()=>this.bell.badge.decrement()).then(n=>n>0?this.bell.badge.show():Promise.resolve(this)).then(i(t)):(this.bell.badge.decrement(),i(t))})}}class mo extends Se{events;bell;constructor(e){super(".onesignal-bell-launcher-button",void 0,void 0,"onesignal-bell-launcher-button-active",void 0,"shown",""),this.bell=e,this.events={mouse:"bell.launcher.button.mouse"};const t=this.element;t&&(t.addEventListener("touchstart",()=>{this.onHovering(),this.onTap()},{passive:!0}),t.addEventListener("mouseenter",()=>{this.onHovering()}),t.addEventListener("mouseleave",()=>{this.onHovered()}),t.addEventListener("touchmove",()=>{this.onHovered()},{passive:!0}),t.addEventListener("mousedown",()=>{this.onTap()}),t.addEventListener("mouseup",()=>{this.onEndTap()}),t.addEventListener("click",()=>{this.onHovered(),this.onClick()}))}onHovering(){(W.isEmpty(this.events.mouse)||W.getLast(this.events.mouse)==="out")&&O.trigger(T.EVENTS.HOVERING),W.put(this.events.mouse,"over")}onHovered(){W.put(this.events.mouse,"out"),O.trigger(T.EVENTS.HOVERED)}onTap(){this.pulse(),this.activate(),this.bell.badge.activate()}onEndTap(){this.inactivate(),this.bell.badge.inactivate()}onClick(){if(O.trigger(T.EVENTS.BELL_CLICK),O.trigger(T.EVENTS.LAUNCHER_CLICK),this.bell.message.shown&&this.bell.message.contentType==pe.TYPES.MESSAGE)return;const e=W.getLast("subscription.optedOut");return this.bell.unsubscribed?e?this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}):($.registerForPushNotifications(),this.bell._ignoreSubscriptionState=!0,OneSignal.emitter.once(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,()=>{this.bell.message.display(pe.TYPES.MESSAGE,this.bell.options.text["message.action.subscribed"],pe.TIMEOUT).then(()=>{this.bell._ignoreSubscriptionState=!1,this.bell.launcher.inactivate()})})):this.bell.subscribed?this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}):this.bell.blocked&&this.bell.launcher.activateIfInactive().then(()=>{this.bell.showDialogProcedure()}),this.bell.message.hide()}pulse(){He(".pulse-ring"),this.element&&ne(this.element,"beforeend",'<div class="pulse-ring"></div>'),this.bell.setCustomColorsIfSpecified()}}const So=new URL("https://media.onesignal.com/web-sdk");class bo extends Te{bell;subscribeButtonId;unsubscribeButtonId;notificationIcons;constructor(e){super(".onesignal-bell-launcher-dialog","onesignal-bell-launcher-dialog-opened",void 0,"hidden",["opacity","transform"],".onesignal-bell-launcher-dialog-body"),this.bell=e,this.subscribeButtonId="#onesignal-bell-container .onesignal-bell-launcher #subscribe-button",this.unsubscribeButtonId="#onesignal-bell-container .onesignal-bell-launcher #unsubscribe-button",this.notificationIcons=null}show(){return this.updateBellLauncherDialogBody().then(()=>super.show())}get subscribeButtonSelectorId(){return"subscribe-button"}get unsubscribeButtonSelectorId(){return"unsubscribe-button"}get subscribeButton(){return this.element?this.element.querySelector("#"+this.subscribeButtonSelectorId):null}get unsubscribeButton(){return this.element?this.element.querySelector("#"+this.unsubscribeButtonSelectorId):null}updateBellLauncherDialogBody(){return OneSignal.context.subscriptionManager.isPushNotificationsEnabled().then(e=>{this.nestedContentSelector&&hs(this.nestedContentSelector);let t="Nothing to show.",i="";if(this.bell.options.showCredit&&(i='<div class="divider"></div><div class="kickback">Powered by <a href="https://onesignal.com" class="kickback" target="_blank">OneSignal</a></div>'),this.bell.state===T.STATES.SUBSCRIBED&&e===!0||this.bell.state===T.STATES.UNSUBSCRIBED&&e===!1){let n="";const s=Ei(this.notificationIcons);s!="default-icon"?n=`<div class="push-notification-icon"><img src="${s}"></div>`:n='<div class="push-notification-icon push-notification-icon-default"></div>';let r="";this.bell.state!==T.STATES.SUBSCRIBED?r=`<button type="button" class="action" id="${this.subscribeButtonSelectorId}">${this.bell.options.text["dialog.main.button.subscribe"]}</button>`:r=`<button type="button" class="action" id="${this.unsubscribeButtonSelectorId}">${this.bell.options.text["dialog.main.button.unsubscribe"]}</button>`,t=`<h1>${this.bell.options.text["dialog.main.title"]}</h1><div class="divider"></div><div class="push-notification">${n}<div class="push-notification-text-container"><div class="push-notification-text push-notification-text-short"></div><div class="push-notification-text"></div><div class="push-notification-text push-notification-text-medium"></div><div class="push-notification-text"></div><div class="push-notification-text push-notification-text-medium"></div></div></div><div class="action-container">${r}</div>${i}`}else if(this.bell.state===T.STATES.BLOCKED){let n=null;P().name==="chrome"?!P().mobile&&!P().tablet&&(n="/bell/chrome-unblock.jpg"):P().name==="firefox"?n="/bell/firefox-unblock.jpg":P().name=="safari"?n="/bell/safari-unblock.jpg":P().name==="msedge"&&(n="/bell/edge-unblock.png");let s="";n&&(n=So+n,s=`<a href="${n}" target="_blank"><img src="${n}"></a></div>`),(P().mobile||P().tablet)&&P().name==="chrome"&&(s="<ol><li>Access <strong>Settings</strong> by tapping the three menu dots <strong>⋮</strong></li><li>Click <strong>Site settings</strong> under Advanced.</li><li>Click <strong>Notifications</strong>.</li><li>Find and click this entry for this website.</li><li>Click <strong>Notifications</strong> and set it to <strong>Allow</strong>.</li></ol>"),t=`<h1>${this.bell.options.text["dialog.blocked.title"]}</h1><div class="divider"></div><div class="instructions"><p>${this.bell.options.text["dialog.blocked.message"]}</p>${s}</div>${i}`}this.nestedContentSelector&&ne(this.nestedContentSelector,"beforeend",t),this.subscribeButton&&this.subscribeButton.addEventListener("click",()=>{OneSignal.__doNotShowWelcomeNotification=!1,O.trigger(T.EVENTS.SUBSCRIBE_CLICK)}),this.unsubscribeButton&&this.unsubscribeButton.addEventListener("click",()=>O.trigger(T.EVENTS.UNSUBSCRIBE_CLICK)),this.bell.setCustomColorsIfSpecified()})}}class wo extends Se{bell;wasInactive;constructor(e){super(".onesignal-bell-launcher","onesignal-bell-launcher-active",void 0,void 0,"onesignal-bell-launcher-inactive","hidden","active"),this.bell=e,this.wasInactive=!1}async resize(e){if(!this.element)throw new qe(Ie.MissingDomElement);if(e==="small"&&yi(this.element,"onesignal-bell-launcher-sm")||e==="medium"&&yi(this.element,"onesignal-bell-launcher-md")||e==="large"&&yi(this.element,"onesignal-bell-launcher-lg"))return Promise.resolve(this);if(de(this.element,"onesignal-bell-launcher-sm"),de(this.element,"onesignal-bell-launcher-md"),de(this.element,"onesignal-bell-launcher-lg"),e==="small")m(this.element,"onesignal-bell-launcher-sm");else if(e==="medium")m(this.element,"onesignal-bell-launcher-md");else if(e==="large")m(this.element,"onesignal-bell-launcher-lg");else throw new Error("Invalid OneSignal bell size "+e);return this.shown?await new Promise(t=>{if(this.targetTransitionEvents.length==0)return t(this);{const i=setTimeout(()=>{a.debug(`Launcher did not completely resize (state: ${this.state}, activeState: ${this.activeState}).`)},this.transitionCheckTimeout);ye(this.element,"transitionend",(n,s)=>{if(n.target===this.element&&je(this.targetTransitionEvents,n.propertyName))return clearTimeout(i),s(),t(this)},!0)}}):this}activateIfInactive(){return this.inactive?(this.wasInactive=!0,this.activate()):dt()}inactivateIfWasInactive(){return this.wasInactive?(this.wasInactive=!1,this.inactivate()):dt()}clearIfWasInactive(){this.wasInactive=!1}inactivate(){return this.bell.message.hide().then(()=>this.bell.badge.content.length>0?this.bell.badge.hide().then(()=>Promise.all([super.inactivate(),this.resize("small")])).then(()=>this.bell.badge.show()):Promise.all([super.inactivate(),this.resize("small")]))}activate(){return this.bell.badge.content.length>0?this.bell.badge.hide().then(()=>Promise.all([super.activate(),this.resize(this.bell.options.size)])):Promise.all([super.activate(),this.resize(this.bell.options.size)])}}const yo='<svg class="onesignal-bell-svg" xmlns="http://www.w3.org/2000/svg" width="99.7" height="99.7" viewBox="0 0 99.7 99.7"><circle class="background" cx="49.9" cy="49.9" r="49.9"/><path class="foreground" d="M50.1 66.2H27.7s-2-.2-2-2.1c0-1.9 1.7-2 1.7-2s6.7-3.2 6.7-5.5S33 52.7 33 43.3s6-16.6 13.2-16.6c0 0 1-2.4 3.9-2.4 2.8 0 3.8 2.4 3.8 2.4 7.2 0 13.2 7.2 13.2 16.6s-1 11-1 13.3c0 2.3 6.7 5.5 6.7 5.5s1.7.1 1.7 2c0 1.8-2.1 2.1-2.1 2.1H50.1zm-7.2 2.3h14.5s-1 6.3-7.2 6.3-7.3-6.3-7.3-6.3z"/><ellipse class="stroke" cx="49.9" cy="49.9" rx="37.4" ry="36.9"/></svg>';class T{options;state=T.STATES.UNINITIALIZED;_ignoreSubscriptionState=!1;hovering=!1;initialized=!1;_launcher;_button;_badge;_message;_dialog;DEFAULT_SIZE="medium";DEFAULT_POSITION="bottom-right";DEFAULT_THEME="default";static get EVENTS(){return{STATE_CHANGED:"notifyButtonStateChange",LAUNCHER_CLICK:"notifyButtonLauncherClick",BELL_CLICK:"notifyButtonButtonClick",SUBSCRIBE_CLICK:"notifyButtonSubscribeClick",UNSUBSCRIBE_CLICK:"notifyButtonUnsubscribeClick",HOVERING:"notifyButtonHovering",HOVERED:"notifyButtonHover"}}static get STATES(){return{UNINITIALIZED:"uninitialized",SUBSCRIBED:"subscribed",UNSUBSCRIBED:"unsubscribed",BLOCKED:"blocked"}}static get TEXT_SUBS(){return{"prompt.native.grant":{default:"Allow",chrome:"Allow",firefox:"Always Receive Notifications",safari:"Allow"}}}constructor(e,t){this.options={enable:e.enable||!1,size:e.size||this.DEFAULT_SIZE,position:e.position||this.DEFAULT_POSITION,theme:e.theme||this.DEFAULT_THEME,showLauncherAfter:e.showLauncherAfter||10,showBadgeAfter:e.showBadgeAfter||300,text:this.setDefaultTextOptions(e.text||{}),prenotify:e.prenotify,showCredit:e.showCredit,colors:e.colors,offset:e.offset},t&&(this._launcher=t),this.options.enable&&(this.validateOptions(this.options),this.state=T.STATES.UNINITIALIZED,this._ignoreSubscriptionState=!1,this.installEventHooks(),this.updateState())}showDialogProcedure(){this.dialog.shown||this.dialog.show().then(()=>{ye(document,"click",(e,t)=>{this.dialog.element.contains(e.target)||(t(),this.dialog.shown&&this.dialog.hide().then(()=>{this.launcher.inactivateIfWasInactive()}))},!0)})}validateOptions(e){if(!e.size||!je(["small","medium","large"],e.size))throw new Error(`Invalid size ${e.size} for notify button. Choose among 'small', 'medium', or 'large'.`);if(!e.position||!je(["bottom-left","bottom-right"],e.position))throw new Error(`Invalid position ${e.position} for notify button. Choose either 'bottom-left', or 'bottom-right'.`);if(!e.theme||!je(["default","inverse"],e.theme))throw new Error(`Invalid theme ${e.theme} for notify button. Choose either 'default', or 'inverse'.`);if(!e.showLauncherAfter||e.showLauncherAfter<0)throw new Error(`Invalid delay duration of ${this.options.showLauncherAfter} for showing the notify button. Choose a value above 0.`);if(!e.showBadgeAfter||e.showBadgeAfter<0)throw new Error(`Invalid delay duration of ${this.options.showBadgeAfter} for showing the notify button's badge. Choose a value above 0.`)}setDefaultTextOptions(e){return{"tip.state.unsubscribed":e["tip.state.unsubscribed"]||"Subscribe to notifications","tip.state.subscribed":e["tip.state.subscribed"]||"You're subscribed to notifications","tip.state.blocked":e["tip.state.blocked"]||"You've blocked notifications","message.prenotify":e["message.prenotify"]||"Click to subscribe to notifications","message.action.subscribed":e["message.action.subscribed"]||"Thanks for subscribing!","message.action.resubscribed":e["message.action.resubscribed"]||"You're subscribed to notifications","message.action.subscribing":e["message.action.subscribing"]||"Click <strong>{{prompt.native.grant}}</strong> to receive notifications","message.action.unsubscribed":e["message.action.unsubscribed"]||"You won't receive notifications again","dialog.main.title":e["dialog.main.title"]||"Manage Site Notifications","dialog.main.button.subscribe":e["dialog.main.button.subscribe"]||"SUBSCRIBE","dialog.main.button.unsubscribe":e["dialog.main.button.unsubscribe"]||"UNSUBSCRIBE","dialog.blocked.title":e["dialog.blocked.title"]||"Unblock Notifications","dialog.blocked.message":e["dialog.blocked.message"]||"Follow these instructions to allow notifications:"}}installEventHooks(){v.emitter.on(T.EVENTS.SUBSCRIBE_CLICK,()=>{this.dialog.subscribeButton.disabled=!0,this._ignoreSubscriptionState=!0,v.User.PushSubscription.optIn().then(()=>(this.dialog.subscribeButton.disabled=!1,this.dialog.hide())).then(()=>this.message.display(pe.TYPES.MESSAGE,this.options.text["message.action.resubscribed"],pe.TIMEOUT)).then(()=>(this._ignoreSubscriptionState=!1,this.launcher.clearIfWasInactive(),this.launcher.inactivate())).then(()=>this.updateState()).catch(e=>{throw e})}),v.emitter.on(T.EVENTS.UNSUBSCRIBE_CLICK,()=>{this.dialog.unsubscribeButton.disabled=!0,v.User.PushSubscription.optOut().then(()=>(this.dialog.unsubscribeButton.disabled=!1,this.dialog.hide())).then(()=>(this.launcher.clearIfWasInactive(),this.launcher.activate())).then(()=>this.message.display(pe.TYPES.MESSAGE,this.options.text["message.action.unsubscribed"],pe.TIMEOUT)).then(()=>this.updateState())}),v.emitter.on(T.EVENTS.HOVERING,()=>{if(this.hovering=!0,this.launcher.activateIfInactive(),this.message.shown||this.dialog.shown){this.hovering=!1;return}if(this.message.contentType===pe.TYPES.MESSAGE){this.hovering=!1;return}new Promise(e=>{if(this.message.queued.length>0)return this.message.dequeue().then(t=>{this.message.content=t,this.message.contentType=pe.TYPES.QUEUED,e()});this.message.content=Tt.decodeHtmlEntities(this.message.getTipForState()),this.message.contentType=pe.TYPES.TIP,e()}).then(()=>this.message.show()).then(()=>{this.hovering=!1}).catch(e=>{a.error(e)})}),v.emitter.on(T.EVENTS.HOVERED,()=>{this.message.contentType!==pe.TYPES.MESSAGE&&this.dialog.hidden&&(this.hovering&&(this.hovering=!1,this.message.waitUntilShown().then(()=>lt(pe.TIMEOUT)).then(()=>this.message.hide()).then(()=>{this.launcher.wasInactive&&this.dialog.hidden&&(this.launcher.inactivate(),this.launcher.wasInactive=!1)})),this.message.shown&&this.message.hide().then(()=>{this.launcher.wasInactive&&this.dialog.hidden&&(this.launcher.inactivate(),this.launcher.wasInactive=!1)}))}),v.emitter.on(v.EVENTS.SUBSCRIPTION_CHANGED,async e=>{if(e.current.optedIn&&(this.badge.shown&&this.options.prenotify&&this.badge.hide(),this.dialog.notificationIcons===null)){const n=await F.getNotificationIcons();this.dialog.notificationIcons=n}const t=await v.context.permissionManager.getPermissionStatus();let i;e.current.optedIn?i=T.STATES.SUBSCRIBED:t===ue.Denied?i=T.STATES.BLOCKED:i=T.STATES.UNSUBSCRIBED,this.setState(i,this._ignoreSubscriptionState)}),v.emitter.on(T.EVENTS.STATE_CHANGED,e=>{this.launcher.element&&(e.to===T.STATES.SUBSCRIBED?this.launcher.inactivate():this.launcher.activate())}),v.emitter.on(v.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,()=>{this.updateState()})}addDefaultClasses(){const e=this.container;if(this.options.position==="bottom-left")e&&m(e,"onesignal-bell-container-bottom-left"),m(this.launcher.selector,"onesignal-bell-launcher-bottom-left");else if(this.options.position==="bottom-right")e&&m(e,"onesignal-bell-container-bottom-right"),m(this.launcher.selector,"onesignal-bell-launcher-bottom-right");else throw new Error(`Invalid OneSignal notify button position ${this.options.position}`);if(this.options.theme==="default")m(this.launcher.selector,"onesignal-bell-launcher-theme-default");else if(this.options.theme==="inverse")m(this.launcher.selector,"onesignal-bell-launcher-theme-inverse");else throw new Error(`Invalid OneSignal notify button theme ${this.options.theme}`)}async create(){if(!this.options.enable)return;if(await v.context.dynamicResourceLoader.loadSdkStylesheet()!==Ot.Loaded){a.debug("Not showing notify button because styles failed to load.");return}this.container&&He("#onesignal-bell-container"),ne("body","beforeend",'<div id="onesignal-bell-container" class="onesignal-bell-container onesignal-reset"></div>'),this.container&&ne(this.container,"beforeend",'<div id="onesignal-bell-launcher" class="onesignal-bell-launcher"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-button"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-badge"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-message"></div>'),ne(this.message.selector,"beforeend",'<div class="onesignal-bell-launcher-message-body"></div>'),ne(this.launcher.selector,"beforeend",'<div class="onesignal-bell-launcher-dialog"></div>'),ne(this.dialog.selector,"beforeend",'<div class="onesignal-bell-launcher-dialog-body"></div>'),ne(this.button.selector,"beforeend",yo);const t=await v.context.subscriptionManager.isPushNotificationsEnabled();Ye.wasPromptOfTypeDismissed(se.Push);const i=t?"small":this.options.size||this.DEFAULT_SIZE;await this.launcher.resize(i),this.addDefaultClasses(),this.applyOffsetIfSpecified(),this.setCustomColorsIfSpecified(),this.patchSafariSvgFilterBug(),a.info("Showing the notify button."),await(t?this.launcher.inactivate():dt()).then(()=>t&&this.dialog.notificationIcons===null?F.getNotificationIcons().then(n=>{this.dialog.notificationIcons=n}):dt()).then(()=>lt(this.options.showLauncherAfter||0)).then(()=>this.launcher.show()).then(()=>lt(this.options.showBadgeAfter||0)).then(()=>this.options.prenotify&&!t&&v._isNewVisitor?this.message.enqueue(this.options.text["message.prenotify"]).then(()=>this.badge.show()):dt()).then(()=>this.initialized=!0)}patchSafariSvgFilterBug(){if(!(P().name=="safari"&&Number(P().version)>=9.1)){const e="drop-shadow(0 2px 4px rgba(34,36,38,0.35));",t="drop-shadow(0 2px 4px rgba(34,36,38,0));",i="drop-shadow(0px 2px 2px rgba(34,36,38,.15));";this.graphic.setAttribute("style",`filter: ${e}; -webkit-filter: ${e};`),this.badge.element.setAttribute("style",`filter: ${t}; -webkit-filter: ${t};`),this.dialog.element.setAttribute("style",`filter: ${i}; -webkit-filter: ${i};`)}P().name=="safari"&&this.badge.element.setAttribute("style","display: none;")}applyOffsetIfSpecified(){const e=this.options.offset;if(e){const t=this.launcher.element;if(!t){a.error("Could not find bell dom element");return}t.style.cssText="",e.bottom&&(t.style.cssText+=`bottom: ${e.bottom};`),this.options.position==="bottom-right"?e.right&&(t.style.cssText+=`right: ${e.right};`):this.options.position==="bottom-left"&&e.left&&(t.style.cssText+=`left: ${e.left};`)}}setCustomColorsIfSpecified(){const e=this.dialog.element.querySelector("button.action"),t=this.button.element.querySelector(".pulse-ring");this.graphic.querySelector(".background").style.cssText="";const i=this.graphic.querySelectorAll(".foreground");for(let n=0;n<i.length;n++){const s=i[n];s.style.cssText=""}if(this.graphic.querySelector(".stroke").style.cssText="",this.badge.element.style.cssText="",e&&(e.style.cssText="",e.style.cssText=""),t&&(t.style.cssText=""),this.options.colors){const n=this.options.colors;if(n["circle.background"]&&(this.graphic.querySelector(".background").style.cssText+=`fill: ${n["circle.background"]}`),n["circle.foreground"]){const s=this.graphic.querySelectorAll(".foreground");for(let r=0;r<s.length;r++){const d=s[r];d.style.cssText+=`fill: ${n["circle.foreground"]}`}this.graphic.querySelector(".stroke").style.cssText+=`stroke: ${n["circle.foreground"]}`}n["badge.background"]&&(this.badge.element.style.cssText+=`background: ${n["badge.background"]}`),n["badge.bordercolor"]&&(this.badge.element.style.cssText+=`border-color: ${n["badge.bordercolor"]}`),n["badge.foreground"]&&(this.badge.element.style.cssText+=`color: ${n["badge.foreground"]}`),e&&(n["dialog.button.background"]&&(this.dialog.element.querySelector("button.action").style.cssText+=`background: ${n["dialog.button.background"]}`),n["dialog.button.foreground"]&&(this.dialog.element.querySelector("button.action").style.cssText+=`color: ${n["dialog.button.foreground"]}`),n["dialog.button.background.hovering"]&&this.addCssToHead("onesignal-background-hover-style",`#onesignal-bell-container.onesignal-reset .onesignal-bell-launcher .onesignal-bell-launcher-dialog button.action:hover { background: ${n["dialog.button.background.hovering"]} !important; }`),n["dialog.button.background.active"]&&this.addCssToHead("onesignal-background-active-style",`#onesignal-bell-container.onesignal-reset .onesignal-bell-launcher .onesignal-bell-launcher-dialog button.action:active { background: ${n["dialog.button.background.active"]} !important; }`)),t&&n["pulse.color"]&&(this.button.element.querySelector(".pulse-ring").style.cssText=`border-color: ${n["pulse.color"]}`)}}addCssToHead(e,t){if(document.getElementById(e))return;const n=document.createElement("style");n.id=e,n.type="text/css",n.appendChild(document.createTextNode(t)),document.head.appendChild(n)}updateState(){Promise.all([v.context.subscriptionManager.isPushNotificationsEnabled(),v.context.permissionManager.getPermissionStatus()]).then(([e,t])=>{this.setState(e?T.STATES.SUBSCRIBED:T.STATES.UNSUBSCRIBED),t===ue.Denied&&this.setState(T.STATES.BLOCKED)}).catch(e=>{a.error(e)})}setState(e,t=!1){const i=this.state;this.state=e,i!==e&&!t&&O.trigger(T.EVENTS.STATE_CHANGED,{from:i,to:e})}get container(){return document.querySelector("#onesignal-bell-container")}get graphic(){return this.button.element.querySelector("svg")}get launcher(){return this._launcher||(this._launcher=new wo(this)),this._launcher}get button(){return this._button||(this._button=new mo(this)),this._button}get badge(){return this._badge||(this._badge=new fo),this._badge}get message(){return this._message||(this._message=new pe(this)),this._message}get dialog(){return this._dialog||(this._dialog=new bo(this)),this._dialog}get subscribed(){return this.state===T.STATES.SUBSCRIBED}get unsubscribed(){return this.state===T.STATES.UNSUBSCRIBED}get blocked(){return this.state===T.STATES.BLOCKED}}class ${static async internalInit(){a.debug("Called internalInit()"),await OneSignal.context.serviceWorkerManager.installWorker();const e=OneSignal.context.sessionManager;if(OneSignal.emitter.on(OneSignal.EVENTS.SESSION_STARTED,e.sendOnSessionUpdateFromPage.bind(e)),OneSignal.context.pageViewManager.incrementPageViewCount(),document.visibilityState!=="visible"){$.postponeSessionInitUntilPageIsInFocus();return}await $.sessionInit()}static postponeSessionInitUntilPageIsInFocus(){ye(document,"visibilitychange",(e,t)=>{document.visibilityState==="visible"&&(t(),$.sessionInit())},!0)}static async sessionInit(){if(a.debug("Called sessionInit()"),OneSignal._sessionInitAlreadyRunning){a.debug("Returning from sessionInit because it has already been called.");return}OneSignal._sessionInitAlreadyRunning=!0;try{await $.doInitialize()}catch(n){if(n instanceof he)return;throw n}const e=await OneSignal.context.subscriptionManager.isOptedOut()??!1,t=await u.getSubscription();t.optedOut=e,await u.setSubscription(t),await $.handleAutoResubscribe(e);const i=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();await u.setIsPushEnabled(!!i),OneSignal.config?.userConfig.promptOptions?.autoPrompt&&!e&&OneSignal.context.promptsManager.spawnAutoPrompts(),OneSignal._sessionInitAlreadyRunning=!1,await O.trigger(OneSignal.EVENTS.SDK_INITIALIZED)}static async registerForPushNotifications(){await it.registerForPush()}static async onSdkInitialized(){const e=await $.processExpiringSubscriptions();await OneSignal.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()?(OneSignal.context.sessionManager.setupSessionEventListeners(),e||await OneSignal.context.updateManager.sendOnSessionUpdate()):!OneSignal.config?.userConfig.promptOptions?.autoPrompt&&!OneSignal.config?.userConfig.autoResubscribe&&await OneSignal.context.updateManager.sendOnSessionUpdate(),await O.trigger(OneSignal.EVENTS.SDK_INITIALIZED_PUBLIC)}static async storeInitialValues(){const e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),t=await OneSignal.context.permissionManager.getPermissionStatus(),i=await OneSignal.context.subscriptionManager.isOptedOut();W.put("subscription.optedOut",i),await u.put("Options",{key:"isPushEnabled",value:e}),await u.put("Options",{key:"notificationPermission",value:t})}static async setWelcomeNotificationFlag(){await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.context.appConfig.safariWebId)===ue.Granted&&(OneSignal.__doNotShowWelcomeNotification=!0)}static async establishServiceWorkerChannel(){if(navigator.serviceWorker&&window.isSecureContext)try{await OneSignal.context.serviceWorkerManager.establishServiceWorkerChannel()}catch(e){a.error(e)}}static async processExpiringSubscriptions(){const e=OneSignal.context;if(a.debug("Checking subscription expiration..."),!await e.subscriptionManager.isSubscriptionExpiring())return a.debug("Subscription is not considered expired."),!1;a.debug("Subscription is considered expiring.");const i=await e.subscriptionManager.subscribe(ei.SubscribeNew);return await e.subscriptionManager.registerSubscription(i),!0}static async doInitialize(){const e=[];e.push($.storeInitialValues()),e.push($.installNativePromptPermissionChangedHook()),e.push($.setWelcomeNotificationFlag()),e.push($.establishServiceWorkerChannel()),e.push($.showNotifyButton()),e.push($.showPromptsFromWebConfigEditor());try{await Promise.all(e)}catch(t){throw a.error(t),new he(Q.Unknown)}}static async showNotifyButton(){if(!OneSignal.notifyButton){OneSignal.config.userConfig.notifyButton=OneSignal.config.userConfig.notifyButton||{},OneSignal.config.userConfig.bell&&(OneSignal.config.userConfig.bell={...OneSignal.config.userConfig.bell,...OneSignal.config.userConfig.notifyButton},OneSignal.config.userConfig.notifyButton={...OneSignal.config.userConfig.notifyButton,...OneSignal.config.userConfig.bell});const e=OneSignal.config.userConfig.notifyButton.displayPredicate;e&&typeof e=="function"?OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,async()=>{await Promise.resolve(OneSignal.config.userConfig.notifyButton.displayPredicate?.())!==!1?(OneSignal.notifyButton=new T(OneSignal.config.userConfig.notifyButton),OneSignal.notifyButton.create()):a.debug("Notify button display predicate returned false so not showing the notify button.")}):(OneSignal.notifyButton=new T(OneSignal.config.userConfig.notifyButton),OneSignal.notifyButton.create())}}static async showPromptsFromWebConfigEditor(){const e=OneSignal.config;e.userConfig.promptOptions&&await new rn(e.userConfig.promptOptions.customlink).initialize()}static async installNativePromptPermissionChangedHook(){try{if(navigator.permissions){const e=await navigator.permissions.query({name:"notifications"});e.onchange=function(){us()}}}catch(e){a.warn(`Could not install native notification permission change hook w/ error: ${e}`)}}static async saveInitOptions(){const e=[],t=OneSignal.config?.userConfig.persistNotification;e.push(u.put("Options",{key:"persistNotification",value:t??!0}));const i=OneSignal.config?.userConfig.webhooks;return["notification.willDisplay","notification.clicked","notification.dismissed"].forEach(n=>{i&&i[n]?e.push(u.put("Options",{key:`webhooks.${n}`,value:i[n]})):e.push(u.put("Options",{key:`webhooks.${n}`,value:!1}))}),i&&i.cors?e.push(u.put("Options",{key:"webhooks.cors",value:!0})):e.push(u.put("Options",{key:"webhooks.cors",value:!1})),OneSignal.config?.userConfig.notificationClickHandlerMatch?e.push(u.put("Options",{key:"notificationClickHandlerMatch",value:OneSignal.config.userConfig.notificationClickHandlerMatch})):e.push(u.put("Options",{key:"notificationClickHandlerMatch",value:"exact"})),OneSignal.config?.userConfig.notificationClickHandlerAction?e.push(u.put("Options",{key:"notificationClickHandlerAction",value:OneSignal.config.userConfig.notificationClickHandlerAction})):e.push(u.put("Options",{key:"notificationClickHandlerAction",value:"navigate"})),Promise.all(e)}static async initSaveState(e){const t=F.getAppId(),i=OneSignal.config;await u.put("Ids",{type:"appId",id:t});const n=e||i.siteName||document.title||"Notification";await u.put("Options",{key:"pageTitle",value:n}),a.info(`OneSignal: Set pageTitle to be '${n}'.`)}static async handleAutoResubscribe(e){a.info("handleAutoResubscribe",{autoResubscribe:OneSignal.config?.userConfig.autoResubscribe,isOptedOut:e}),OneSignal.config?.userConfig.autoResubscribe&&!e&&await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.context.appConfig.safariWebId)==ue.Granted&&await it.registerForPush()}static errorIfInitAlreadyCalled(){if(OneSignal._initCalled)throw new he(Q.MultipleInitialization);OneSignal._initCalled=!0}}const be={InvalidSms:0,InvalidEmail:1,InvalidEmailAndSms:2},Io=Object.fromEntries(Object.entries(be).map(([o,e])=>[e,o]));class Je extends M{description;reason;constructor(e){let t;switch(e){case be.InvalidEmail:t="Invalid email";break;case be.InvalidSms:t="Invalid sms";break;case be.InvalidEmailAndSms:t="Invalid email & sms";break}super(t),this.description=Io[e],this.reason=e,Object.setPrototypeOf(this,Je.prototype)}}const Ri={Stylesheet:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/css/intlTelInput.min.css",Main:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/intlTelInput.min.js",Utils:"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.12/js/utils.js"},_i={Stylesheet:"sha512-yye/u0ehQsrVrfSd6biT17t39Rg9kNc+vENcCXZuMz2a+LWFGvXUnYuWUW6pbfYj1jcBb/C39UZw2ciQvwDDvg==",Main:"sha512-OnkjbJ4TwPpgSmjXACCb5J4cJwi880VRe+vWpPDlr8M38/L3slN5uUAeOeWU2jN+4vN0gImCXFGdJmc0wO4Mig==",Utils:"sha512-bUcJxlqkiGA3cmoYPuZaLRsyc5ChG9APG4ajom2AXKSlBtOmx4kLV3c8uv/6uSz43FMjI4Q2QI21+D223rT76w=="};class oe{smsInputFieldIsValid=!0;emailInputFieldIsValid=!0;promptOptions;itiOneSignal;constructor(e){this.promptOptions=e}generateHtml(){const e=document.createElement("div");m(e,j.channelCaptureContainer),e.id=j.channelCaptureContainer;let t,i,n;switch(this.promptOptions.type){case f.Sms:t=this.promptOptions.text.smsLabel||"Phone Number",i=this.getInputWithValidationElement(f.Sms,t),e.appendChild(i);break;case f.Email:t=this.promptOptions.text.emailLabel||"Email",n=this.getInputWithValidationElement(f.Email,t),e.appendChild(n);break;case f.SmsAndEmail:t=this.promptOptions.text.emailLabel||"Email",n=this.getInputWithValidationElement(f.Email,t),e.appendChild(n),t=this.promptOptions.text.smsLabel||"Phone Number",i=this.getInputWithValidationElement(f.Sms,t),e.appendChild(i);break}return e}getValidationElementWithMessage(e){const t=document.createElement("div"),i=document.createElement("img"),n=document.createElement("p");return n.innerText=e,i.setAttribute("src",Us),t.appendChild(i),t.appendChild(n),t}getInputWithValidationElement(e,t){const i=this.getTypeSpecificVariablesForValidationElemGeneration(e),n=document.createElement("label"),s=document.createElement("input"),r=document.createElement("div"),d=document.createElement("div"),c=this.getValidationElementWithMessage(i.message),l=document.createElement("div");return r.setAttribute("style","clear:both"),d.setAttribute("style","clear:both"),m(c,j.onesignalValidationElementHidden),m(c,j.onesignalValidationElement),c.id=i.validationElementId,n.title=t,n.innerText=t,n.htmlFor=i.inputElementId,s.type=i.domElementType,s.id=i.inputElementId,s.tabIndex=i.tabIndex,m(s,i.inputClass),m(l,j.inputWithValidationElement),l.id=i.wrappingDivId,l.appendChild(n),l.appendChild(r),l.appendChild(s),l.appendChild(d),l.appendChild(c),l}getTypeSpecificVariablesForValidationElemGeneration(e){if(e===f.Email)return{message:"Please enter a valid email",domElementType:"email",validationElementId:G.onesignalEmailValidationElement,inputElementId:G.onesignalEmailInput,inputClass:j.onesignalEmailInput,wrappingDivId:G.emailInputWithValidationElement,tabIndex:1};if(e===f.Sms)return{message:"Please enter a valid phone number",domElementType:"tel",validationElementId:G.onesignalSmsValidationElement,inputElementId:G.onesignalSmsInput,inputClass:j.onesignalSmsInput,wrappingDivId:G.smsInputWithValidationElement,tabIndex:2};throw new Error("invalid channel type for input validation")}initializePhoneInputLibrary(){const e=L(`#${G.onesignalSmsInput}`);e&&window.intlTelInput?this.itiOneSignal=window.intlTelInput(e,{autoPlaceholder:"off",separateDialCode:!0}):a.error("OneSignal: there was a problem initializing International Telephone Input")}addSmsInputEventListeners(){const e=L(`#${G.onesignalSmsInput}`);e.addEventListener("keyup",t=>{this.smsInputFieldIsValid=this.itiOneSignal.isValidNumber()||e?.value==="",t.key==="Enter"&&document.getElementById(C.allowButton)?.click(),this.updateValidationOnSmsInputChange()}),e.addEventListener("blur",()=>{this.smsInputFieldIsValid=this.itiOneSignal.isValidNumber()||e?.value==="",this.updateValidationOnSmsInputChange()})}addEmailInputEventListeners(){const e=L(`#${G.onesignalEmailInput}`);e.addEventListener("keyup",t=>{const i=e?.value;this.emailInputFieldIsValid=oe.validateEmailInputWithReturnVal(i),t.key==="Enter"&&document.getElementById(C.allowButton)?.click(),this.updateValidationOnEmailInputChange()})}updateValidationOnSmsInputChange(){const e=L(`#${G.smsInputWithValidationElement}`),t=L(`#${G.onesignalSmsValidationElement}`);de(e,j.onesignalErrorInput),m(t,j.onesignalValidationElementHidden)}updateValidationOnEmailInputChange(){const e=L(`#${G.emailInputWithValidationElement}`),t=L(`#${G.onesignalEmailValidationElement}`);de(e,j.onesignalErrorInput),m(t,j.onesignalValidationElementHidden)}async loadPhoneLibraryScripts(){if(OneSignal._didLoadITILibrary)return;const e=document.createElement("script"),t=document.createElement("script"),i=document.createElement("link");e.src=Ri.Main,t.src=Ri.Utils,i.href=Ri.Stylesheet,i.rel="stylesheet",e.integrity=_i.Main,t.integrity=_i.Utils,i.integrity=_i.Stylesheet,e.crossOrigin="anonymous",t.crossOrigin="anonymous",i.crossOrigin="anonymous",document.head.appendChild(e),document.head.appendChild(t),document.head.appendChild(i);const n=new Promise(r=>{e.onload=()=>{r()}}),s=new Promise(r=>{t.onload=()=>{r()}});await Promise.all([n,s]),OneSignal._didLoadITILibrary=!0}async mount(){const e=oe.isUsingSmsInputField(this.promptOptions.type),t=oe.isUsingEmailInputField(this.promptOptions.type);e&&await this.loadPhoneLibraryScripts();const i=this.generateHtml();L(`#${C.body}`).appendChild(i),e&&(this.initializePhoneInputLibrary(),this.addSmsInputEventListeners()),t&&this.addEmailInputEventListeners()}isEmailInputFieldEmpty(){return this.getValueFromEmailInput()===""}isSmsInputFieldEmpty(){return this.getValueFromSmsInput()===""}getValueFromEmailInput(){return L(`#${G.onesignalEmailInput}`)?.value||""}getValueFromSmsInput(){return this.itiOneSignal.getNumber(window.intlTelInput.utils.numberFormat.E164)||""}static showSmsInputError(e){const t=document.querySelector(`#${G.onesignalSmsValidationElement}`),i=document.querySelector(`#${G.smsInputWithValidationElement}`);if(!t||!i){a.error("OneSignal: couldn't find slidedown validation element");return}e?(t.classList.remove(j.onesignalValidationElementHidden),i.classList.add(j.onesignalErrorInput)):(t.classList.add(j.onesignalValidationElementHidden),i.classList.remove(j.onesignalErrorInput))}static showEmailInputError(e){const t=document.querySelector(`#${G.onesignalEmailValidationElement}`),i=document.querySelector(`#${G.emailInputWithValidationElement}`);if(!t||!i){a.error("OneSignal: couldn't find slidedown validation element");return}e?(t.classList.remove(j.onesignalValidationElementHidden),i.classList.add(j.onesignalErrorInput)):(t.classList.add(j.onesignalValidationElementHidden),i.classList.remove(j.onesignalErrorInput))}static resetInputErrorStates(e){switch(e){case f.Sms:oe.showSmsInputError(!1);break;case f.Email:oe.showEmailInputError(!1);break;case f.SmsAndEmail:oe.showSmsInputError(!1),oe.showEmailInputError(!1);break}}static validateEmailInputWithReturnVal(e){return/^\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(e||"")||e===""}static isUsingSmsInputField(e){return e===f.Sms||e===f.SmsAndEmail}static isUsingEmailInputField(e){return e===f.Email||e===f.SmsAndEmail}}function bn(o){return`<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="24px" height="24px" fill="${o}"> <g transform="rotate(0 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.916s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(30 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.833s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(60 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"/> </rect> </g> <g transform="rotate(90 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.666s"/> </rect> </g> <g transform="rotate(120 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.583s"/> </rect> </g> <g transform="rotate(150 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.5s"/> </rect> </g> <g transform="rotate(180 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.416s"/> </rect> </g> <g transform="rotate(210 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.333s"/> </rect> </g> <g transform="rotate(240 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.25s"/> </rect> </g> <g transform="rotate(270 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.166s"/> </rect> </g> <g transform="rotate(300 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="-0.083s"/> </rect> </g> <g transform="rotate(330 50 50)"> <rect x="46" y="6" rx="36.8" ry="4.8" width="8" height="24" > <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" repeatCount="indefinite" begin="0s"/> </rect> </g> </svg>`}function Eo(o="#FFFFFF"){return`<svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.711 2.652a5.489 5.489 0 00-4.044 4.05 5.513 5.513 0 00.104 2.968.167.167 0 00.25.089l.893-.588a.667.667 0 011.02.692l-.61 2.937a.667.667 0 01-.786.52L.6 12.713a.667.667 0 01-.232-1.21l.933-.615a.166.166 0 00.063-.2 7.167 7.167 0 018.828-9.516.833.833 0 01-.507 1.587 5.489 5.489 0 00-2.974-.108zM15.75 3.542c.09.096.15.216.172.346a.667.667 0 01-.301.681l-.898.564a.166.166 0 00-.066.2 7.167 7.167 0 01-8.77 9.514.835.835 0 01-.154-1.544.831.831 0 01.646-.048 5.5 5.5 0 006.856-6.949.167.167 0 00-.176-.114.164.164 0 00-.071.026l-.962.604a.667.667 0 01-1.005-.713l.667-2.924a.667.667 0 01.8-.502l2.925.667c.129.03.246.096.336.192z" fill="${o}"/></svg>`}function vo(o){const{icon:e,messageText:t,positiveButtonText:i,negativeButtonText:n}=o,s=e===D.defaultIcon?Ds:e,r=e===D.defaultIcon?D.defaultIcon:"",d=document.createElement("div"),c=document.createElement("div"),l=document.createElement("div"),g=document.createElement("div"),b=document.createElement("div"),h=document.createElement("div"),E=document.createElement("button"),w=document.createElement("button"),U=document.createElement("div"),ge=document.createElement("div"),we=document.createElement("img");return m(c,D.body),m(g,D.icon),m(l,D.message),m(h,D.footer),m(U,D.clearfix),m(ge,D.clearfix),m(E,ht.alignRight),m(E,ht.primary),m(E,ht.slidedownButton),m(w,ht.alignRight),m(w,ht.secondary),m(w,ht.slidedownButton),d.id=C.normalSlidedown,c.id=C.body,b.id=C.loadingContainer,E.id=C.allowButton,w.id=C.cancelButton,h.id=C.footer,r&&m(we,r),we.setAttribute("alt","notification icon"),we.setAttribute("src",s||""),l.innerText=t||"",E.innerText=i||"",w.innerText=n||"",g.appendChild(we),c.appendChild(g),c.appendChild(l),c.appendChild(U),c.appendChild(b),h.appendChild(E),h.appendChild(w),h.appendChild(ge),d.appendChild(c),d.appendChild(h),d}class q{options;notificationIcons;channelCaptureContainer;isShowingFailureState;tagCategories;savingButton=ie.savingText;errorButton=ie.errorButton;updateMessage;positiveUpdateButton;negativeUpdateButton;constructor(e){switch(this.options=e,this.options.text.actionMessage=e.text.actionMessage.substring(0,90),this.options.text.acceptButton=e.text.acceptButton.substring(0,16),this.options.text.cancelButton=e.text.cancelButton.substring(0,16),this.notificationIcons=null,this.channelCaptureContainer=null,this.isShowingFailureState=!1,e.type){case f.Category:this.negativeUpdateButton=this.options.text.negativeUpdateButton?.substring(0,16),this.positiveUpdateButton=this.options.text.positiveUpdateButton?.substring(0,16),this.updateMessage=this.options.text.updateMessage?.substring(0,90),this.tagCategories=e.categories,this.errorButton=Z(this.options.text.positiveUpdateButton,ie.errorButton);break;case f.Sms:case f.Email:case f.SmsAndEmail:this.errorButton=Z(this.options.text.acceptButton,ie.errorButton);break}}async create(e){if(this.notificationIcons===null){const t=await F.getNotificationIcons();this.notificationIcons=t,this.container.className.includes(D.container)&&He(`#${C.container}`);const i=e&&this.tagCategories?this.positiveUpdateButton:this.options.text.acceptButton,n=e&&this.tagCategories?this.negativeUpdateButton:this.options.text.cancelButton,s=e&&this.tagCategories?this.updateMessage:this.options.text.actionMessage,r=this.options.icon||this.getPlatformNotificationIcon(),d=vo({messageText:s,icon:r,positiveButtonText:i,negativeButtonText:n}),c=document.createElement("div"),l=document.createElement("div");c.id=C.container,m(c,D.container),m(c,D.reset),L("body").appendChild(c),l.id=C.dialog,m(l,D.dialog),l.appendChild(d),this.container.appendChild(l),m(this.container,P().mobile?D.slideUp:D.slideDown),this.allowButton.addEventListener("click",this.onSlidedownAllowed.bind(this)),this.cancelButton.addEventListener("click",this.onSlidedownCanceled.bind(this))}}static async triggerSlidedownEvent(e){await O.trigger(e)}async onSlidedownAllowed(e){await q.triggerSlidedownEvent(q.EVENTS.ALLOW_CLICK)}onSlidedownCanceled(e){q.triggerSlidedownEvent(q.EVENTS.CANCEL_CLICK),this.close(),q.triggerSlidedownEvent(q.EVENTS.CLOSED)}close(){m(this.container,D.closeSlidedown),ye(this.dialog,"animationend",(e,t)=>{e.target===this.dialog&&(e.animationName==="slideDownExit"||e.animationName==="slideUpExit")&&(He(`#${C.container}`),t())},!0)}setSaveState(){this.allowButton.disabled=!0,this.allowButton.textContent=null,this.allowButton.insertAdjacentElement("beforeend",this.getTextSpan(this.savingButton)),this.allowButton.insertAdjacentElement("beforeend",this.getIndicatorHolder()),ne(this.buttonIndicatorHolder,"beforeend",bn(on.whiteLoadingIndicator)),m(this.allowButton,"disabled"),m(this.allowButton,D.savingStateButton)}removeSaveState(){this.allowButton.textContent=this.positiveUpdateButton??"",He(`#${D.buttonIndicatorHolder}`),this.allowButton.disabled=!1,de(this.allowButton,"disabled"),de(this.allowButton,D.savingStateButton)}setFailureState(){this.allowButton.textContent=null,this.allowButton.insertAdjacentElement("beforeend",this.getTextSpan(this.errorButton)),this.options.type===f.Category&&(this.allowButton.insertAdjacentElement("beforeend",this.getIndicatorHolder()),ne(this.buttonIndicatorHolder,"beforeend",Eo()),m(this.allowButton,"onesignal-error-state-button")),this.isShowingFailureState=!0}setFailureStateForInvalidChannelInput(e){switch(e){case be.InvalidSms:oe.showSmsInputError(!0);break;case be.InvalidEmail:oe.showEmailInputError(!0);break;case be.InvalidEmailAndSms:oe.showSmsInputError(!0),oe.showEmailInputError(!0);break}}removeFailureState(){He("#onesignal-button-indicator-holder"),de(this.allowButton,"onesignal-error-state-button"),Le.isSlidedownPushDependent(this.options.type)||oe.resetInputErrorStates(this.options.type),this.isShowingFailureState=!1}getPlatformNotificationIcon(){return Ei(this.notificationIcons)}getIndicatorHolder(){const e=document.createElement("div");return e.id=C.buttonIndicatorHolder,m(e,D.buttonIndicatorHolder),e}getTextSpan(e){const t=document.createElement("span");return t.textContent=e,t}get container(){return L(`#${C.container}`)}get dialog(){return L(`#${C.dialog}`)}get allowButton(){return L(`#${C.allowButton}`)}get cancelButton(){return L(`#${C.cancelButton}`)}get buttonIndicatorHolder(){return L(`#${C.buttonIndicatorHolder}`)}get slidedownFooter(){return L(`#${C.footer}`)}static get EVENTS(){return{ALLOW_CLICK:"slidedownAllowClick",CANCEL_CLICK:"slidedownCancelClick",SHOWN:"slidedownShown",CLOSED:"slidedownClosed",QUEUED:"slidedownQueued"}}}function Oo(){const o=OneSignal.notifyButton;o&&o.options?.enable&&OneSignal.notifyButton?.launcher?.state!=="hidden"&&OneSignal.notifyButton?.launcher?.waitUntilShown().then(()=>{OneSignal.notifyButton?.launcher?.hide()}),OneSignal.emitter.once(q.EVENTS.CLOSED,()=>{OneSignal.notifyButton&&OneSignal.notifyButton.options.enable&&OneSignal.notifyButton.launcher.show()})}class To{isNativePromptShowing;context;eventHooksInstalled;constructor(e){this.isNativePromptShowing=!1,this.context=e,this.eventHooksInstalled=!1}shouldForceSlidedownOverNative(){const{environmentInfo:e}=OneSignal,{browserType:t,browserVersion:i,requiresUserInteraction:n}=e;return t===Qe.Chrome&&Number(i)>=63&&(P().tablet||P().mobile)||n}async spawnAutoPrompts(){const e=OneSignal.config?.userConfig.promptOptions,t=this.shouldForceSlidedownOverNative(),i=this.getDelayedPromptOptions(e,f.Native),n=this.isPageViewConditionMet(i),s=i.enabled&&n,r=t&&s;if(s&&!r){this.internalShowDelayedPrompt(f.Native,i.timeDelay||0);return}const d=!!Le.getFirstSlidedownPromptOptionsWithType(e?.slidedown?.prompts,f.Push);r&&!d&&this.internalShowDelayedPrompt(f.Push,i.timeDelay||0);const c=e?.slidedown?.prompts;if(c&&c?.length>0)for(let l=0;l<c.length;l++){const g=c[l],b=this.getDelayedPromptOptions(e,g.type),h=this.isPageViewConditionMet(b),E=b.enabled&&h,w={slidedownPromptOptions:g};E&&this.internalShowDelayedPrompt(g.type,b.timeDelay||0,w)}}async internalShowDelayedPrompt(e,t,i){if(V.logMethodCall("internalShowDelayedPrompt"),typeof t!="number"){a.error("internalShowDelayedPrompt: timeDelay not a number");return}const{requiresUserInteraction:n}=di.getEnvironmentInfo();switch(n&&e===f.Native&&(e=f.Push),t>0&&await Et(t*1e3),e){case f.Native:await this.internalShowNativePrompt();break;case f.Push:await this.internalShowSlidedownPrompt(i);break;case f.Category:await this.internalShowCategorySlidedown(i);break;case f.Sms:await this.internalShowSmsSlidedown(i);break;case f.Email:await this.internalShowEmailSlidedown(i);break;case f.SmsAndEmail:await this.internalShowSmsAndEmailSlidedown(i);break;default:a.error("Invalid Delayed Prompt type")}}async internalShowNativePrompt(){if(V.logMethodCall("internalShowNativePrompt"),this.isNativePromptShowing){a.debug("Already showing autoprompt. Abort showing a native prompt.");return}this.isNativePromptShowing=!0,await $.registerForPushNotifications(),this.isNativePromptShowing=!1,Ye.markPromptDismissedWithType(se.Push)}async internalShowSlidedownPrompt(e={force:!1}){if(V.logMethodCall("internalShowSlidedownPrompt"),e.slidedownPromptOptions||(e.slidedownPromptOptions=pi),await this.context.dynamicResourceLoader.loadSdkStylesheet()!==Ot.Loaded){a.debug("Not showing slidedown permission message because styles failed to load.");return}this.eventHooksInstalled||this.installEventHooksForSlidedown(),await this.context.slidedownManager.createSlidedown(e)}async internalShowCategorySlidedown(e){V.logMethodCall("internalShowCategorySlidedown"),await this.internalShowParticularSlidedown(f.Category,e)}async internalShowSmsSlidedown(e){V.logMethodCall("internalShowSmsSlidedown"),await this.internalShowParticularSlidedown(f.Sms,e)}async internalShowEmailSlidedown(e){V.logMethodCall("internalShowEmailSlidedown"),await this.internalShowParticularSlidedown(f.Email,e)}async internalShowSmsAndEmailSlidedown(e){V.logMethodCall("internalShowSmsAndEmailSlidedown"),await this.internalShowParticularSlidedown(f.SmsAndEmail,e)}async internalShowParticularSlidedown(e,t){const i=this.context.appConfig.userConfig.promptOptions?.slidedown?.prompts,n=t?.slidedownPromptOptions||Le.getFirstSlidedownPromptOptionsWithType(i,e);if(!n)if(e!==f.Push){a.error(`OneSignal: slidedown of type '${e}' couldn't be shown. Check your configuration on the OneSignal dashboard or your custom code initialization.`);return}else a.warn("The OneSignal 'push' slidedown will be shown with default text settings. To customize, see the OneSignal documentation.");await this.internalShowSlidedownPrompt({...t,slidedownPromptOptions:n})}installEventHooksForSlidedown(){this.eventHooksInstalled=!0,OneSignal.emitter.on(q.EVENTS.SHOWN,()=>{this.context.slidedownManager.setIsSlidedownShowing(!0)}),OneSignal.emitter.on(q.EVENTS.CLOSED,()=>{this.context.slidedownManager.setIsSlidedownShowing(!1),this.context.slidedownManager.showQueued()}),OneSignal.emitter.on(q.EVENTS.ALLOW_CLICK,async()=>{await this.context.slidedownManager.handleAllowClick(),O.trigger(OneSignal.EVENTS.TEST_FINISHED_ALLOW_CLICK_HANDLING)}),OneSignal.emitter.on(q.EVENTS.CANCEL_CLICK,()=>{if(!this.context.slidedownManager.slidedown)return;switch(this.context.slidedownManager.slidedown?.options.type){case f.Push:case f.Category:a.debug("Setting flag to not show the slidedown to the user again."),Ye.markPromptDismissedWithType(se.Push);break;default:a.debug("Setting flag to not show the slidedown to the user again."),Ye.markPromptDismissedWithType(se.NonPush);break}})}isPageViewConditionMet(e){return!e||typeof e.pageViews>"u"||!e.autoPrompt||!e.enabled?!1:this.context.pageViewManager.getLocalPageViewCount()>=e.pageViews}getDelayedPromptOptions(e,t){const i={enabled:!1,autoPrompt:!1,timeDelay:ce.timeDelay,pageViews:ce.pageViews};if(!e||!e.native||!e.slidedown)return i;switch(t){case f.Native:{const n=e.native;return{enabled:n?.enabled,autoPrompt:n?.autoPrompt,timeDelay:n?.timeDelay,pageViews:n?.pageViews}}case f.Push:case f.Category:case f.Email:case f.Sms:case f.SmsAndEmail:{const{userConfig:n}=this.context.appConfig,s=Le.getFirstSlidedownPromptOptionsWithType(n.promptOptions?.slidedown?.prompts||[],t);return{enabled:!!s,autoPrompt:!!s?.autoPrompt,timeDelay:s?.delay?.timeDelay,pageViews:s?.delay?.pageViews}}default:return i}}}class Rt extends M{constructor(e){super(`This operation can only be performed when the channel '${e}' does not yet exist.`),Object.setPrototypeOf(this,Rt.prototype)}}class _e{static convertTagsApiToBooleans(e){const t={};return Object.keys(e).forEach(i=>{t[i]=e[i]==="1"}),t}static convertTagsBooleansToApi(e){const t={};return Object.keys(e).forEach(i=>{t[i]=e[i]===!0?"1":"0"}),t}static getObjectDifference(e,t){const i={};return Object.keys(e).forEach(n=>{t[n]!==e[n]&&(i[n]=e[n])}),i}static markAllTagsAsSpecified(e,t){e.forEach(i=>{i.checked=t})}static isTagObjectEmpty(e){return Object.keys(e).length===0}static getCheckedTagCategories(e,t){if(!t)return e;if(_e.isTagObjectEmpty(t)){const s=structuredClone(e);return _e.markAllTagsAsSpecified(s,!0),s}return structuredClone(e).map(s=>{const r=t[s.tag];return s.checked=_e.getCheckedStatusForTagValue(r),s})}static getCheckedStatusForTagValue(e){return e===void 0?!0:e}}class Di extends M{constructor(){super("This operation can only be performed when the user is not subscribed."),Object.setPrototypeOf(this,Di.prototype)}}class Ui extends M{constructor(e){super(`The permission message of type ${e||"unknown"} was previously dismissed.`),Object.setPrototypeOf(this,Ui.prototype)}}class wt{message;constructor(e){this.message=e}async show(){const e=document.createElement("div"),t=document.createElement("p");t.innerText=this.message,e.appendChild(t);const i=document.createElement("div"),n=document.createElement("div");i.id=C.container,e.id=Rs.toastText,m(e,Ms.toastText),m(i,D.container),m(i,D.reset),L("body").appendChild(i),n.id=C.dialog,m(n,D.dialog),n.appendChild(e),this.container.appendChild(n),m(this.container,P().mobile?D.slideUp:D.slideDown),wt.triggerSlidedownEvent(wt.EVENTS.SHOWN)}static async triggerSlidedownEvent(e){await O.trigger(e)}close(){m(this.container,D.closeSlidedown),ye(this.dialog,"animationend",(e,t)=>{e.target===this.dialog&&(e.animationName==="slideDownExit"||e.animationName==="slideUpExit")&&(He(`#${C.container}`),t())},!0)}get container(){return L(`#${C.container}`)}get dialog(){return L(`#${C.dialog}`)}static get EVENTS(){return{SHOWN:"toastShown",CLOSED:"toastClosed"}}}class wn{mount(e,t){const i=this.generateHtml(e,t);L(`#${C.body}`).appendChild(i),this.taggingContainer&&this.taggingContainer.addEventListener("change",this.toggleCheckedTag);const s=L(`#${C.allowButton}`);s.disabled=!1,de(s,"disabled"),He(`#${C.loadingContainer}`)}load(){const e=L(`#${C.loadingContainer}`),t=L(`#${C.allowButton}`),i=document.createElement("div");m(e,`${D.loadingContainer}`),m(i,Ae.loadingMessage),m(t,"disabled"),ne(e,"beforeend",bn(on.greyLoadingIndicator)),i.innerText=Ls.fetchingPreferences,e.appendChild(i),t.disabled=!0}generateHtml(e,t){const i=_e.getCheckedTagCategories(e,t),n=i.filter(l=>i.indexOf(l)%2===0),s=i.filter(l=>i.indexOf(l)%2),r=document.createElement("div"),d=document.createElement("div"),c=document.createElement("div");return m(r,Ae.taggingContainerCol),m(d,Ae.taggingContainerCol),m(c,Ae.taggingContainer),c.id=_s.taggingContainer,n.forEach(l=>{r.appendChild(this.getCategoryLabelElement(l))}),s.forEach(l=>{d.appendChild(this.getCategoryLabelElement(l))}),c.appendChild(r),c.appendChild(d),c}getCategoryLabelElement(e){const{label:t}=e,i=document.createElement("label"),n=document.createElement("span"),s=document.createElement("input"),r=document.createElement("span"),d=document.createElement("div"),c=document.createElement("div");return m(i,Ae.categoryLabel),m(n,Ae.categoryLabelText),m(s,Ae.categoryLabelInput),m(r,Ae.checkmark),i.title=t,n.innerText=t,s.type="checkbox",s.value=e.tag,s.checked=!!e.checked,i.appendChild(n),i.appendChild(s),i.appendChild(r),d.setAttribute("style","clear:both"),c.appendChild(i),c.appendChild(d),c}get taggingContainer(){const e=`#${C.body} > div.${Ae.taggingContainer}`;return L(e)}toggleCheckedTag(e){const t=e.target;if(t&&t.getAttribute("type")==="checkbox"){const i=t.checked;t.setAttribute("checked",i.toString())}}static getValuesFromTaggingContainer(){const e=`#${C.body} > div.${Ae.taggingContainer}> div > div > label > input[type=checkbox]`,t=document.querySelectorAll(e),i={};return t.forEach(n=>{i[n.value]=n.checked}),i}}class Co{context;slidedownQueue;isSlidedownShowing;slidedown;constructor(e){this.context=e,this.slidedownQueue=[],this.isSlidedownShowing=!1}async checkIfSlidedownShouldBeShown(e){const t=await OneSignal.context.permissionManager.getPermissionStatus()===ue.Denied;let i;const n=await OneSignal.context.subscriptionManager.getSubscriptionState(),{subscribed:s,optedOut:r}=n,d=e.slidedownPromptOptions?.type;let c=!1;if(d&&(c=Le.isSlidedownPushDependent(d)),c){if(s)return e.isInUpdateMode?!0:(a.info(new Di),!1);if(i=Ye.wasPromptOfTypeDismissed(se.Push),r)throw new zt(et.OptedOut);if(t)return a.info(new Ge(Fe.Blocked)),!1}else{if(!e.force){const l=await OneSignal.coreDirector.hasSms(),g=await OneSignal.coreDirector.hasEmail(),b=l&&g;if(l&&d===f.Sms)return a.info(new Rt(f.Sms)),!1;if(g&&d===f.Email)return a.info(new Rt(f.Email)),!1;if(b&&d===f.SmsAndEmail)return a.info(new Rt(f.SmsAndEmail)),!1}i=Ye.wasPromptOfTypeDismissed(se.NonPush)}return i&&!e.force&&!e.isInUpdateMode?(a.info(new Ui(d)),!1):!0}registerForPush(){$.registerForPushNotifications()}async handleAllowForCategoryType(){if(!this.slidedown)throw new M("SlidedownManager: handleAllowForCategoryType: this.slidedown is undefined");const e=wn.getValuesFromTaggingContainer();this.context.tagManager.storeTagValuesToUpdate(e),this.registerForPush(),await this.context.tagManager.sendTags(!0)}async handleAllowForEmailType(){if(!this.slidedown)throw new M("SlidedownManager: handleAllowForEmailType: this.slidedown is undefined");const e=this.slidedown.channelCaptureContainer?.emailInputFieldIsValid,t=this.slidedown.channelCaptureContainer?.isEmailInputFieldEmpty();if(!e||t)throw new Je(be.InvalidEmail);const i=this.slidedown.channelCaptureContainer?.getValueFromEmailInput();this.updateEmail(i)}async handleAllowForSmsType(){if(!this.slidedown)throw new M("SlidedownManager: handleAllowForSmsType: this.slidedown is undefined");const e=this.slidedown.channelCaptureContainer?.smsInputFieldIsValid,t=this.slidedown.channelCaptureContainer?.isSmsInputFieldEmpty();if(!e||t)throw new Je(be.InvalidSms);const i=this.slidedown.channelCaptureContainer?.getValueFromSmsInput();this.updateSMS(i)}async handleAllowForSmsAndEmailType(){if(!this.slidedown)throw new M("SlidedownManager: handleAllowForSmsAndEmailType: this.slidedown is undefined");const e=this.slidedown.channelCaptureContainer?.smsInputFieldIsValid,t=this.slidedown.channelCaptureContainer?.emailInputFieldIsValid,i=this.slidedown.channelCaptureContainer?.isEmailInputFieldEmpty(),n=this.slidedown.channelCaptureContainer?.isSmsInputFieldEmpty();if(!e&&!t||i&&n)throw new Je(be.InvalidEmailAndSms);const d=this.slidedown.channelCaptureContainer?.getValueFromEmailInput(),c=this.slidedown.channelCaptureContainer?.getValueFromSmsInput();if(t)i||this.updateEmail(d);else throw new Je(be.InvalidEmail);if(e)n||this.updateSMS(c);else throw new Je(be.InvalidSms)}updateEmail(e){e&&OneSignal.User.addEmail(e)}updateSMS(e){e&&OneSignal.User.addSms(e)}async showConfirmationToast(){if(!this.slidedown)throw new M("SlidedownManager: showConfirmationToast: this.slidedown is undefined");const e=this.slidedown.options.text.confirmMessage;if(!e)return;await Et(1e3);const t=new wt(e);await t.show(),await Et(5e3),t.close(),wt.triggerSlidedownEvent(wt.EVENTS.CLOSED)}async mountAuxiliaryContainers(e){switch(e.slidedownPromptOptions?.type){case f.Category:this.mountTaggingContainer(e);break;case f.Email:case f.Sms:case f.SmsAndEmail:await this.mountChannelCaptureContainer(e);break}}async mountTaggingContainer(e){V.logMethodCall("mountTaggingContainer");try{let t={};const i=new wn,n=e.slidedownPromptOptions?.categories;if(!n)throw new Error("Categories not defined");const r=OneSignal.coreDirector.getPropertiesModel().tags;e.isInUpdateMode&&r?(this.context.tagManager.storeRemotePlayerTags(r),t=_e.convertTagsApiToBooleans(r)):_e.markAllTagsAsSpecified(n,!0),i.mount(n,t)}catch(t){a.error("OneSignal: Attempted to create tagging container with error",t)}}async mountChannelCaptureContainer(e){V.logMethodCall("mountChannelCaptureContainer");try{if(e.slidedownPromptOptions){const t=new oe(e.slidedownPromptOptions);t.mount(),this.slidedown&&(this.slidedown.channelCaptureContainer=t)}}catch(t){a.error("OneSignal: Attempted to create channel capture container with error",t)}}async handleAllowClick(){if(!this.slidedown)throw new M("SlidedownManager: handleAllowClick: this.slidedown is undefined");const e=this.slidedown.options.type;this.slidedown.isShowingFailureState&&this.slidedown.removeFailureState();try{switch(e){case f.Push:this.registerForPush();break;case f.Category:await this.handleAllowForCategoryType();break;case f.Email:await this.handleAllowForEmailType();break;case f.Sms:await this.handleAllowForSmsType();break;case f.SmsAndEmail:await this.handleAllowForSmsAndEmailType();break}}catch(t){a.warn("OneSignal Slidedown failed to update:",t),this.slidedown.removeSaveState(),this.slidedown.setFailureState(),t instanceof Je&&this.slidedown.setFailureStateForInvalidChannelInput(t.reason);return}switch(this.slidedown&&(this.slidedown.close(),Le.isSlidedownPushDependent(e)||await this.showConfirmationToast(),await Et(1e3),q.triggerSlidedownEvent(q.EVENTS.CLOSED)),e){case f.Push:case f.Category:a.debug("Setting flag to not show the slidedown to the user again."),Ye.markPromptDismissedWithType(se.Push);break;default:a.debug("Setting flag to not show the slidedown to the user again."),Ye.markPromptDismissedWithType(se.NonPush);break}}setIsSlidedownShowing(e){this.isSlidedownShowing=e}async showQueued(){if(this.slidedownQueue.length>0){const e=this.dequeue();e&&await this.createSlidedown(e)}}enqueue(e){this.slidedownQueue.push(e),q.triggerSlidedownEvent(q.EVENTS.QUEUED)}dequeue(){return this.slidedownQueue.shift()}async createSlidedown(e){V.logMethodCall("createSlidedown");try{if(!await this.checkIfSlidedownShouldBeShown(e))return}catch(t){a.warn("checkIfSlidedownShouldBeShown returned an error",t);return}if(Oo(),this.isSlidedownShowing){this.enqueue(e);return}try{this.setIsSlidedownShowing(!0);const t=e.slidedownPromptOptions||pi;this.slidedown=new q(t),await this.slidedown.create(e.isInUpdateMode),await this.mountAuxiliaryContainers(e),a.debug("Showing OneSignal Slidedown"),q.triggerSlidedownEvent(q.EVENTS.SHOWN)}catch(t){a.error("There was an error showing the OneSignal Slidedown:",t),this.setIsSlidedownShowing(!1),this.slidedown?.close()}}}class Po{tagsFromTaggingContainer={};context;remoteTags={};constructor(e){this.context=e}async sendTags(){a.info("Category Slidedown Local Tags:",this.tagsFromTaggingContainer);const e=_e.convertTagsBooleansToApi(this.tagsFromTaggingContainer),t=_e.getObjectDifference(e,this.remoteTags);return _e.isTagObjectEmpty(t)?(a.warn("OneSignal: no change detected in Category preferences. Skipping tag update."),t):(await OneSignal.User.addTags(t),t)}storeTagValuesToUpdate(e){this.tagsFromTaggingContainer=e}storeRemotePlayerTags(e){this.context.tagManager.remoteTags=e}}class No{appConfig;environmentInfo;dynamicResourceLoader;subscriptionManager;serviceWorkerManager;workerMessenger;pageViewManager;permissionManager;updateManager;promptsManager;sessionManager;tagManager;slidedownManager;constructor(e){this.appConfig=e,typeof OneSignal<"u"&&OneSignal.environmentInfo&&(this.environmentInfo=OneSignal.environmentInfo),this.subscriptionManager=mn.getSubscriptionManager(this),this.serviceWorkerManager=mn.getServiceWorkerManager(this),this.pageViewManager=new oi,this.permissionManager=new Mi,this.workerMessenger=new co(this),this.updateManager=new uo(this),this.sessionManager=new po(this),this.tagManager=new Po(this),this.slidedownManager=new Co(this),this.promptsManager=new To(this),this.dynamicResourceLoader=new Pi}}class ko{static processItem(e,t){if(typeof t=="function")return t(e);throw new M("Only accepts function type!")}}class Ao{setLogLevel(e){a.setLevel(e)}}class yn extends Qt{_permission;_permissionNative;constructor(e){super(),this._permissionNative=e,this._permission=e===ue.Granted,v.emitter.on(v.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,t=>{this._permissionNative=t,this._permission=t===ue.Granted})}get permissionNative(){return this._permissionNative}get permission(){return this._permission}async setDefaultUrl(e){if(I("setDefaultUrl",e),typeof e>"u")throw new _("url",N.Empty);if(typeof e!="string")throw new _("url",N.WrongType);if(!Gt.isValidUrl(e,{allowNull:!0}))throw new _("url",N.Malformed);await le(),I("setDefaultNotificationUrl",e);const t=await u.getAppState();t.defaultNotificationUrl=e,await u.setAppState(t)}async setDefaultTitle(e){if(I("setDefaultTitle",e),typeof e>"u")throw new _("title",N.Empty);if(typeof e!="string")throw new _("title",N.WrongType);await le();const t=await u.getAppState();t.defaultNotificationTitle=e,await u.setAppState(t)}isPushSupported(){return I("isPushNotificationsSupported"),!0}async requestPermission(){await le(),await v.context.promptsManager.internalShowNativePrompt()}addEventListener(e,t){v.emitter.on(e,t),e==="click"&&Y.fireStoredNotificationClicks()}removeEventListener(e,t){v.emitter.off(e,t)}}const xo={NOTIFICATION_PERMISSION_CHANGED_AS_STRING:"permissionChangeAsString",NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN:"permissionChange",SUBSCRIPTION_CHANGED:"change",WELCOME_NOTIFICATION_SENT:"sendWelcomeNotification",NOTIFICATION_WILL_DISPLAY:"foregroundWillDisplay",NOTIFICATION_DISMISSED:"dismiss",NOTIFICATION_CLICKED:"click",SDK_INITIALIZED:"initializeInternal",SDK_INITIALIZED_PUBLIC:"initialize",REGISTERED:"register",PERMISSION_PROMPT_DISPLAYED:"permissionPromptDisplay",TEST_FINISHED_ALLOW_CLICK_HANDLING:"testFinishedAllowClickHandling",SESSION_STARTED:"os.sessionStarted"};class Mo{async sendOutcome(e,t){const i=OneSignal.config?.userConfig.outcomes;if(!i){a.error(`Could not send ${e}. No outcomes config found.`);return}const n=new xt(OneSignal.config.appId,i,e,!1);if(typeof t<"u"&&typeof t!="number"){a.error("Outcome weight can only be a number if present.");return}if(!await n.beforeOutcomeSend())return;const s=await n.getAttribution();await n.send({type:s.type,notificationIds:s.notificationIds,weight:t})}async sendUniqueOutcome(e){const t=OneSignal.config?.userConfig.outcomes;if(!t){a.error(`Could not send ${e}. No outcomes config found.`);return}const i=new xt(OneSignal.config.appId,t,e,!0);if(!await i.beforeOutcomeSend())return;const n=await i.getAttribution();if(n.type===Ce.NotSupported){a.warn("You are on a free plan. Please upgrade to use this functionality.");return}const{notificationIds:s}=n,r=await i.getNotifsToAttributeWithUniqueOutcome(s);if(!i.shouldSendUnique(n,r)){a.warn(`'${e}' was already reported for all notifications.`);return}await i.send({type:n.type,notificationIds:r})}}class Ro extends Qt{constructor(){super()}async promptPush(e){await le(),await v.context.promptsManager.internalShowParticularSlidedown(f.Push,e)}async promptPushCategories(e){await le();const t=await v.context.subscriptionManager.isPushNotificationsEnabled();await v.context.promptsManager.internalShowCategorySlidedown({...e,isInUpdateMode:t})}async promptSms(e){await le(),await v.context.promptsManager.internalShowSmsSlidedown({...e})}async promptEmail(e){await le(),await v.context.promptsManager.internalShowEmailSlidedown({...e})}async promptSmsAndEmail(e){await le(),await v.context.promptsManager.internalShowSmsAndEmailSlidedown({...e})}addEventListener(e,t){v.emitter.on(e,t)}removeEventListener(e,t){v.emitter.off(e,t)}}let v=class R{static EVENTS=xo;static async _initializeCoreModuleAndOSNamespaces(){const e=new no;await e.init(),R.coreDirector=new so(e);const t=await u.getSubscription(),i=await R.context.permissionManager.getPermissionStatus();R.User=new gt(!0,t,i),this.Notifications=new yn(i)}static async _initializeConfig(e){const t=await ts(e);a.debug("OneSignal: Final web app config:",t),R.config=t,R.environmentInfo=di.getEnvironmentInfo(),R.context=new No(t),R.config=R.context.appConfig}static async login(e,t){if(I("login",{externalId:e,jwtToken:t}),typeof e>"u")throw new _("externalId",N.Empty);if(typeof e!="string")throw new _("externalId",N.WrongType);if(t!==void 0&&typeof t!="string")throw new _("jwtToken",N.WrongType);await ve.login(e,t)}static async logout(){I("logout"),await ve.logout()}static async init(e){if(I("init"),a.debug(`Browser Environment: ${P().name} ${P().version}`),ft.removeLegacySubscriptionOptions(),$.errorIfInitAlreadyCalled(),await R._initializeConfig(e),!R.config)throw new Error("OneSignal config not initialized!");if(P().name=="safari"&&!R.config.safariWebId){a.warn(new he(Q.MissingSafariWebId));return}if(await R._initializeCoreModuleAndOSNamespaces(),ft.getConsentRequired()&&!await u.getConsentGiven()){R.pendingInit=!0;return}await R._delayedInit()}static async _delayedInit(){R.pendingInit=!1,R.context.workerMessenger.listen();async function e(){R.__initAlreadyCalled||(R.__initAlreadyCalled=!0,R.emitter.on(R.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,Y.onNotificationPermissionChange),R.emitter.on(R.EVENTS.SUBSCRIPTION_CHANGED,Y._onSubscriptionChanged),R.emitter.on(R.EVENTS.SDK_INITIALIZED,$.onSdkInitialized),window.addEventListener("focus",()=>{F.checkAndTriggerNotificationPermissionChanged()}),await $.initSaveState(),await $.saveInitOptions(),await $.internalInit())}document.readyState==="complete"||document.readyState==="interactive"?await e():(a.debug("OneSignal: Waiting for DOMContentLoaded or readyStateChange event before continuing initialization..."),window.addEventListener("DOMContentLoaded",()=>{e()}),document.onreadystatechange=()=>{(document.readyState==="complete"||document.readyState==="interactive")&&e()})}static async setConsentGiven(e){if(I("setConsentGiven",{consent:e}),typeof e>"u")throw new _("consent",N.Empty);if(typeof e!="boolean")throw new _("consent",N.WrongType);await u.setConsentGiven(e),e&&R.pendingInit&&await R._delayedInit()}static async setConsentRequired(e){if(I("setConsentRequired",{requiresConsent:e}),typeof e>"u")throw new _("requiresConsent",N.Empty);if(typeof e!="boolean")throw new _("requiresConsent",N.WrongType);ft.setConsentRequired(e)}static async push(e){return ko.processItem(R,e)}static __doNotShowWelcomeNotification;static VERSION=re;static environmentInfo;static config=null;static _sessionInitAlreadyRunning=!1;static _isNewVisitor=!1;static timedLocalStorage=ze;static initialized=!1;static _didLoadITILibrary=!1;static notifyButton=null;static database=u;static event=O;static pendingInit=!0;static emitter=new jt;static cache={};static _LOGGING=!1;static LOGGING=!1;static _initCalled=!1;static __initAlreadyCalled=!1;static context;static coreDirector;static _notifications;static get Notifications(){return this._notifications||(this._notifications=new yn),this._notifications}static set Notifications(e){this._notifications=e}static Slidedown=new Ro;static Session=new Mo;static User=new gt(!1);static Debug=new Ao};a.info(`OneSignal Web SDK loaded (version ${re},
  ${Lt} environment).`),a.debug(`Current Page URL: ${typeof location>"u"?"NodeJS":location.href}`);class _o{static async processOneSignalDeferredArray(e){for(const t of e)try{await v.push(t)}catch(i){a.error(i)}}}function Do(){if(fs(),Ii()>1){a.warn("OneSignal: The web push SDK is included more than once. For optimal performance, please include our SDK only once on your page."),a.debug(`OneSignal: Exiting from SDK initialization to prevent double-initialization errors. Occurred ${Ii()} times.`);return}window.OneSignal=v,window.OneSignalDeferred=window.OneSignalDeferred??[];const o=_o.processOneSignalDeferredArray(window.OneSignalDeferred);Object.defineProperty(window.OneSignalDeferred,"push",{value:async function(e){return await o,v.push(e)}})}Do()})();
//# sourceMappingURL=OneSignalSDK.page.es6.js.map
