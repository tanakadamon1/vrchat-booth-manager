<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRChat Boothå•†å“ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1f2937;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #374151;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3px;
        }
        @media (min-width: 1000px) {
            .list {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
        }
        .list-item {
            background-color: #374151;
            border-radius: 4px;
            padding: 6px;
            display: flex;
            align-items: flex-start;
            gap: 6px;
            min-height: 52px;
            position: relative;
        }
        .list-item .item-checkbox {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 12px;
            height: 12px;
        }
        .list-item .item-thumbnail {
            width: 48px;
            height: 36px;
            background-color: #4b5563;
            border-radius: 3px;
            flex-shrink: 0;
            margin-left: 10px;
            margin-top: 2px;
        }
        .list-item .item-content {
            flex: 1;
            min-width: 0;
        }
        .list-item .item-title {
            font-size: 14px;
            font-weight: bold;
            margin: 0 0 2px 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            word-break: break-word;
        }
        .list-item .item-info {
            font-size: 12px;
            color: #9ca3af;
            margin: 0;
        }
        .list-item .item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 2px;
        }
        .list-item .item-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .card {
            background-color: #374151;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .card-image {
            width: 100%;
            height: 150px;
            background-color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .card-content {
            padding: 15px;
            background-color: #374151;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .card-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.3;
            min-height: 36px;
            max-height: 52px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word;
        }
        .buttons {
            display: flex;
            gap: 5px;
        }
        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            min-width: 50px;
        }
        .btn-blue { background-color: #2563eb; }
        .btn-yellow { background-color: #d97706; }
        .btn-red { background-color: #dc2626; }
        .btn:hover { opacity: 0.8; }
        .add-btn {
            background-color: #16a34a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            position: relative;
            margin: 50px auto;
            background-color: #374151;
            padding: 20px;
            border-radius: 6px;
            width: 800px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #4b5563;
            border-radius: 4px;
            background-color: #4b5563;
            color: white;
            box-sizing: border-box;
        }
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .form-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-btn-cancel {
            background-color: #6b7280;
            color: white;
        }
        .form-btn-submit {
            background-color: #2563eb;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <h1>VRChat Boothå•†å“ç®¡ç†</h1>
                <button onclick="showHelpModal()" style="width: 24px; height: 24px; border-radius: 50%; background-color: #6b7280; color: white; border: none; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;" title="ä½¿ã„æ–¹ã‚’è¡¨ç¤º" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='#6b7280'">?</button>
                <button onclick="showSettingsModal()" style="width: 24px; height: 24px; border-radius: 50%; background-color: #6b7280; color: white; border: none; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;" title="è¨­å®š" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='#6b7280'">âš™</button>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="position: relative;">
                    <input type="text" id="searchInput" placeholder="å•†å“åãƒ»èª¬æ˜æ–‡ã§æ¤œç´¢..." onkeyup="searchProducts()" style="padding: 6px 12px; background-color: #4b5563; color: white; border: 1px solid #6b7280; border-radius: 4px; font-size: 13px; width: 250px; height: 32px; box-sizing: border-box;">
                    <button onclick="clearSearch()" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 16px;">Ã—</button>
                </div>
                <button class="add-btn" onclick="addProduct()">å•†å“ã‚’è¿½åŠ </button>
            </div>
        </div>
        
        <div style="margin-bottom: 20px; display: flex; align-items: flex-start; gap: 25px; flex-wrap: wrap;">
            <div>
                <label style="color: white; font-weight: bold; display: block; margin-bottom: 6px;">è¡¨ç¤ºã‚«ãƒ†ã‚´ãƒª:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_avatar" value="ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_costume" value="è¡£è£…" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">è¡£è£…</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_accessory" value="ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_hair" value="é«ªå‹" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">é«ªå‹</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_other" value="ãã®ä»–" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">ãã®ä»–</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_tool" value="ãƒ„ãƒ¼ãƒ«" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">ãƒ„ãƒ¼ãƒ«</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_pose" value="ãƒãƒ¼ã‚º" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">ãƒãƒ¼ã‚º</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 4px; color: white; cursor: pointer;">
                        <input type="checkbox" id="filter_world" value="ãƒ¯ãƒ¼ãƒ«ãƒ‰" onchange="filterProducts()" checked style="width: 14px; height: 14px;">
                        <span style="font-size: 13px;">ãƒ¯ãƒ¼ãƒ«ãƒ‰</span>
                    </label>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 12px; width: 100%;">
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 6px; min-width: fit-content;">
                        <label for="avatarSelect" style="color: white; font-size: 13px; font-weight: 500; white-space: nowrap;">å¯¾å¿œã‚¢ãƒã‚¿ãƒ¼:</label>
                        <select id="avatarSelect" onchange="filterProducts()" style="padding: 6px 10px; background-color: #374151; color: white; border: 1px solid #4b5563; border-radius: 4px; font-size: 13px; min-width: 120px; height: 32px;">
                            <option value="all">ã™ã¹ã¦</option>
                            <!-- ã‚¢ãƒã‚¿ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; min-width: fit-content;">
                        <label for="tagSelect" style="color: white; font-size: 13px; font-weight: 500; white-space: nowrap;">ã‚¿ã‚°:</label>
                        <select id="tagSelect" onchange="filterProducts()" style="padding: 6px 10px; background-color: #374151; color: white; border: 1px solid #4b5563; border-radius: 4px; font-size: 13px; min-width: 120px; height: 32px;">
                            <option value="all">ã™ã¹ã¦</option>
                            <!-- ã‚¿ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; min-width: fit-content;">
                        <label for="orderSelect" style="color: white; font-size: 13px; font-weight: 500; white-space: nowrap;">ä¸¦ã³é †:</label>
                        <select id="orderSelect" onchange="filterProducts()" style="padding: 6px 10px; background-color: #374151; color: white; border: 1px solid #4b5563; border-radius: 4px; font-size: 13px; min-width: 120px; height: 32px;">
                            <option value="created_desc">æ–°ã—ã„é †</option>
                            <option value="created_asc">å¤ã„é †</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                    <button id="gridViewBtn" onclick="switchToGridView()" style="padding: 6px; background-color: #4b5563; color: white; border: 1px solid #6b7280; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;" title="ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <rect x="1" y="1" width="6" height="6" rx="1"/>
                            <rect x="9" y="1" width="6" height="6" rx="1"/>
                            <rect x="1" y="9" width="6" height="6" rx="1"/>
                            <rect x="9" y="9" width="6" height="6" rx="1"/>
                        </svg>
                    </button>
                    <button id="listViewBtn" onclick="switchToListView()" style="padding: 6px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 32px; height: 32px;" title="ãƒªã‚¹ãƒˆè¡¨ç¤º">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                            <rect x="2" y="3" width="2" height="2" rx="1"/>
                            <rect x="6" y="3" width="8" height="2" rx="1"/>
                            <rect x="2" y="7" width="2" height="2" rx="1"/>
                            <rect x="6" y="7" width="8" height="2" rx="1"/>
                            <rect x="2" y="11" width="2" height="2" rx="1"/>
                            <rect x="6" y="11" width="8" height="2" rx="1"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
        <div id="dropZone" style="border: 2px dashed #4b5563; border-radius: 6px; padding: 40px; text-align: center; margin-bottom: 20px; background-color: #374151; display: none; transition: all 0.3s ease;">
            <div style="font-size: 48px; margin-bottom: 16px;">â¬‡ï¸</div>
            <p style="color: #9ca3af; margin: 0; font-size: 18px; font-weight: 600;">ğŸ“¦ ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦å•†å“ã‚’ç™»éŒ²</p>
            <p style="color: #6b7280; margin: 8px 0 0 0; font-size: 14px;">.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
        </div>

        <!-- ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="dragOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 9999; display: none; pointer-events: none;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white;">
                <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ“¦</div>
                <h2 style="font-size: 28px; margin: 0 0 10px 0; color: #60a5fa;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ç™»éŒ²</h2>
                <p style="font-size: 16px; margin: 0; color: #d1d5db;">.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€ã‚’é›¢ã—ã¦ãã ã•ã„</p>
            </div>
        </div>
        
        
        <!-- é¸æŠæ™‚ã®ã‚¿ã‚°ç·¨é›†ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä¸‹éƒ¨å›ºå®šï¼‰ -->
        <div id="selectionBlock" style="opacity: 0; visibility: hidden; transform: translateY(100%); position: fixed; bottom: 0; left: 0; right: 0; background-color: #374151; padding: 12px; border-top: 2px solid #4b5563; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4); z-index: 100; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, visibility 0.3s;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <span style="color: white; font-weight: 600; font-size: 13px;"><span id="selectedCount">0</span>å€‹é¸æŠä¸­</span>
                <div style="display: flex; gap: 6px;">
                    <button onclick="deleteSelectedProducts()" style="padding: 6px 12px; background-color: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; height: 32px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#b91c1c'" onmouseout="this.style.backgroundColor='#dc2626'">é¸æŠã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤</button>
                    <button onclick="clearSelection()" style="padding: 6px 12px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; height: 32px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#4b5563'" onmouseout="this.style.backgroundColor='#6b7280'">é¸æŠã‚’è§£é™¤</button>
                </div>
            </div>
            
            <!-- ã‚¿ã‚°ç·¨é›†ã‚¨ãƒªã‚¢ -->
            <div style="background-color: #4b5563; border-radius: 4px; padding: 8px;">
                <label style="color: #d1d5db; font-size: 11px; margin-bottom: 6px; display: block; font-weight: 500;">ã‚¿ã‚°ç·¨é›†</label>
                
                <!-- é¸æŠæ¸ˆã¿ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="selectedTagsArea" style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; min-height: 20px; align-items: flex-start; background-color: #374151; border-radius: 3px; padding: 6px; border: 1px solid #6b7280;">
                </div>
                
                <!-- ã‚¿ã‚°å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div style="display: flex; gap: 6px; align-items: center;">
                    <div style="position: relative; flex: 1; max-width: 250px;">
                        <input type="text" id="tagInput" placeholder="ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦Enterã¾ãŸã¯+ãƒœã‚¿ãƒ³" style="width: 100%; padding: 6px 8px; background-color: #374151; color: white; border: 1px solid #6b7280; border-radius: 4px; font-size: 12px; box-sizing: border-box; transition: border-color 0.2s;" 
                               onkeydown="handleTagInput(event)" 
                               oninput="showTagSuggestions(this.value)"
                               onfocus="showTagSuggestions(this.value); this.style.borderColor='#059669'"
                               onblur="setTimeout(() => hideTagSuggestions(), 100); this.style.borderColor='#6b7280'">
                        
                        <!-- ã‚¿ã‚°å€™è£œãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
                        <div id="tagSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: #374151; border: 1px solid #6b7280; border-radius: 4px; max-height: 120px; overflow-y: auto; z-index: 200; margin-top: 2px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
                        </div>
                    </div>
                    
                    <!-- ã‚¿ã‚°è¿½åŠ ãƒœã‚¿ãƒ³ -->
                    <button onclick="addTagFromInput()" style="padding: 6px 12px; background-color: #0369a1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; height: 32px; transition: background-color 0.2s; display: flex; align-items: center; gap: 2px;" onmouseover="this.style.backgroundColor='#0284c7'" onmouseout="this.style.backgroundColor='#0369a1'">
                        <span style="font-size: 14px; line-height: 1;">+</span>è¿½åŠ 
                    </button>
                    
                    <!-- é©ç”¨ãƒœã‚¿ãƒ³ -->
                    <button onclick="applyTagsToSelected()" style="padding: 6px 12px; background-color: #059669; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#047857'" onmouseout="this.style.backgroundColor='#059669'">
                        é¸æŠã—ãŸå•†å“ã«ã‚¿ã‚°ã‚’é©ç”¨
                    </button>
                </div>
            </div>
        </div>
        
        <div id="products" class="grid" style="padding-bottom: 20px;">
            <!-- å•†å“ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- å•†å“è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">å•†å“ã‚’è¿½åŠ </h2>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">å•†å“å *</label>
                    <input type="text" id="productName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="productCategory" name="category">
                        <option value="ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“">ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“</option>
                        <option value="è¡£è£…">è¡£è£…</option>
                        <option value="ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼">ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼</option>
                        <option value="é«ªå‹">é«ªå‹</option>
                        <option value="ãƒ„ãƒ¼ãƒ«">ãƒ„ãƒ¼ãƒ«</option>
                        <option value="ãƒãƒ¼ã‚º">ãƒãƒ¼ã‚º</option>
                        <option value="ãƒ¯ãƒ¼ãƒ«ãƒ‰">ãƒ¯ãƒ¼ãƒ«ãƒ‰</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productBoothUrl">Booth URL</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="url" id="productBoothUrl" name="booth_url" placeholder="https://booth.pm/..." style="flex: 1;">
                        <button type="button" onclick="searchBoothForCurrentFile()" class="form-btn" style="background-color: #2563eb;">Boothæ¤œç´¢</button>
                        <button type="button" onclick="fetchThumbnail()" class="form-btn form-btn-submit">ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productThumbnailUrl">ã‚µãƒ ãƒã‚¤ãƒ« URL</label>
                    <input type="url" id="productThumbnailUrl" name="thumbnail_url" oninput="showThumbnailPreview(this.value)" onchange="showThumbnailPreview(this.value)">
                    <!-- ã‚µãƒ ãƒã‚¤ãƒ« ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                    <div id="thumbnailPreview" style="margin-top: 8px; display: none;">
                        <img id="thumbnailImage" style="max-width: 200px; max-height: 200px; border-radius: 4px; border: 1px solid #6b7280;" alt="ã‚µãƒ ãƒã‚¤ãƒ« ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" draggable="false">
                    </div>
                </div>
                <div class="form-group">
                    <label for="productFilePath">ãƒ•ã‚¡ã‚¤ãƒ« <span id="selectedFileInfo" style="font-size: 11px; color: #9ca3af;"></span></label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="productFilePath" name="file_path" style="flex: 1;" readonly placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰">
                        <button type="button" onclick="selectMultipleFiles()" class="form-btn form-btn-submit" style="min-width: 120px;">
                            ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                        </button>
                    </div>
                    <!-- è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="multipleFilesArea" style="margin-top: 12px; display: none;">
                        <label style="font-size: 13px; color: #d1d5db; margin-bottom: 8px; display: block; font-weight: 500;">
                            ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ 
                            <span style="font-size: 11px; color: #9ca3af; font-weight: normal;">ï¼ˆå„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºåã‚’è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™ï¼‰</span>
                        </label>
                        <div id="filesList" style="max-height: 150px; overflow-y: auto; border: 1px solid #6b7280; border-radius: 6px; padding: 8px; background-color: #374151;">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productAvatars">å¯¾å¿œã‚¢ãƒã‚¿ãƒ¼</label>
                    <div id="avatarCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid #4b5563; border-radius: 4px; padding: 10px; background-color: #4b5563;">
                        <!-- ã‚¢ãƒã‚¿ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="productTags">ã‚¿ã‚°</label>
                    <div id="tagCheckboxes" style="max-height: 120px; overflow-y: auto; border: 1px solid #4b5563; border-radius: 4px; padding: 10px; background-color: #4b5563; margin-bottom: 10px;">
                        <!-- ã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newTagInput" placeholder="æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ " onkeypress="if(event.key==='Enter'){addNewTag();}" style="flex: 1; padding: 6px 8px; border: 1px solid #4b5563; border-radius: 4px; background-color: #4b5563; color: white; font-size: 12px;">
                        <button type="button" onclick="addNewTag()" style="padding: 6px 12px; background-color: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">è¿½åŠ </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productDescription">èª¬æ˜</label>
                    <textarea id="productDescription" name="description" rows="3"></textarea>
                </div>
                <div class="form-buttons">
                    <button type="button" onclick="closeModal()" class="form-btn form-btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="form-btn form-btn-submit">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let products = [];
        let avatars = [];
        let currentSort = 'created_desc';
        let currentSortOrder = 'created_desc'; // ç¾åœ¨ã®ä¸¦ã³é †ã‚’ä¿æŒ
        let searchQuery = '';
        let isListView = false;
        let selectedProducts = new Set();

        // Electronã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function loadProducts() {
            try {
                if (window.electronAPI) {
                    products = await window.electronAPI.database.getProducts();
                    avatars = await window.electronAPI.database.getAvatars();
                    console.log('Loaded products:', products);
                    console.log('Loaded avatars:', avatars);
                    filterProducts();
                }
            } catch (error) {
                console.error('Failed to load products:', error);
            }
        }

        // å…¨ã‚¢ãƒã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getAllAvatars() {
            // ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“ã‚«ãƒ†ã‚´ãƒªã®å•†å“ã‚‚å«ã‚ãŸå…¨ã‚¢ãƒã‚¿ãƒ¼ã‚’å–å¾—
            const allAvatars = [...avatars];
            
            // ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“ã‚«ãƒ†ã‚´ãƒªã®å•†å“ã‚’ã‚¢ãƒã‚¿ãƒ¼ã¨ã—ã¦è¿½åŠ 
            const avatarProducts = products.filter(product => product.category === 'ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“');
            avatarProducts.forEach(product => {
                // æ—¢ã«åŒã˜IDã¾ãŸã¯åŒã˜åå‰ã®ã‚¢ãƒã‚¿ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¿½åŠ 
                if (!allAvatars.find(avatar => avatar.id === product.id || avatar.name === product.name)) {
                    allAvatars.push({
                        id: product.id,
                        name: product.name,
                        thumbnail_url: product.thumbnail_url
                    });
                }
            });
            
            return allAvatars;
        }

        // ã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
        function updateAvatarSelects() {
            const allAvatars = getAllAvatars();
            
            // å•†å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ã‚¢ãƒã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const avatarCheckboxes = document.getElementById('avatarCheckboxes');
            avatarCheckboxes.innerHTML = '';
            
            if (allAvatars.length === 0) {
                avatarCheckboxes.innerHTML = '<p style="color: #9ca3af; margin: 0;">ã‚¢ãƒã‚¿ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            } else {
                allAvatars.forEach(avatar => {
                    const label = document.createElement('label');
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '8px';
                    label.style.color = 'white';
                    label.style.cursor = 'pointer';
                    label.style.marginBottom = '5px';
                    
                    label.innerHTML = `
                        <input type="checkbox" value="${avatar.id}" style="width: 16px; height: 16px;">
                        <span>${avatar.name}</span>
                    `;
                    
                    avatarCheckboxes.appendChild(label);
                });
            }
            
            updateTagCheckboxes();
            updateAvatarFilterSelect();
        }
        
        // ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        function updateTagCheckboxes() {
            const allTags = getAllTags();
            
            // å•†å“ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const tagCheckboxes = document.getElementById('tagCheckboxes');
            tagCheckboxes.innerHTML = '';
            
            if (allTags.length === 0) {
                tagCheckboxes.innerHTML = '<p style="color: #9ca3af; margin: 0;">ã¾ã ã‚¿ã‚°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
            } else {
                allTags.forEach(tag => {
                    const label = document.createElement('label');
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '8px';
                    label.style.color = 'white';
                    label.style.cursor = 'pointer';
                    label.style.marginBottom = '5px';
                    
                    label.innerHTML = `
                        <input type="checkbox" value="${tag}" style="width: 16px; height: 16px;">
                        <span>${tag}</span>
                    `;
                    
                    tagCheckboxes.appendChild(label);
                });
            }
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®ã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢ã®ã¿ã‚’æ›´æ–°
        function updateAvatarFilterSelect() {
            const allAvatars = getAllAvatars();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®ã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢ã‚’æ›´æ–°
            const avatarSelect = document.getElementById('avatarSelect');
            const currentValue = avatarSelect.value; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã‚’ä¿æŒ
            avatarSelect.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
            
            allAvatars.forEach(avatar => {
                const option = document.createElement('option');
                option.value = avatar.id;
                option.textContent = avatar.name;
                avatarSelect.appendChild(option);
            });
            
            // é¸æŠå€¤ã‚’å¾©å…ƒ
            if (currentValue) {
                avatarSelect.value = currentValue;
            }
        }
        
        // å…¨å•†å“ã‹ã‚‰ã‚¿ã‚°ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getAllTags() {
            const allTags = new Set();
            
            products.forEach(product => {
                if (product.tags && product.tags.trim() !== '') {
                    const productTags = product.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                    productTags.forEach(tag => allTags.add(tag));
                }
            });
            
            return Array.from(allTags).sort();
        }
        
        // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚’æ›´æ–°
        function updateTagFilterSelect() {
            const allTags = getAllTags();
            
            // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ã®é¸æŠè‚¢ã‚’æ›´æ–°
            const tagSelect = document.getElementById('tagSelect');
            const currentValue = tagSelect.value; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã‚’ä¿æŒ
            tagSelect.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
            
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagSelect.appendChild(option);
            });
            
            // é¸æŠå€¤ã‚’å¾©å…ƒ
            if (currentValue && allTags.includes(currentValue)) {
                tagSelect.value = currentValue;
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        function filterProducts() {
            // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
            const checkedCategories = [];
            const checkboxes = ['filter_avatar', 'filter_costume', 'filter_accessory', 'filter_hair', 'filter_other', 'filter_tool', 'filter_pose', 'filter_world'];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    checkedCategories.push(checkbox.value);
                }
            });
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredProducts = products.filter(product => {
                return checkedCategories.includes(product.category);
            });
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (searchQuery) {
                filteredProducts = filteredProducts.filter(product => {
                    const searchFields = [
                        product.name || '',
                        product.description || '',
                        product.tags || ''
                    ].join(' ').toLowerCase();
                    
                    return searchFields.includes(searchQuery);
                });
            }
            
            // ã‚¢ãƒã‚¿ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const selectedAvatar = document.getElementById('avatarSelect')?.value;
            if (selectedAvatar && selectedAvatar !== 'all') {
                filteredProducts = filteredProducts.filter(product => {
                    if (!product.avatar_ids || product.avatar_ids.trim() === '') return false;
                    const avatarIds = product.avatar_ids.split(',').map(id => id.trim()).filter(id => id);
                    return avatarIds.includes(selectedAvatar);
                });
            }
            
            // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const selectedTag = document.getElementById('tagSelect')?.value;
            if (selectedTag && selectedTag !== 'all') {
                filteredProducts = filteredProducts.filter(product => {
                    if (!product.tags || product.tags.trim() === '') return false;
                    const productTags = product.tags.split(',').map(tag => tag.trim()).filter(tag => tag);
                    return productTags.includes(selectedTag);
                });
            }
            
            // ä¸¦ã³é †é©ç”¨
            const orderSelect = document.getElementById('orderSelect');
            if (orderSelect) {
                currentSortOrder = orderSelect.value; // ç¾åœ¨ã®ä¸¦ã³é †ã‚’ä¿å­˜
            }
            const orderType = currentSortOrder || 'created_desc';
            
            filteredProducts.sort((a, b) => {
                switch (orderType) {
                    case 'created_desc':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'created_asc':
                        return new Date(a.created_at) - new Date(b.created_at);
                    default:
                        return 0;
                }
            });
            
            renderProducts(filteredProducts);
            
            // ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®é¸æŠè‚¢ã¯å¸¸ã«æ›´æ–°
            updateAvatarFilterSelect();
            updateTagFilterSelect();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ãªã„å ´åˆã®ã¿ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ã‚¢ãƒã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            const productModal = document.getElementById('productModal');
            if (!productModal || productModal.style.display !== 'block') {
                updateAvatarSelects();
            }
        }

        // å•†å“ä¸€è¦§ã‚’è¡¨ç¤º
        function renderProducts(productsToRender = products) {
            const container = document.getElementById('products');
            container.innerHTML = '';
            container.className = isListView ? 'list' : 'grid';
            
            productsToRender.forEach(product => {
                const item = document.createElement('div');
                item.className = isListView ? 'list-item' : 'card';
                
                if (isListView) {
                    item.innerHTML = `
                        <input type="checkbox" class="item-checkbox" ${selectedProducts.has(product.id) ? 'checked' : ''} readonly>
                        <div class="item-thumbnail" onclick="toggleProductSelection(${product.id})">
                            ${product.thumbnail_url ? 
                                `<img src="${product.thumbnail_url}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;" draggable="false">` : 
                                '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9ca3af; font-size: 12px;">ç”»åƒãªã—</div>'
                            }
                        </div>
                        <div class="item-content" onclick="openProductDetail(${product.id})">
                            <div class="item-title" title="${product.name}">${product.name}</div>
                            <div class="item-info">ã‚«ãƒ†ã‚´ãƒª: ${product.category}</div>
                        </div>
                        <div class="item-actions">
                            ${product.file_path ? 
                                `<button class="btn btn-blue" onclick="openFile(event, '${product.file_path.replace(/\\/g, '\\\\')}', ${product.id})">Unity${product.file_paths && product.file_paths.includes('|') ? ' â–¼' : ''}</button>` : ''
                            }
                            <button class="btn btn-yellow" onclick="editProduct(event, ${product.id})">ç·¨é›†</button>
                            <button class="btn btn-red" onclick="deleteProduct(event, ${product.id})">å‰Šé™¤</button>
                        </div>
                    `;
                } else {
                    item.innerHTML = `
                        <input type="checkbox" class="item-checkbox" ${selectedProducts.has(product.id) ? 'checked' : ''} readonly style="position: absolute; top: 8px; left: 8px; width: 16px; height: 16px; z-index: 10;">
                        <div class="card-image" onclick="toggleProductSelection(${product.id})">
                            ${product.thumbnail_url ? 
                                `<img src="${product.thumbnail_url}" alt="${product.name}" draggable="false">` : 
                                '<span style="color: #9ca3af;">ç”»åƒãªã—</span>'
                            }
                        </div>
                        <div class="card-content" onclick="openProductDetail(${product.id})">
                            <div class="card-title" title="${product.name}">${product.name}</div>
                            <div class="buttons">
                                ${product.file_path ? 
                                    `<button class="btn btn-blue" onclick="openFile(event, '${product.file_path.replace(/\\/g, '\\\\')}', ${product.id})">Unity${product.file_paths && product.file_paths.includes('|') ? ' â–¼' : ''}</button>` : ''
                                }
                                <button class="btn btn-yellow" onclick="editProduct(event, ${product.id})">ç·¨é›†</button>
                                <button class="btn btn-red" onclick="deleteProduct(event, ${product.id})">å‰Šé™¤</button>
                            </div>
                        </div>
                    `;
                }
                
                container.appendChild(item);
            });
            
            updateSelectionBlock();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
        async function openFile(event, filePath, productId) {
            if (event) event.stopPropagation();
            
            console.log('openFile called with:', { filePath, productId });
            
            if (!filePath || filePath.trim() === '') {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¤å•†å“ã®å ´åˆã€é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            if (productId) {
                try {
                    const products = await window.electronAPI.database.getProducts();
                    const product = products.find(p => p.id === productId);
                    if (product && product.file_paths && product.file_paths.includes('|')) {
                        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                        showFileSelectionMenu(event, product);
                        return;
                    }
                } catch (error) {
                    console.error('å•†å“ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            if (window.electronAPI) {
                try {
                    console.log('Opening file:', filePath);
                    console.log('File path length:', filePath.length);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
                    const fileExists = await window.electronAPI.fs.exists(filePath);
                    console.log('File exists check:', fileExists);
                    
                    if (!fileExists) {
                        alert(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${filePath}`);
                        return;
                    }
                    
                    await window.electronAPI.shell.openFile(filePath);
                } catch (error) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                    console.error('Failed file path:', filePath);
                    
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
                    if (error.message && error.message.includes('Unity')) {
                        alert(error.message);
                    } else {
                        alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ:\n${error.message || error}\n\nå¯¾å‡¦æ³•:\n1. Unity HubãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª\n2. Unityãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„`);
                    }
                }
            } else {
                alert('Electron APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
        }

        let currentEditingProductId = null;
        
        // æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ 
        function addNewTag() {
            const newTagInput = document.getElementById('newTagInput');
            const newTag = newTagInput.value.trim();
            
            if (newTag === '') {
                alert('ã‚¿ã‚°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // æ—¢å­˜ã‚¿ã‚°ã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const allTags = getAllTags();
            if (allTags.includes(newTag)) {
                alert('æ—¢ã«å­˜åœ¨ã™ã‚‹ã‚¿ã‚°ã§ã™');
                return;
            }
            
            // æ–°ã—ã„ã‚¿ã‚°ã‚’æ‰‹å‹•ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒªã‚¹ãƒˆã«è¿½åŠ 
            const tagCheckboxes = document.getElementById('tagCheckboxes');
            
            // æ—¢å­˜ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            if (tagCheckboxes.innerHTML.includes('ã¾ã ã‚¿ã‚°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“')) {
                tagCheckboxes.innerHTML = '';
            }
            
            // æ–°ã—ã„ã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.gap = '8px';
            label.style.color = 'white';
            label.style.cursor = 'pointer';
            label.style.marginBottom = '5px';
            
            label.innerHTML = `
                <input type="checkbox" value="${newTag}" checked style="width: 16px; height: 16px;">
                <span>${newTag}</span>
            `;
            
            tagCheckboxes.appendChild(label);
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            newTagInput.value = '';
            
            console.log('æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', newTag);
        }
        
        // æ¤œç´¢æ©Ÿèƒ½
        function searchProducts() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            filterProducts();
        }
        
        // æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchQuery = '';
            filterProducts();
        }

        // è©³ç´°ç”»é¢ã‹ã‚‰ç·¨é›†
        function editProductFromDetail(event, productId) {
            event.stopPropagation();
            closeDetailModal(); // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            editProduct(event, productId);
        }

        // å•†å“ã‚’ç·¨é›†
        function editProduct(event, productId) {
            event.stopPropagation();
            const product = products.find(p => p.id === productId);
            if (product) {
                currentEditingProductId = productId;
                document.getElementById('modalTitle').textContent = 'å•†å“ã‚’ç·¨é›†';
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productBoothUrl').value = product.booth_url || '';
                document.getElementById('productThumbnailUrl').value = product.thumbnail_url || '';
                showThumbnailPreview(product.thumbnail_url || '');
                document.getElementById('productFilePath').value = product.file_path || '';
                
                // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã®è¡¨ç¤º
                console.log('ç·¨é›†ä¸­ã®å•†å“:', product);
                console.log('file_paths:', product.file_paths);
                
                if (product.file_paths && product.file_paths.includes('|')) {
                    const filePaths = product.file_paths.split('|').filter(path => path.trim());
                    const displayNames = product.display_names ? product.display_names.split('|').filter(name => name.trim()) : null;
                    console.log('è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º:', filePaths);
                    console.log('è¡¨ç¤ºå:', displayNames);
                    displayMultipleFiles(filePaths, displayNames);
                } else if (product.file_paths && product.file_paths.trim()) {
                    // file_pathsãŒã‚ã‚‹ãŒåŒºåˆ‡ã‚Šæ–‡å­—ãŒãªã„å ´åˆï¼ˆå˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
                    const filePaths = [product.file_paths.trim()];
                    const displayNames = product.display_names ? [product.display_names.trim()] : null;
                    console.log('å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆfile_pathsã‹ã‚‰ï¼‰:', filePaths);
                    displayMultipleFiles(filePaths, displayNames);
                } else {
                    // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
                    console.log('è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã€ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º');
                    document.getElementById('multipleFilesArea').style.display = 'none';
                }
                
                document.getElementById('productDescription').value = product.description || '';
                
                // å¯¾å¿œã‚¢ãƒã‚¿ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
                const productAvatarIds = product.avatar_ids ? product.avatar_ids.split(',').map(id => id.trim()).filter(id => id) : [];
                const avatarCheckboxes = document.querySelectorAll('#avatarCheckboxes input[type="checkbox"]');
                avatarCheckboxes.forEach(checkbox => {
                    checkbox.checked = productAvatarIds.includes(checkbox.value);
                });
                
                // ã‚¿ã‚°ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
                const productTags = product.tags ? product.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                const tagCheckboxes = document.querySelectorAll('#tagCheckboxes input[type="checkbox"]');
                tagCheckboxes.forEach(checkbox => {
                    checkbox.checked = productTags.includes(checkbox.value);
                });
                
                document.getElementById('productModal').style.display = 'block';
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                setTimeout(() => {
                    const nameInput = document.getElementById('productName');
                    if (nameInput) {
                        nameInput.focus();
                        nameInput.select(); // ç·¨é›†æ™‚ã¯å…¨é¸æŠ
                    }
                }, 100);
            }
        }

        // å•†å“ã‚’å‰Šé™¤
        async function deleteProduct(event, productId) {
            event.stopPropagation();
            if (confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    if (window.electronAPI) {
                        await window.electronAPI.database.deleteProduct(productId);
                        await loadProducts();
                        console.log('Product deleted:', productId);
                    }
                } catch (error) {
                    console.error('Failed to delete product:', error);
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        }

        // å•†å“ã‚’è¿½åŠ 
        function addProduct() {
            currentEditingProductId = null;
            document.getElementById('modalTitle').textContent = 'å•†å“ã‚’è¿½åŠ ';
            document.getElementById('productForm').reset();
            
            // ã‚µãƒ ãƒã‚¤ãƒ« ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('thumbnailPreview').style.display = 'none';
            
            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('multipleFilesArea').style.display = 'none';
            
            // ã‚¢ãƒã‚¿ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const avatarCheckboxes = document.querySelectorAll('#avatarCheckboxes input[type="checkbox"]');
            avatarCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // ã‚¿ã‚°ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const tagCheckboxes = document.querySelectorAll('#tagCheckboxes input[type="checkbox"]');
            tagCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.getElementById('productModal').style.display = 'block';
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                const nameInput = document.getElementById('productName');
                if (nameInput) {
                    nameInput.focus();
                }
            }, 100);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            currentEditingProductId = null;
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ã‚ªãƒ—ã‚·ãƒ§ãƒ³é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function showFolderOptionDialog(unityPackageFiles, folderName) {
            return new Promise((resolve) => {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’ä½œæˆ
                const dialogOverlay = document.createElement('div');
                dialogOverlay.id = 'folderOptionOverlay';
                dialogOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const dialogBox = document.createElement('div');
                dialogBox.style.cssText = `
                    background-color: #374151;
                    border-radius: 6px;
                    padding: 24px;
                    max-width: 500px;
                    width: 90%;
                    color: white;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                `;

                const title = document.createElement('h3');
                title.textContent = 'ãƒ•ã‚©ãƒ«ãƒ€ã®å‡¦ç†æ–¹æ³•ã‚’é¸æŠ';
                title.style.cssText = `
                    margin: 0 0 16px 0;
                    font-size: 18px;
                    color: white;
                `;

                const message = document.createElement('p');
                message.innerHTML = `
                    ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folderName}ã€ã«${unityPackageFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚<br><br>
                    <strong>çµ±åˆã™ã‚‹</strong>: 1ã¤ã®å•†å“ã¨ã—ã¦ç™»éŒ²ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™<br>
                    <strong>åˆ†é›¢ã™ã‚‹</strong>: ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«å€‹åˆ¥ã®å•†å“ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™
                `;
                message.style.cssText = `
                    margin: 0 0 24px 0;
                    line-height: 1.5;
                    color: #e5e7eb;
                `;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 12px;
                    justify-content: flex-end;
                `;

                const unifyButton = document.createElement('button');
                unifyButton.textContent = 'çµ±åˆã™ã‚‹';
                unifyButton.style.cssText = `
                    background-color: #3b82f6;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                unifyButton.addEventListener('mouseenter', () => {
                    unifyButton.style.backgroundColor = '#2563eb';
                });
                unifyButton.addEventListener('mouseleave', () => {
                    unifyButton.style.backgroundColor = '#3b82f6';
                });

                const separateButton = document.createElement('button');
                separateButton.textContent = 'åˆ†é›¢ã™ã‚‹';
                separateButton.style.cssText = `
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                `;
                separateButton.addEventListener('mouseenter', () => {
                    separateButton.style.backgroundColor = '#4b5563';
                });
                separateButton.addEventListener('mouseleave', () => {
                    separateButton.style.backgroundColor = '#6b7280';
                });

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                unifyButton.addEventListener('click', () => {
                    document.body.removeChild(dialogOverlay);
                    processFilesAsOneProduct(unityPackageFiles, folderName);
                    resolve('unify');
                });

                separateButton.addEventListener('click', () => {
                    document.body.removeChild(dialogOverlay);
                    processFilesAsSeparateProducts(unityPackageFiles, folderName);
                    resolve('separate');
                });

                // ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(dialogOverlay);
                        document.removeEventListener('keydown', handleEscape);
                        resolve('cancel');
                    }
                };
                document.addEventListener('keydown', handleEscape);

                // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                dialogOverlay.addEventListener('click', (e) => {
                    if (e.target === dialogOverlay) {
                        document.body.removeChild(dialogOverlay);
                        document.removeEventListener('keydown', handleEscape);
                        resolve('cancel');
                    }
                });

                // DOMæ§‹ç¯‰
                buttonContainer.appendChild(unifyButton);
                buttonContainer.appendChild(separateButton);
                dialogBox.appendChild(title);
                dialogBox.appendChild(message);
                dialogBox.appendChild(buttonContainer);
                dialogOverlay.appendChild(dialogBox);
                document.body.appendChild(dialogOverlay);
            });
        }

        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showFileSelectionMenu(event, product) {
            // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
            const existingMenu = document.getElementById('fileSelectionMenu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
            const menu = document.createElement('div');
            menu.id = 'fileSelectionMenu';
            menu.style.cssText = `
                position: absolute;
                background-color: #374151;
                border: 1px solid #4b5563;
                border-radius: 6px;
                padding: 8px 0;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                min-width: 250px;
                max-width: 500px;
                white-space: nowrap;
            `;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¨è¡¨ç¤ºåã‚’å–å¾—
            const filePaths = product.file_paths.split('|').filter(path => path.trim());
            const displayNames = product.display_names ? 
                product.display_names.split('|').filter(name => name.trim()) : 
                filePaths.map(path => path.split(/[/\\]/).pop().replace('.unitypackage', ''));
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¿½åŠ 
            filePaths.forEach((filePath, index) => {
                const menuItem = document.createElement('div');
                menuItem.style.cssText = `
                    padding: 10px 16px;
                    cursor: pointer;
                    color: white;
                    font-size: 14px;
                    transition: background-color 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    white-space: nowrap;
                    overflow: hidden;
                `;
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã¨è¡¨ç¤ºå
                const icon = 'ğŸ“¦';
                const displayName = displayNames[index] || `ãƒ•ã‚¡ã‚¤ãƒ« ${index + 1}`;
                
                // é•·ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’çœç•¥
                const truncatedName = displayName.length > 30 ? 
                    displayName.substring(0, 27) + '...' : 
                    displayName;
                
                menuItem.innerHTML = `
                    <span style="color: #9ca3af; font-size: 14px; flex-shrink: 0;">${icon}</span>
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis;" title="${displayName}">${truncatedName}</span>
                `;
                
                // ãƒ›ãƒãƒ¼åŠ¹æœ
                menuItem.addEventListener('mouseenter', () => {
                    menuItem.style.backgroundColor = '#4b5563';
                });
                menuItem.addEventListener('mouseleave', () => {
                    menuItem.style.backgroundColor = '';
                });
                
                // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
                menuItem.addEventListener('click', async () => {
                    menu.remove();
                    console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', filePath);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
                    const fileExists = await window.electronAPI.fs.exists(filePath);
                    console.log('File exists check:', fileExists);
                    
                    if (!fileExists) {
                        alert(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${filePath}`);
                        return;
                    }
                    
                    await window.electronAPI.shell.openFile(filePath);
                });
                
                menu.appendChild(menuItem);
            });
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½ç½®ã‚’è¨­å®šï¼ˆãƒœã‚¿ãƒ³ã®ä¸‹ã«è¡¨ç¤ºï¼‰
            const button = event.target;
            const rect = button.getBoundingClientRect();
            menu.style.left = `${rect.left}px`;
            menu.style.top = `${rect.bottom + 5}px`;
            
            // ç”»é¢å¤–ã«ã¯ã¿å‡ºã‚‹å ´åˆã®èª¿æ•´
            document.body.appendChild(menu);
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.right > window.innerWidth) {
                menu.style.left = `${window.innerWidth - menuRect.width - 10}px`;
            }
            if (menuRect.bottom > window.innerHeight) {
                menu.style.top = `${rect.top - menuRect.height - 5}px`;
            }
            
            // ã‚¯ãƒªãƒƒã‚¯å¤–ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                const closeMenu = (e) => {
                    if (!menu.contains(e.target) && e.target !== button) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
        function toggleFileSelectMenu() {
            const menu = document.getElementById('fileSelectMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        
        function hideFileSelectMenu() {
            document.getElementById('fileSelectMenu').style.display = 'none';
        }
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('fileSelectMenu');
            const button = e.target.closest('button[onclick*="toggleFileSelectMenu"]');
            if (!button && menu && !menu.contains(e.target)) {
                hideFileSelectMenu();
            }
        });
        
        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼ˆå•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼‰
        async function selectMultipleFiles() {
            if (window.electronAPI) {
                try {
                    const filePaths = await window.electronAPI.dialog.selectMultipleFiles();
                    if (filePaths && filePaths.length > 0) {
                        console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:', filePaths);
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
                        document.getElementById('selectedFileInfo').textContent = `(${filePaths.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«)`;
                        
                        if (filePaths.length === 1) {
                            // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                            document.getElementById('productFilePath').value = filePaths[0];
                            document.getElementById('multipleFilesArea').style.display = 'none';
                        } else {
                            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                            displayMultipleFiles(filePaths);
                            document.getElementById('productFilePath').value = filePaths[0]; // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ã‚¤ãƒ³ã«è¨­å®š
                        }
                    }
                } catch (error) {
                    console.error('Failed to select files:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼ˆçµ±åˆç‰ˆï¼‰
        async function selectFilesOrFolders() {
            if (window.electronAPI && window.electronAPI.dialog.selectFilesOrFolders) {
                try {
                    const result = await window.electronAPI.dialog.selectFilesOrFolders();
                    
                    if (!result || !result.type) {
                        return;
                    }
                    
                    if (result.type === 'folder') {
                        // ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
                        if (result.files && result.files.length > 0) {
                            console.log(`ãƒ•ã‚©ãƒ«ãƒ€ "${result.folderName}" ã‹ã‚‰${result.files.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                            
                            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤º
                            displayMultipleFiles(result.files);
                            
                            // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦è¨­å®š
                            document.getElementById('productFilePath').value = result.files[0];
                            
                            // ãƒ•ã‚©ãƒ«ãƒ€åã‹ã‚‰å•†å“åã‚’æ¨æ¸¬
                            if (!document.getElementById('productName').value) {
                                document.getElementById('productName').value = result.folderName;
                            }
                        } else {
                            alert('é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }
                    } else if (result.type === 'files') {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
                        if (result.files && result.files.length > 0) {
                            if (result.files.length === 1) {
                                document.getElementById('productFilePath').value = result.files[0];
                                document.getElementById('multipleFilesArea').style.display = 'none';
                            } else {
                                displayMultipleFiles(result.files);
                                document.getElementById('productFilePath').value = result.files[0];
                            }
                        }
                    }
                } catch (error) {
                    console.error('Failed to select files or folders:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        async function selectFile() {
            if (window.electronAPI) {
                try {
                    const filePaths = await window.electronAPI.dialog.selectMultipleFiles();
                    if (filePaths && filePaths.length > 0) {
                        if (filePaths.length === 1) {
                            document.getElementById('productFilePath').value = filePaths[0];
                            document.getElementById('multipleFilesArea').style.display = 'none';
                        } else {
                            displayMultipleFiles(filePaths);
                            document.getElementById('productFilePath').value = filePaths[0];
                        }
                    }
                } catch (error) {
                    console.error('Failed to select file:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        }

        // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã¨è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        async function selectFolder() {
            if (window.electronAPI) {
                try {
                    const result = await window.electronAPI.dialog.selectDirectory();
                    if (result && result.folderPath) {
                        if (result.files && result.files.length > 0) {
                            console.log(`ãƒ•ã‚©ãƒ«ãƒ€ "${result.folderName}" ã‹ã‚‰${result.files.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                            
                            // ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã‚’è¡¨ç¤º
                            document.getElementById('selectedFolderInfo').textContent = `(ãƒ•ã‚©ãƒ«ãƒ€: ${result.folderName})`;
                            
                            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤º
                            displayMultipleFiles(result.files);
                            
                            // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦è¨­å®š
                            document.getElementById('productFilePath').value = result.files[0];
                            
                            // ãƒ•ã‚©ãƒ«ãƒ€åã‹ã‚‰å•†å“åã‚’æ¨æ¸¬
                            if (!document.getElementById('productName').value) {
                                document.getElementById('productName').value = result.folderName;
                            }
                            
                            // è©³ç´°ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                            const fileNames = result.files.map(f => f.split(/[/\\]/).pop()).join('\nãƒ»');
                            alert(`ãƒ•ã‚©ãƒ«ãƒ€ "${result.folderName}" ã‹ã‚‰${result.files.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\n\nè¦‹ã¤ã‹ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«:\nãƒ»${fileNames}\n\nå•†å“æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                        } else {
                            alert('é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                        
                        if (result.error) {
                            console.error('ãƒ•ã‚©ãƒ«ãƒ€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', result.error);
                        }
                    }
                } catch (error) {
                    console.error('Failed to select folder:', error);
                    alert('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        }

        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function displayMultipleFiles(filePaths, existingDisplayNames = null) {
            const multipleFilesArea = document.getElementById('multipleFilesArea');
            const filesList = document.getElementById('filesList');
            
            multipleFilesArea.style.display = 'block';
            filesList.innerHTML = '';
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
            window.multipleFileData = filePaths.map((filePath, index) => {
                const originalName = filePath.split(/[/\\]/).pop();
                return {
                    path: filePath,
                    originalName: originalName,
                    displayName: existingDisplayNames && existingDisplayNames[index] ? existingDisplayNames[index] : originalName
                };
            });
            
            filePaths.forEach((filePath, index) => {
                const fileName = filePath.split(/[/\\]/).pop();
                const fileItem = document.createElement('div');
                fileItem.id = `fileItem_${index}`;
                fileItem.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 10px;
                    margin-bottom: 8px;
                    border-radius: 4px;
                    background-color: #4b5563;
                    transition: all 0.2s;
                `;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³
                const fileIcon = document.createElement('span');
                fileIcon.textContent = 'ğŸ“¦';
                fileIcon.style.cssText = 'font-size: 16px; flex-shrink: 0;';
                
                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'flex: 1; display: flex; flex-direction: column; gap: 4px; min-width: 0;';
                
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.value = window.multipleFileData[index].displayName;
                textInput.id = `fileName_${index}`;
                textInput.dataset.index = index;
                textInput.onchange = () => updateFileName(index, textInput.value);
                textInput.onclick = (e) => {
                    e.stopPropagation(); // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’æ­¢ã‚ã‚‹
                    e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’é˜²æ­¢
                    setTimeout(() => {
                        textInput.focus(); // å°‘ã—é…å»¶ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
                        textInput.select(); // ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                    }, 10);
                };
                textInput.onmousedown = (e) => {
                    e.stopPropagation(); // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚‚æ­¢ã‚ã‚‹
                };
                textInput.onfocus = () => {
                    textInput.style.borderColor = '#10b981'; // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«æ ç·šã®è‰²ã‚’å¤‰æ›´
                    textInput.style.outline = 'none'; // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’ç„¡åŠ¹åŒ–
                };
                textInput.onblur = () => {
                    textInput.style.borderColor = '#6b7280'; // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰å…ƒã«æˆ»ã™
                };
                textInput.style.cssText = 'flex: 1; padding: 4px 8px; background-color: #374151; color: white; border: 1px solid #6b7280; border-radius: 3px; font-size: 12px; transition: border-color 0.2s; caret-color: white; pointer-events: auto; user-select: text; cursor: text;';
                textInput.placeholder = 'è¡¨ç¤ºåã‚’å…¥åŠ›';
                
                contentDiv.appendChild(textInput);
                
                const originalNameSpan = document.createElement('span');
                originalNameSpan.style.cssText = 'font-size: 11px; color: #9ca3af; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
                originalNameSpan.title = fileName;
                originalNameSpan.textContent = `å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}`;
                
                contentDiv.appendChild(originalNameSpan);
                
                fileItem.appendChild(fileIcon);
                fileItem.appendChild(contentDiv);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†ï¼ˆå‰Šé™¤ï¼‰
                
                // ã‚¿ãƒ–ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®šã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ”¹å–„
                textInput.tabIndex = 100 + index;
                
                fileItem.onmouseover = () => fileItem.style.backgroundColor = '#6b7280';
                fileItem.onmouseout = () => fileItem.style.backgroundColor = '#4b5563';
                
                filesList.appendChild(fileItem);
            });
            
            // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šï¼ˆãƒ¡ã‚¤ãƒ³ã¨ã„ã†æ¦‚å¿µã¯å‰Šé™¤ï¼‰
            if (filePaths.length > 0) {
                document.getElementById('productFilePath').value = filePaths[0];
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åæ›´æ–°æ™‚ã®å‡¦ç†
        function updateFileName(index, newName) {
            if (window.multipleFileData && window.multipleFileData[index]) {
                window.multipleFileData[index].displayName = newName;
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ¬„ã‚’å¼·åˆ¶çš„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        function forceTextInputFocus(index) {
            const textInput = document.getElementById(`fileName_${index}`);
            if (textInput) {
                console.log(`Attempting to focus input ${index}`);
                textInput.disabled = false;
                textInput.readOnly = false;
                textInput.style.pointerEvents = 'auto';
                setTimeout(() => {
                    textInput.focus();
                    textInput.select();
                    console.log(`Focus set for input ${index}, activeElement:`, document.activeElement);
                }, 50);
            }
        }

        // ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—
        async function fetchThumbnail() {
            const boothUrl = document.getElementById('productBoothUrl').value;
            if (!boothUrl) {
                alert('Booth URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!boothUrl.includes('booth.pm')) {
                alert('æœ‰åŠ¹ãªBooth URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'å–å¾—ä¸­...';

            try {
                if (window.electronAPI && window.electronAPI.fetch && window.electronAPI.fetch.thumbnail) {
                    const thumbnailUrl = await window.electronAPI.fetch.thumbnail(boothUrl);
                    if (thumbnailUrl) {
                        document.getElementById('productThumbnailUrl').value = thumbnailUrl;
                        showThumbnailPreview(thumbnailUrl);
                        alert('ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å–å¾—ã—ã¾ã—ãŸ');
                    } else {
                        alert('ã‚µãƒ ãƒã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    alert('ã‚µãƒ ãƒã‚¤ãƒ«å–å¾—æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('Failed to fetch thumbnail:', error);
                alert('ã‚µãƒ ãƒã‚¤ãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // ã‚µãƒ ãƒã‚¤ãƒ« ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showThumbnailPreview(thumbnailUrl) {
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            const thumbnailImage = document.getElementById('thumbnailImage');
            
            if (thumbnailUrl && thumbnailUrl.trim() !== '') {
                thumbnailImage.src = thumbnailUrl;
                thumbnailImage.onerror = function() {
                    // ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
                    thumbnailPreview.style.display = 'none';
                };
                thumbnailImage.onload = function() {
                    // ç”»åƒã®èª­ã¿è¾¼ã¿ãŒæˆåŠŸã—ãŸå ´åˆã«è¡¨ç¤º
                    thumbnailPreview.style.display = 'block';
                };
            } else {
                thumbnailPreview.style.display = 'none';
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
        document.getElementById('productForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            
            // é¸æŠã•ã‚ŒãŸã‚¢ãƒã‚¿ãƒ¼IDã‚’å–å¾—
            const selectedAvatarIds = [];
            const avatarCheckboxes = document.querySelectorAll('#avatarCheckboxes input[type="checkbox"]:checked');
            avatarCheckboxes.forEach(checkbox => {
                selectedAvatarIds.push(checkbox.value);
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã‚’å–å¾—
            const selectedTags = [];
            const tagCheckboxes = document.querySelectorAll('#tagCheckboxes input[type="checkbox"]:checked');
            tagCheckboxes.forEach(checkbox => {
                selectedTags.push(checkbox.value);
            });
            
            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºåã‚’ä¿å­˜
            let displayNames = '';
            let filePaths = '';
            if (window.multipleFileData && window.multipleFileData.length > 0) {
                displayNames = window.multipleFileData.map(f => f.displayName).join('|');
                filePaths = window.multipleFileData.map(f => f.path).join('|');
            }
            
            const productData = {
                name: formData.get('name'),
                category: formData.get('category'),
                booth_url: formData.get('booth_url'),
                thumbnail_url: formData.get('thumbnail_url'),
                file_path: formData.get('file_path'),
                description: formData.get('description'),
                author: '',
                avatar_ids: selectedAvatarIds.join(','),
                tags: selectedTags.join(','),
                file_paths: filePaths,
                display_names: displayNames
            };

            try {
                if (window.electronAPI) {
                    if (currentEditingProductId) {
                        // ç·¨é›†
                        await window.electronAPI.database.updateProduct(currentEditingProductId, productData);
                        console.log('Product updated:', currentEditingProductId);
                        
                        // å­¦ç¿’æ©Ÿèƒ½ï¼šBooth URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’ï¼ˆç·¨é›†æ™‚ï¼‰
                        if (productData.booth_url && productData.booth_url.includes('booth.pm') && productData.booth_url.includes('/items/') && productData.file_path) {
                            try {
                                const filename = productData.file_path.split(/[/\\]/).pop();
                                console.log('ç·¨é›†æ™‚å­¦ç¿’å‡¦ç†é–‹å§‹ - ãƒ•ã‚¡ã‚¤ãƒ«å:', filename, 'URL:', productData.booth_url);
                                const learningResult = await window.electronAPI.booth.learnMapping(filename, productData.booth_url);
                                console.log('ç·¨é›†æ™‚å­¦ç¿’APIçµæœ:', learningResult);
                                console.log('å•†å“ç·¨é›†æ™‚ã®å­¦ç¿’å®Œäº†:', filename, '->', productData.booth_url);
                                alert(`å­¦ç¿’å®Œäº†ï¼\n${filename} â†’ ${productData.booth_url}`);
                            } catch (learningError) {
                                console.error('å•†å“ç·¨é›†æ™‚ã®å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', learningError);
                                alert('å­¦ç¿’ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + learningError.message);
                            }
                        } else {
                            console.log('ç·¨é›†æ™‚å­¦ç¿’æ¡ä»¶æœªæº€:', {
                                booth_url: productData.booth_url,
                                file_path: productData.file_path,
                                includes_items: productData.booth_url && productData.booth_url.includes('booth.pm') && productData.booth_url.includes('/items/')
                            });
                        }
                    } else {
                        // æ–°è¦è¿½åŠ 
                        await window.electronAPI.database.addProduct(productData);
                        console.log('Product added:', productData);
                        
                        // å­¦ç¿’æ©Ÿèƒ½ï¼šBooth URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å­¦ç¿’
                        if (productData.booth_url && productData.booth_url.includes('booth.pm') && productData.booth_url.includes('/items/') && productData.file_path) {
                            try {
                                const filename = productData.file_path.split(/[/\\]/).pop();
                                console.log('å­¦ç¿’å‡¦ç†é–‹å§‹ - ãƒ•ã‚¡ã‚¤ãƒ«å:', filename, 'URL:', productData.booth_url);
                                const learningResult = await window.electronAPI.booth.learnMapping(filename, productData.booth_url);
                                console.log('å­¦ç¿’APIçµæœ:', learningResult);
                                console.log('å•†å“è¿½åŠ æ™‚ã®å­¦ç¿’å®Œäº†:', filename, '->', productData.booth_url);
                                alert(`å­¦ç¿’å®Œäº†ï¼\n${filename} â†’ ${productData.booth_url}`);
                            } catch (learningError) {
                                console.error('å•†å“è¿½åŠ æ™‚ã®å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', learningError);
                                alert('å­¦ç¿’ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + learningError.message);
                            }
                        } else {
                            console.log('å­¦ç¿’æ¡ä»¶æœªæº€:', {
                                booth_url: productData.booth_url,
                                file_path: productData.file_path,
                                includes_items: productData.booth_url && productData.booth_url.includes('booth.pm') && productData.booth_url.includes('/items/')
                            });
                        }
                        
                        // è¨­å®šç¢ºèªå¾Œã€ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•
                        const settings = await window.electronAPI.settings.get();
                        if (settings.autoArchive === true && productData.file_path && productData.file_path.trim()) {
                            const archiveResult = await window.electronAPI.fs.moveToArchive(productData.file_path);
                            if (archiveResult.success) {
                                console.log('ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•:', archiveResult.newPath);
                                
                                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ›´æ–°
                                const products = await window.electronAPI.database.getProducts();
                                const addedProduct = products[products.length - 1]; // æœ€å¾Œã«è¿½åŠ ã•ã‚ŒãŸå•†å“
                                if (addedProduct) {
                                    let updatedData = { ...addedProduct, file_path: archiveResult.newPath };
                                    
                                    // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•
                                    if (window.multipleFileData && window.multipleFileData.length > 0) {
                                        const archivedFiles = [];
                                        for (const fileData of window.multipleFileData) {
                                            const result = await window.electronAPI.fs.moveToArchive(fileData.path);
                                            if (result.success) {
                                                archivedFiles.push({ ...fileData, path: result.newPath });
                                                console.log('è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•:', result.newPath);
                                            } else {
                                                archivedFiles.push(fileData); // ç§»å‹•å¤±æ•—æ™‚ã¯å…ƒã®ãƒ‘ã‚¹ã‚’ä¿æŒ
                                                console.warn('è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç§»å‹•ã«å¤±æ•—:', result.error);
                                            }
                                        }
                                        
                                        updatedData.file_paths = archivedFiles.map(f => f.path).join('|');
                                        updatedData.display_names = archivedFiles.map(f => f.displayName).join('|');
                                    }
                                    
                                    await window.electronAPI.database.updateProduct(addedProduct.id, updatedData);
                                }
                            } else {
                                console.warn('ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç§»å‹•ã«å¤±æ•—:', archiveResult.error);
                            }
                        } else {
                            console.log('è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒç„¡åŠ¹ã®ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã›ã‚“ã§ã—ãŸ');
                        }
                    }
                    await loadProducts();
                    closeModal();
                }
            } catch (error) {
                console.error('Failed to save product:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
            }
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('productModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeModal();
            }
        });

        // å•†å“è©³ç´°ã‚’é–‹ã
        function openProductDetail(productOrId) {
            // IDã®å ´åˆã¯å•†å“ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
            const product = typeof productOrId === 'number' ? 
                products.find(p => p.id === productOrId) : productOrId;
            
            if (!product) {
                console.error('Product not found:', productOrId);
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.width = '600px';
            modalContent.style.maxWidth = '90vw';
            
            // å¯¾å¿œã‚¢ãƒã‚¿ãƒ¼åã‚’å–å¾—
            let avatarNames = '';
            if (product.avatar_ids) {
                const avatarIds = product.avatar_ids.split(',').map(id => id.trim()).filter(id => id);
                const matchedAvatars = avatars.filter(avatar => avatarIds.includes(avatar.id.toString()));
                avatarNames = matchedAvatars.map(avatar => avatar.name).join(', ');
            }
            
            modalContent.innerHTML = `
                <h2>${product.name}</h2>
                <div style="display: flex; gap: 20px; margin: 20px 0;">
                    <div style="flex-shrink: 0;">
                        ${product.thumbnail_url ? 
                            `<img src="${product.thumbnail_url}" alt="${product.name}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 6px;" draggable="false">` : 
                            '<div style="width: 150px; height: 150px; background-color: #4b5563; display: flex; align-items: center; justify-content: center; border-radius: 6px; color: #9ca3af;">ç”»åƒãªã—</div>'
                        }
                    </div>
                    <div style="flex: 1;">
                        <p><strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${product.category || 'ãªã—'}</p>
                        ${avatarNames ? `<p><strong>å¯¾å¿œã‚¢ãƒã‚¿ãƒ¼:</strong> ${avatarNames}</p>` : ''}
                        ${product.tags && product.tags.trim() !== '' ? `<p><strong>ã‚¿ã‚°:</strong> ${product.tags.split(',').map(tag => `<span style="background-color: #4b5563; padding: 2px 6px; border-radius: 4px; margin-right: 4px; font-size: 12px;">${tag.trim()}</span>`).join('')}</p>` : ''}
                        ${product.booth_url ? `<p><strong>Booth URL:</strong> <a href="${product.booth_url}" target="_blank" style="color: #60a5fa;">${product.booth_url}</a></p>` : ''}
                        ${product.file_path ? `<p><strong>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:</strong> ${product.file_path}</p>` : ''}
                        ${product.description ? `<p><strong>èª¬æ˜:</strong><br>${product.description}</p>` : ''}
                    </div>
                </div>
                <div class="form-buttons">
                    ${product.file_path ? `<button onclick="openFile(event, '${product.file_path.replace(/\\/g, '\\\\')}', ${product.id})" class="form-btn form-btn-submit">Unityã§é–‹ã${product.file_paths && product.file_paths.includes('|') ? ' â–¼' : ''}</button>` : ''}
                    <button onclick="editProductFromDetail(event, ${product.id})" class="form-btn form-btn-submit">ç·¨é›†</button>
                    <button onclick="closeDetailModal()" class="form-btn form-btn-cancel">é–‰ã˜ã‚‹</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeDetailModal();
                }
            });
            
            document.body.appendChild(modal);
            window.currentDetailModal = modal;
        }
        
        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDetailModal() {
            if (window.currentDetailModal) {
                document.body.removeChild(window.currentDetailModal);
                window.currentDetailModal = null;
            }
        }


        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // å•†å“è¿½åŠ ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
                const productModal = document.getElementById('productModal');
                if (productModal && productModal.style.display === 'block') {
                    closeModal();
                }
                
                // å•†å“è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
                if (window.currentDetailModal) {
                    closeDetailModal();
                }
            }
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        function initDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const dragOverlay = document.getElementById('dragOverlay');
            const body = document.body;
            let dragCounter = 0;
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸæ™‚ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’è¡¨ç¤º
            body.addEventListener('dragenter', function(e) {
                e.preventDefault();
                dragCounter++;
                // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ©ãƒƒã‚°ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¸¸ã«è¡¨ç¤ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã®åˆ¤å®šã¯å¾Œã§è¡Œã†ï¼‰
                if (e.dataTransfer && (e.dataTransfer.files.length > 0 || e.dataTransfer.types.includes('Files') || e.dataTransfer.types.includes('application/x-moz-file'))) {
                    dropZone.style.display = 'block';
                    dragOverlay.style.display = 'block';
                    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã«ãƒ‘ãƒ«ã‚¹åŠ¹æœã‚’è¿½åŠ 
                    dropZone.style.animation = 'pulse 2s infinite';
                }
            });
            
            body.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            body.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dragCounter--;
                // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°ãŒçµ‚äº†ã—ãŸå ´åˆã®ã¿éè¡¨ç¤º
                if (dragCounter === 0) {
                    dropZone.style.display = 'none';
                    dragOverlay.style.display = 'none';
                    dropZone.style.animation = '';
                }
            });
            
            body.addEventListener('drop', function(e) {
                e.preventDefault();
                dragCounter = 0;
                dropZone.style.display = 'none';
                dragOverlay.style.display = 'none';
                dropZone.style.animation = '';
                
                const files = Array.from(e.dataTransfer.files);
                const unityPackageFiles = files.filter(file => 
                    file.name.toLowerCase().endsWith('.unitypackage')
                );
                
                // ãƒ•ã‚©ãƒ«ãƒ€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆã®å‡¦ç†ï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªåˆ¤å®šï¼‰
                const folders = files.filter(file => {
                    // typeãŒç©ºã§ã€æ‹¡å¼µå­ãŒãªã„ã€ã¾ãŸã¯webkitRelativePathãŒã‚ã‚‹ã‚‚ã®ã‚’ãƒ•ã‚©ãƒ«ãƒ€ã¨åˆ¤å®š
                    return (file.type === '' && !file.name.includes('.')) || 
                           (file.webkitRelativePath && file.webkitRelativePath !== '');
                });
                
                // ãƒ•ã‚©ãƒ«ãƒ€ã‹ã©ã†ã‹ã®åˆ¤å®šã‚’ã‚ˆã‚Šç¢ºå®Ÿã«
                let isFolder = false;
                let folderFile = null;
                if (e.dataTransfer.items) {
                    for (let item of e.dataTransfer.items) {
                        if (item.kind === 'file') {
                            const file = item.getAsFile();
                            const entry = item.webkitGetAsEntry();
                            if (entry && entry.isDirectory) {
                                isFolder = true;
                                folderFile = file;
                                // processFolderDropEntryWithOptions(entry);
                                // return;
                            }
                        }
                    }
                }
                
                // ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç›´æ¥å‡¦ç†
                const allFiles = Array.from(e.dataTransfer.files);
                console.log('ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°:', allFiles.length);
                console.log('ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°:', allFiles.map(f => ({ 
                    name: f.name, 
                    path: f.path, 
                    type: f.type, 
                    size: f.size,
                    lastModified: f.lastModified,
                    webkitRelativePath: f.webkitRelativePath
                })));
                
                const droppedUnityFiles = allFiles.filter(file => 
                    file.name.toLowerCase().endsWith('.unitypackage')
                );
                
                console.log('Unity packageãƒ•ã‚¡ã‚¤ãƒ«æ•°:', droppedUnityFiles.length);
                if (droppedUnityFiles.length > 0) {
                    console.log('Unity packageãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°:', droppedUnityFiles.map(f => ({ 
                        name: f.name, 
                        path: f.path 
                    })));
                }
                
                if (droppedUnityFiles.length > 0) {
                    // .unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒç›´æ¥ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆ
                    console.log('Unity packageãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ:', droppedUnityFiles.length, 'å€‹');
                    
                    const filePaths = droppedUnityFiles.map(f => f.path || f.name);
                    console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:', filePaths);
                    
                    if (droppedUnityFiles.length > 1) {
                        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰æ¥ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®š
                        const firstFilePath = filePaths[0];
                        if (firstFilePath && firstFilePath.includes('/') || firstFilePath.includes('\\')) {
                            const separator = firstFilePath.includes('/') ? '/' : '\\';
                            const folderPath = firstFilePath.substring(0, firstFilePath.lastIndexOf(separator));
                            const folderName = folderPath.substring(folderPath.lastIndexOf(separator) + 1);
                            
                            // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
                            const sameFolder = filePaths.every(path => {
                                if (!path || (!path.includes('/') && !path.includes('\\'))) return false;
                                const fileFolderPath = path.substring(0, path.lastIndexOf(separator));
                                return fileFolderPath === folderPath;
                            });
                            
                            if (sameFolder && folderName) {
                                // åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã®è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ« = ãƒ•ã‚©ãƒ«ãƒ€ãƒ‰ãƒ­ãƒƒãƒ—
                                console.log('ãƒ•ã‚©ãƒ«ãƒ€ãƒ‰ãƒ­ãƒƒãƒ—ã¨åˆ¤å®š:', folderName);
                                showFolderOptionDialog(filePaths, folderName);
                                return;
                            }
                        }
                        
                        // ç•°ãªã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã®è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ« = å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—
                        console.log('å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã¨åˆ¤å®š');
                        processDroppedFiles(filePaths);
                    } else {
                        // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«
                        console.log('å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—');
                        processDroppedFiles(filePaths);
                    }
                } else {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰æ¤œå‡ºã§ããªã„å ´åˆã€WebKit Entry APIã‚’è©¦ã™
                    console.log('é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Entry APIã‚’è©¦ã—ã¾ã™...');
                    
                    if (e.dataTransfer.items) {
                        let foundFolder = false;
                        for (let item of e.dataTransfer.items) {
                            if (item.kind === 'file') {
                                const entry = item.webkitGetAsEntry();
                                if (entry && entry.isDirectory) {
                                    console.log('Entry APIã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œå‡º:', entry.name);
                                    foundFolder = true;
                                    processDirectoryEntry(entry);
                                    break;
                                }
                            }
                        }
                        
                        if (!foundFolder) {
                            console.log('Unity packageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                            alert('.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãã‚Œã‚’å«ã‚€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
                        }
                    } else {
                        console.log('Entry APIã‚‚åˆ©ç”¨ã§ãã¾ã›ã‚“');
                        alert('.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãã‚Œã‚’å«ã‚€ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            });
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#16a34a';
                this.style.backgroundColor = '#065f46';
                this.style.borderWidth = '3px';
                this.style.transform = 'scale(1.02)';
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#4b5563';
                this.style.backgroundColor = '#374151';
                this.style.borderWidth = '2px';
                this.style.transform = 'scale(1)';
            });
            
            dropZone.addEventListener('drop', function(e) {
                this.style.borderColor = '#4b5563';
                this.style.backgroundColor = '#374151';
                this.style.borderWidth = '2px';
                this.style.transform = 'scale(1)';
            });
        }
        
        // .unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        function hasUnityPackageFiles(dataTransfer) {
            if (dataTransfer.items) {
                for (let item of dataTransfer.items) {
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        if (file && file.name.toLowerCase().endsWith('.unitypackage')) {
                            return true;
                        }
                        // ãƒ•ã‚©ãƒ«ãƒ€ã®å ´åˆã‚‚trueã‚’è¿”ã™ï¼ˆå¾Œã§ãƒ•ã‚©ãƒ«ãƒ€å†…ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                        if (file && file.type === '') {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        
        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®å•†å“ã¨ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†
        async function processDroppedFilesAsGroup(files) {
            console.log(`${files.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®å•†å“ã¨ã—ã¦è¿½åŠ ã—ã¾ã™`);
            
            const firstFile = files[0];
            const fileName = firstFile.name.replace('.unitypackage', '');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å•†å“åã‚’æ¨æ¸¬
            const productName = fileName
                .replace(/[_-]/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
            
            // è‡ªå‹•ã§ã‚«ãƒ†ã‚´ãƒªã‚’æ¨æ¸¬
            let category = 'ãã®ä»–';
            const lowerName = fileName.toLowerCase();
            if (lowerName.includes('avatar') || lowerName.includes('ã‚¢ãƒã‚¿ãƒ¼')) {
                category = 'ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“';
            } else if (lowerName.includes('costume') || lowerName.includes('cloth') || lowerName.includes('è¡£è£…')) {
                category = 'è¡£è£…';
            } else if (lowerName.includes('accessory') || lowerName.includes('ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼')) {
                category = 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
            } else if (lowerName.includes('hair') || lowerName.includes('é«ª')) {
                category = 'é«ªå‹';
            } else if (lowerName.includes('tool') || lowerName.includes('ãƒ„ãƒ¼ãƒ«') || lowerName.includes('editor') || lowerName.includes('utility')) {
                category = 'ãƒ„ãƒ¼ãƒ«';
            } else if (lowerName.includes('pose') || lowerName.includes('ãƒãƒ¼ã‚º') || lowerName.includes('motion') || lowerName.includes('anim')) {
                category = 'ãƒãƒ¼ã‚º';
            } else if (lowerName.includes('world') || lowerName.includes('ãƒ¯ãƒ¼ãƒ«ãƒ‰') || lowerName.includes('scene')) {
                category = 'ãƒ¯ãƒ¼ãƒ«ãƒ‰';
            }
            
            // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ä¿å­˜ç”¨ã«æº–å‚™
            const allFilePaths = files.map(file => file.path || file.name);
            
            const productData = {
                name: productName,
                category: category,
                booth_url: '',
                thumbnail_url: '',
                file_path: allFilePaths[0], // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
                file_paths: allFilePaths.join('|'), // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’åŒºåˆ‡ã‚Šæ–‡å­—ã§ä¿å­˜
                description: `è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«: ${files.map(f => f.name).join(', ')}`,
                author: '',
                avatar_ids: '',
                tags: ''
            };
            
            try {
                if (window.electronAPI) {
                    await window.electronAPI.database.addProduct(productData);
                    console.log('ã‚°ãƒ«ãƒ¼ãƒ—å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', productData.name);
                    console.log('  - ãƒ•ã‚¡ã‚¤ãƒ«æ•°:', files.length);
                    console.log('  - ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:', allFilePaths);
                    loadProducts();
                }
            } catch (error) {
                console.error('ã‚°ãƒ«ãƒ¼ãƒ—å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
        async function processDroppedFiles(files) {
            console.log(`${files.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`);
            
            for (let i = 0; i < files.length; i++) {
                const filePath = files[i];
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‹ã‚‰æ‹¡å¼µå­ã‚’é™¤ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
                const fileName = typeof filePath === 'string' 
                    ? filePath.split('\\').pop().split('/').pop().replace('.unitypackage', '')
                    : filePath.name.replace('.unitypackage', '');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å•†å“åã‚’æ¨æ¸¬
                const productName = fileName
                    .replace(/[_-]/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
                
                // è‡ªå‹•ã§ã‚«ãƒ†ã‚´ãƒªã‚’æ¨æ¸¬
                let category = 'ãã®ä»–';
                const lowerName = fileName.toLowerCase();
                if (lowerName.includes('avatar') || lowerName.includes('ã‚¢ãƒã‚¿ãƒ¼')) {
                    category = 'ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“';
                } else if (lowerName.includes('costume') || lowerName.includes('cloth') || lowerName.includes('è¡£è£…')) {
                    category = 'è¡£è£…';
                } else if (lowerName.includes('accessory') || lowerName.includes('ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼')) {
                    category = 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
                } else if (lowerName.includes('hair') || lowerName.includes('é«ª')) {
                    category = 'é«ªå‹';
                } else if (lowerName.includes('tool') || lowerName.includes('ãƒ„ãƒ¼ãƒ«') || lowerName.includes('editor') || lowerName.includes('utility')) {
                    category = 'ãƒ„ãƒ¼ãƒ«';
                } else if (lowerName.includes('pose') || lowerName.includes('ãƒãƒ¼ã‚º') || lowerName.includes('motion') || lowerName.includes('anim')) {
                    category = 'ãƒãƒ¼ã‚º';
                } else if (lowerName.includes('world') || lowerName.includes('ãƒ¯ãƒ¼ãƒ«ãƒ‰') || lowerName.includes('scene')) {
                    category = 'ãƒ¯ãƒ¼ãƒ«ãƒ‰';
                }
                
                const productData = {
                    name: productName,
                    category: category,
                    booth_url: '',
                    thumbnail_url: '',
                    file_path: typeof filePath === 'string' ? filePath : filePath.path,
                    description: `ãƒ•ã‚¡ã‚¤ãƒ«: ${fileName}.unitypackage`,
                    author: '',
                    avatar_ids: '',
                    tags: ''
                };
                
                try {
                    if (window.electronAPI) {
                        await window.electronAPI.database.addProduct(productData);
                        console.log('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', productData.name);
                        
                        // è¨­å®šç¢ºèªå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•
                        const settings = await window.electronAPI.settings.get();
                        if (settings.autoArchive === true) {
                            const archiveResult = await window.electronAPI.fs.moveToArchive(productData.file_path);
                            if (archiveResult.success) {
                                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ç§»å‹•:', archiveResult.newPath);
                                // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ›´æ–°
                                const products = await window.electronAPI.database.getProducts();
                                const addedProduct = products[products.length - 1]; // æœ€å¾Œã«è¿½åŠ ã•ã‚ŒãŸå•†å“
                                if (addedProduct) {
                                    await window.electronAPI.database.updateProduct(addedProduct.id, {
                                        ...addedProduct,
                                        file_path: archiveResult.newPath
                                    });
                                }
                            } else {
                                console.warn('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç§»å‹•ã«å¤±æ•—:', archiveResult.error);
                            }
                        } else {
                            console.log('è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒç„¡åŠ¹ã®ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã›ã‚“ã§ã—ãŸ');
                        }
                    }
                } catch (error) {
                    console.error('å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            await loadProducts();
            
            const successCount = files.length;
            
            // è¨­å®šã‚’ç¢ºèªã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
            const settings = await window.electronAPI.settings.get();
            if (settings.autoArchive === true) {
                alert(`${successCount}å€‹ã®å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã•ã‚Œã¾ã—ãŸã€‚`);
            } else {
                alert(`${successCount}å€‹ã®å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
            }
        }
        
        // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function switchToGridView() {
            isListView = false;
            selectedProducts.clear();
            updateViewButtons();
            filterProducts(); // ãƒ•ã‚£ãƒ«ã‚¿ã¨ä¸¦ã³é †ã‚’é©ç”¨ã—ã¦å†æç”»
            updateSelectionBlock();
        }
        
        function switchToListView() {
            isListView = true;
            updateViewButtons();
            filterProducts(); // ãƒ•ã‚£ãƒ«ã‚¿ã¨ä¸¦ã³é †ã‚’é©ç”¨ã—ã¦å†æç”»
        }
        
        function updateViewButtons() {
            const gridBtn = document.getElementById('gridViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (isListView) {
                gridBtn.style.backgroundColor = '#6b7280';
                gridBtn.style.border = 'none';
                listBtn.style.backgroundColor = '#4b5563';
                listBtn.style.border = '1px solid #6b7280';
            } else {
                gridBtn.style.backgroundColor = '#4b5563';
                gridBtn.style.border = '1px solid #6b7280';
                listBtn.style.backgroundColor = '#6b7280';
                listBtn.style.border = 'none';
            }
        }
        
        // é¸æŠæ©Ÿèƒ½
        function toggleProductSelection(productId) {
            if (selectedProducts.has(productId)) {
                selectedProducts.delete(productId);
            } else {
                selectedProducts.add(productId);
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã ã‘ã‚’æ›´æ–°ï¼ˆå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„ï¼‰
            updateCheckboxStates();
            updateSelectionBlock();
        }
        
        function updateCheckboxStates() {
            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(checkbox => {
                const productId = parseInt(checkbox.parentElement.querySelector('[onclick*="toggleProductSelection"]').getAttribute('onclick').match(/\d+/)[0]);
                checkbox.checked = selectedProducts.has(productId);
            });
        }
        
        function updateSelectionBlock() {
            const selectionBlock = document.getElementById('selectionBlock');
            const selectedCount = document.getElementById('selectedCount');
            const productsContainer = document.getElementById('products');
            
            if (selectedProducts.size > 0) {
                selectedCount.textContent = selectedProducts.size;
                
                // é¸æŠã•ã‚ŒãŸå•†å“ã®å…±é€šã‚¿ã‚°ã‚’å–å¾—ã—ã¦ãƒ—ãƒªã‚»ãƒƒãƒˆ
                prefillCommonTags();
                
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼šä¸‹ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—ã—ãªãŒã‚‰è¡¨ç¤º
                selectionBlock.style.visibility = 'visible';
                selectionBlock.style.opacity = '1';
                selectionBlock.style.transform = 'translateY(0)';
                
                // ã‚¿ã‚°ç·¨é›†ãƒœãƒƒã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ™‚ã¯ååˆ†ãªä½™ç™½ã‚’ç¢ºä¿
                productsContainer.style.paddingBottom = '200px';
            } else {
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼šä¸‹ã«ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³ã—ãªãŒã‚‰éè¡¨ç¤º
                selectionBlock.style.opacity = '0';
                selectionBlock.style.transform = 'translateY(100%)';
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«visibilityã‚’å¤‰æ›´
                setTimeout(() => {
                    if (selectedProducts.size === 0) {
                        selectionBlock.style.visibility = 'hidden';
                    }
                }, 300); // ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åŒã˜
                
                // ã‚¿ã‚°ç·¨é›†ãƒœãƒƒã‚¯ã‚¹ãŒéè¡¨ç¤ºã®æ™‚ã¯é€šå¸¸ã®ä½™ç™½
                productsContainer.style.paddingBottom = '20px';
            }
        }
        
        // é¸æŠã•ã‚ŒãŸå•†å“ã®å…±é€šã‚¿ã‚°ã‚’ãƒ—ãƒªãƒ•ã‚£ãƒ«
        function prefillCommonTags() {
            if (selectedProducts.size === 0) return;
            
            const selectedProductsList = Array.from(selectedProducts).map(id => 
                products.find(p => p.id === id)
            ).filter(p => p);
            
            if (selectedProductsList.length === 0) return;
            
            // å„å•†å“ã®ã‚¿ã‚°ã‚’é…åˆ—ã¨ã—ã¦å–å¾—
            const productTagArrays = selectedProductsList.map(product => {
                return product.tags ? product.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            });
            
            let commonTags = [];
            
            if (selectedProducts.size === 1) {
                // 1å€‹é¸æŠã®å ´åˆï¼šãã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
                commonTags = productTagArrays[0] || [];
            } else {
                // è¤‡æ•°é¸æŠã®å ´åˆï¼šã™ã¹ã¦ã®å•†å“ã«å…±é€šã™ã‚‹ã‚¿ã‚°ã®ã¿è¡¨ç¤º
                if (productTagArrays.length > 0) {
                    commonTags = productTagArrays[0].filter(tag => 
                        productTagArrays.every(tagArray => tagArray.includes(tag))
                    );
                }
            }
            
            // å…±é€šã‚¿ã‚°ã‚’ selectedTagsForEditing ã«è¿½åŠ 
            selectedTagsForEditing.clear();
            commonTags.forEach(tag => selectedTagsForEditing.add(tag));
            
            // ã‚¿ã‚°è¡¨ç¤ºã‚’æ›´æ–°
            updateTagsDisplay();
        }
        
        function clearSelection() {
            selectedProducts.clear();
            selectedTagsForEditing.clear();
            updateCheckboxStates();
            updateSelectionBlock();
            updateTagsDisplay();
        }
        
        // YouTubeé¢¨ã‚¿ã‚°ç·¨é›†æ©Ÿèƒ½
        let selectedTagsForEditing = new Set();
        let allAvailableTags = new Set();
        
        function updateTagsDisplay() {
            const selectedTagsArea = document.getElementById('selectedTagsArea');
            selectedTagsArea.innerHTML = '';
            
            selectedTagsForEditing.forEach(tag => {
                const tagChip = document.createElement('div');
                tagChip.style.cssText = `
                    display: inline-flex;
                    align-items: center;
                    background-color: #059669;
                    color: white;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 13px;
                    gap: 5px;
                    font-weight: 500;
                `;
                
                tagChip.innerHTML = `
                    <span>${tag}</span>
                    <button onclick="removeTagFromSelection('${tag}')" style="
                        background: none;
                        border: none;
                        color: white;
                        cursor: pointer;
                        padding: 0;
                        width: 16px;
                        height: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        font-size: 11px;
                        line-height: 1;
                    " onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='transparent'">Ã—</button>
                `;
                
                selectedTagsArea.appendChild(tagChip);
            });
        }
        
        function getAllTagsFromProducts() {
            const tags = new Set();
            products.forEach(product => {
                if (product.tags) {
                    product.tags.split(',').forEach(tag => {
                        const trimmed = tag.trim();
                        if (trimmed) tags.add(trimmed);
                    });
                }
            });
            return Array.from(tags).sort();
        }
        
        function showTagSuggestions(query) {
            const suggestionsDiv = document.getElementById('tagSuggestions');
            const allTags = getAllTagsFromProducts();
            
            if (!query.trim()) {
                // ç©ºã®å ´åˆã¯æ—¢å­˜ã®ã‚¿ã‚°ã‚’è¡¨ç¤º
                const filteredTags = allTags.filter(tag => !selectedTagsForEditing.has(tag));
                displayTagSuggestions(filteredTags.slice(0, 10));
                return;
            }
            
            const filteredTags = allTags.filter(tag => 
                tag.toLowerCase().includes(query.toLowerCase()) && 
                !selectedTagsForEditing.has(tag)
            );
            
            displayTagSuggestions(filteredTags.slice(0, 10));
        }
        
        function displayTagSuggestions(tags) {
            const suggestionsDiv = document.getElementById('tagSuggestions');
            
            if (tags.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = '';
            tags.forEach(tag => {
                const suggestion = document.createElement('div');
                suggestion.style.cssText = `
                    padding: 3px 4px;
                    cursor: pointer;
                    color: white;
                    font-size: 11px;
                    border-bottom: 1px solid #6b7280;
                `;
                suggestion.textContent = tag;
                suggestion.onmouseover = () => suggestion.style.backgroundColor = '#6b7280';
                suggestion.onmouseout = () => suggestion.style.backgroundColor = 'transparent';
                suggestion.onmousedown = (e) => {
                    e.preventDefault(); // blurã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    addTagToSelection(tag);
                };
                
                suggestionsDiv.appendChild(suggestion);
            });
            
            suggestionsDiv.style.display = 'block';
        }
        
        function hideTagSuggestions() {
            setTimeout(() => {
                document.getElementById('tagSuggestions').style.display = 'none';
            }, 200);
        }
        
        function handleTagInput(event) {
            console.log('handleTagInput called with key:', event.key, 'value:', event.target.value);
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const tag = input.value.trim();
                console.log('Enter pressed, tag value:', tag);
                if (tag && !selectedTagsForEditing.has(tag)) {
                    console.log('Adding tag:', tag);
                    addTagToSelection(tag);
                } else {
                    console.log('Tag not added - empty or duplicate:', tag);
                }
                input.value = '';
                hideTagSuggestions();
            } else if (event.key === 'Backspace' && event.target.value === '') {
                // å…¥åŠ›ãŒç©ºã§ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŠ¼ã—ãŸå ´åˆã€æœ€å¾Œã®ã‚¿ã‚°ã‚’å‰Šé™¤
                const tagsArray = Array.from(selectedTagsForEditing);
                if (tagsArray.length > 0) {
                    removeTagFromSelection(tagsArray[tagsArray.length - 1]);
                }
            }
        }
        
        function addTagFromInput() {
            const input = document.getElementById('tagInput');
            const tag = input.value.trim();
            console.log('addTagFromInput called with:', tag);
            
            if (!tag) {
                alert('ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (selectedTagsForEditing.has(tag)) {
                alert('ã“ã®ã‚¿ã‚°ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            addTagToSelection(tag);
        }
        
        function addTagToSelection(tag) {
            console.log('addTagToSelection called with:', tag);
            selectedTagsForEditing.add(tag);
            console.log('selectedTagsForEditing after add:', selectedTagsForEditing);
            updateTagsDisplay();
            document.getElementById('tagInput').value = '';
            hideTagSuggestions();
        }
        
        function removeTagFromSelection(tag) {
            selectedTagsForEditing.delete(tag);
            updateTagsDisplay();
        }
        
        function applyTagsToSelected() {
            console.log('applyTagsToSelected called');
            console.log('selectedProducts:', selectedProducts);
            console.log('selectedTagsForEditing:', selectedTagsForEditing);
            
            if (selectedProducts.size === 0) {
                alert('å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // ã‚¿ã‚°ãŒ0å€‹ã§ã‚‚é©ç”¨ã‚’è¨±å¯ï¼ˆå…¨å‰Šé™¤ã®å ´åˆï¼‰
            
            const tagsArray = Array.from(selectedTagsForEditing);
            console.log('tagsArray:', tagsArray);
            
            const updatePromises = Array.from(selectedProducts).map(async (productId) => {
                try {
                    const product = products.find(p => p.id === productId);
                    if (!product) return { success: false, id: productId };
                    
                    // ç¾åœ¨ã®ã‚¿ã‚°ã¨ç·¨é›†å¾Œã®ã‚¿ã‚°ã‚’æ¯”è¼ƒã—ã¦ãƒ­ã‚°å‡ºåŠ›
                    const currentTags = product.tags ? product.tags.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
                    const updatedTags = tagsArray; // selectedTagsForEditingã®å†…å®¹ã§å®Œå…¨ã«ç½®ãæ›ãˆ
                    
                    console.log(`Updating product ${productId}: ${currentTags} â†’ ${updatedTags}`);
                    
                    const updatedProduct = { ...product, tags: updatedTags.join(', ') };
                    await window.electronAPI.database.updateProduct(productId, updatedProduct);
                    return { success: true, id: productId };
                } catch (error) {
                    console.error(`Failed to update product ${productId}:`, error);
                    return { success: false, id: productId, error };
                }
            });
            
            Promise.all(updatePromises).then(results => {
                const successful = results.filter(r => r.success);
                const failed = results.filter(r => !r.success);
                
                console.log('Update results:', { successful: successful.length, failed: failed.length });
                
                if (successful.length > 0) {
                    alert(`${successful.length}å€‹ã®å•†å“ã«ã‚¿ã‚°ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
                    selectedTagsForEditing.clear();
                    updateTagsDisplay();
                    loadProducts();
                }
                
                if (failed.length > 0) {
                    alert(`${failed.length}å€‹ã®å•†å“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
                }
            });
        }
        
        function deleteSelectedProducts() {
            if (selectedProducts.size === 0) return;
            
            const selectedProductsList = Array.from(selectedProducts).map(id => {
                const product = products.find(p => p.id === id);
                return product ? product.name : `ID: ${id}`;
            }).join('\nãƒ»');
            
            if (confirm(`ä»¥ä¸‹ã®${selectedProducts.size}å€‹ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»${selectedProductsList}`)) {
                const deletePromises = Array.from(selectedProducts).map(async (productId) => {
                    try {
                        await window.electronAPI.database.deleteProduct(productId);
                        return { success: true, id: productId };
                    } catch (error) {
                        console.error(`Failed to delete product ${productId}:`, error);
                        return { success: false, id: productId, error };
                    }
                });
                
                Promise.all(deletePromises).then(results => {
                    const successful = results.filter(r => r.success);
                    const failed = results.filter(r => !r.success);
                    
                    if (successful.length > 0) {
                        alert(`${successful.length}å€‹ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                        selectedProducts.clear();
                        loadProducts(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    }
                    
                    if (failed.length > 0) {
                        alert(`${failed.length}å€‹ã®å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                    }
                });
            }
        }
        
        // å•†å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openProductModal() {
            currentEditingProductId = null;
            document.getElementById('modalTitle').textContent = 'å•†å“ã‚’è¿½åŠ ';
            document.getElementById('productForm').reset();
            document.getElementById('thumbnailPreview').style.display = 'none';
            document.getElementById('multipleFilesArea').style.display = 'none';
            document.getElementById('selectedFileInfo').textContent = '';
            window.multipleFileData = null; // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            selectedTagsForEditing.clear();
            updateTagsDisplay();
            document.getElementById('productModal').style.display = 'block';
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                document.getElementById('productName').focus();
            }, 100);
        }
        
        // WebKit Entry APIã‚’ä½¿ã£ãŸãƒ•ã‚©ãƒ«ãƒ€å‡¦ç†ï¼ˆé¸æŠè‚¢ä»˜ãï¼‰
        async function processFolderDropEntryWithOptions(entry) {
            if (!entry.isDirectory) return;
            
            console.log('ãƒ•ã‚©ãƒ«ãƒ€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ (Entry API):', entry.name);
            
            // Entry APIã‹ã‚‰å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯ä»®æƒ³ãƒ‘ã‚¹ã§å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã¨ç•°ãªã‚‹ãŸã‚ã€
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã„ã¦æ­£ç¢ºãªãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹
            alert('ãƒ•ã‚©ãƒ«ãƒ€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ­£ç¢ºãªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            selectDirectoryForDrop();
        }
        
        // Entry APIã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‡¦ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        async function processDirectoryEntry(entry) {
            if (!entry.isDirectory) return;
            
            console.log('Entry APIã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‡¦ç†:', entry.name);
            
            try {
                const unityPackageFiles = [];
                const reader = entry.createReader();
                
                const readEntries = () => {
                    return new Promise((resolve, reject) => {
                        reader.readEntries((entries) => {
                            resolve(entries);
                        }, reject);
                    });
                };
                
                const entries = await readEntries();
                console.log('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã‚¨ãƒ³ãƒˆãƒªæ•°:', entries.length);
                
                // .unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
                for (const fileEntry of entries) {
                    if (!fileEntry.isDirectory && fileEntry.name.toLowerCase().endsWith('.unitypackage')) {
                        console.log('Unity packageãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹:', fileEntry.name);
                        
                        // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã—ã¦ãƒ‘ã‚¹ã‚’å¾—ã‚‹
                        const file = await new Promise((resolve, reject) => {
                            fileEntry.file(resolve, reject);
                        });
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ§‹ç¯‰ï¼ˆfile.pathãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µï¼‰
                        const filePath = file.path || `${entry.name}/${fileEntry.name}`;
                        unityPackageFiles.push(filePath);
                        console.log('è¿½åŠ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:', filePath);
                    }
                }
                
                if (unityPackageFiles.length > 0) {
                    console.log(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«${unityPackageFiles.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                    
                    if (unityPackageFiles.length > 1) {
                        // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯é¸æŠè‚¢ã‚’æä¾›
                        showFolderOptionDialog(unityPackageFiles, entry.name);
                    } else {
                        // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                        processFilesAsSeparateProducts(unityPackageFiles, entry.name);
                    }
                } else {
                    console.log('ãƒ•ã‚©ãƒ«ãƒ€å†…ã«Unity packageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    // ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã£ãŸãŒã€Unity packageãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯
                    // main processã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠã‚’ä½¿ç”¨
                    alert('ãƒ•ã‚©ãƒ«ãƒ€å†…ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ­£ç¢ºãªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    selectDirectoryForDrop();
                }
                
            } catch (error) {
                console.error('Entry APIå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                // Entry APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                alert('ãƒ•ã‚©ãƒ«ãƒ€ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ç¢ºãªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                selectDirectoryForDrop();
            }
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠ
        async function selectDirectoryForDrop() {
            try {
                if (window.electronAPI) {
                    const result = await window.electronAPI.dialog.selectDirectory();
                    if (result && result.files && result.files.length > 0) {
                        console.log('é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€:', result.folderName);
                        console.log('ãƒ•ã‚¡ã‚¤ãƒ«:', result.files);
                        
                        if (result.files.length > 1) {
                            // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯é¸æŠè‚¢ã‚’æä¾›
                            showFolderOptionDialog(result.files, result.folderName);
                        } else if (result.files.length === 1) {
                            // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                            processFilesAsSeparateProducts(result.files, result.folderName);
                        } else {
                            alert('é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€å†…ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                        }
                    }
                }
            } catch (error) {
                console.error('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé¸æŠã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚©ãƒ«ãƒ€ã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã‚’æ¨æ¸¬
        function detectCategoryFromFileName(fileName) {
            if (!fileName) return 'ãã®ä»–';
            
            const lowerName = fileName.toLowerCase();
            
            // è¡£è£…é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            if (lowerName.includes('cloth') || lowerName.includes('wear') || lowerName.includes('outfit') || 
                lowerName.includes('dress') || lowerName.includes('shirt') || lowerName.includes('pants') ||
                lowerName.includes('skirt') || lowerName.includes('jacket') || lowerName.includes('coat') ||
                lowerName.includes('è¡£è£…') || lowerName.includes('æœ') || lowerName.includes('ãƒ‰ãƒ¬ã‚¹') ||
                lowerName.includes('ã‚·ãƒ£ãƒ„') || lowerName.includes('ãƒ‘ãƒ³ãƒ„') || lowerName.includes('ã‚¹ã‚«ãƒ¼ãƒˆ')) {
                return 'è¡£è£…';
            }
            
            // ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            if (lowerName.includes('accessory') || lowerName.includes('hat') || lowerName.includes('glasses') ||
                lowerName.includes('bag') || lowerName.includes('jewelry') || lowerName.includes('earring') ||
                lowerName.includes('necklace') || lowerName.includes('bracelet') || lowerName.includes('ring') ||
                lowerName.includes('ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼') || lowerName.includes('å¸½å­') || lowerName.includes('çœ¼é¡') ||
                lowerName.includes('ãƒãƒƒã‚°') || lowerName.includes('ãƒ”ã‚¢ã‚¹') || lowerName.includes('ãƒãƒƒã‚¯ãƒ¬ã‚¹')) {
                return 'ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼';
            }
            
            // ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
            if (lowerName.includes('avatar') || lowerName.includes('body') || lowerName.includes('base') ||
                lowerName.includes('character') || lowerName.includes('model') ||
                lowerName.includes('ã‚¢ãƒã‚¿ãƒ¼') || lowerName.includes('æœ¬ä½“') || lowerName.includes('ãƒ™ãƒ¼ã‚¹') ||
                lowerName.includes('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼') || lowerName.includes('ãƒ¢ãƒ‡ãƒ«')) {
                return 'ã‚¢ãƒã‚¿ãƒ¼æœ¬ä½“';
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œãã®ä»–ã€
            return 'ãã®ä»–';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®å•†å“ã¨ã—ã¦çµ±åˆå‡¦ç†
        async function processFilesAsOneProduct(filePaths, folderName) {
            console.log(`${filePaths.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã®å•†å“ã¨ã—ã¦çµ±åˆã—ã¾ã™`);
            
            if (filePaths.length === 0) return;
            
            // å•†å“åã¯å…ƒã®ãƒ•ã‚©ãƒ«ãƒ€åã‚’ä½¿ç”¨
            const productName = folderName || 'Unity Package Bundle';
            
            // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«
            const mainFilePath = filePaths[0];
            
            // å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºåã‚’ç”Ÿæˆ
            const displayNames = filePaths.map(filePath => {
                const fileName = filePath.split(/[/\\]/).pop().replace('.unitypackage', '');
                return fileName;
            });
            
            const productData = {
                name: productName,
                category: detectCategoryFromFileName(folderName),
                booth_url: '',
                thumbnail_url: '',
                file_path: mainFilePath,
                description: `ãƒ•ã‚©ãƒ«ãƒ€: ${folderName}\n${filePaths.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€`,
                author: '',
                avatar_ids: '',
                tags: '',
                file_paths: filePaths.join('|'),
                display_names: displayNames.join('|')
            };
            
            try {
                if (window.electronAPI) {
                    await window.electronAPI.database.addProduct(productData);
                    console.log('çµ±åˆå•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', productData.name);
                    alert(`çµ±åˆå•†å“ã€Œ${productData.name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆ${filePaths.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰`);
                    loadProducts(); // å•†å“ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                }
            } catch (error) {
                console.error('çµ±åˆå•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                alert('çµ±åˆå•†å“ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã®å•†å“ã¨ã—ã¦å‡¦ç†
        async function processFilesAsSeparateProducts(filePaths, folderName = '') {
            console.log(`${filePaths.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã®å•†å“ã¨ã—ã¦è¿½åŠ ã—ã¾ã™`);
            
            let successCount = 0;
            
            for (const filePath of filePaths) {
                const fileName = filePath.split(/[/\\]/).pop().replace('.unitypackage', '');
                const productName = folderName ? `${folderName} - ${fileName}` : fileName;
                
                const productData = {
                    name: productName,
                    category: detectCategoryFromFileName(fileName),
                    booth_url: '',
                    thumbnail_url: '',
                    file_path: filePath,
                    description: `ãƒ•ã‚¡ã‚¤ãƒ«: ${fileName}`,
                    author: '',
                    avatar_ids: '',
                    tags: '',
                    file_paths: '',
                    display_names: ''
                };
                
                try {
                    if (window.electronAPI) {
                        await window.electronAPI.database.addProduct(productData);
                        successCount++;
                        console.log('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', productData.name);
                    }
                } catch (error) {
                    console.error('å•†å“è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            if (successCount > 0) {
                alert(`${successCount}å€‹ã®å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                loadProducts(); // å•†å“ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
            }
        }
        
        // ãƒ•ã‚©ãƒ«ãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰å‡¦ç†ï¼ˆwebkitRelativePathã‚’ä½¿ç”¨ï¼‰
        async function processFolderFilesWithOptions(folderFiles) {
            console.log('ãƒ•ã‚©ãƒ«ãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰å‡¦ç†:', folderFiles.length, 'ãƒ•ã‚¡ã‚¤ãƒ«');
            
            // .unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡º
            const unityPackageFiles = folderFiles.filter(file => 
                file.name.toLowerCase().endsWith('.unitypackage')
            );
            
            if (unityPackageFiles.length === 0) {
                alert('ãƒ•ã‚©ãƒ«ãƒ€å†…ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                return;
            }
            
            console.log(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«${unityPackageFiles.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            
            // ãƒ•ã‚©ãƒ«ãƒ€åã‚’å–å¾—ï¼ˆæœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã®webkitRelativePathã‹ã‚‰ï¼‰
            const firstFilePath = unityPackageFiles[0].webkitRelativePath;
            const folderName = firstFilePath.split('/')[0];
            
            // å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ä¸€æ™‚çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
            const realFilePaths = [];
            for (const file of unityPackageFiles) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿéš›ã®ãƒ‘ã‚¹ã¯ç›´æ¥å–å¾—ã§ããªã„ãŸã‚ã€
                // main processã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®çµæœã¨ç…§åˆã™ã‚‹æ–¹æ³•ã‚’ä½¿ç”¨
                console.log('File:', file.name, 'webkitRelativePath:', file.webkitRelativePath);
                // ä»®ã®ãƒ‘ã‚¹ã¨ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä½¿ç”¨ï¼ˆå¾Œã§ä¿®æ­£ãŒå¿…è¦ï¼‰
                realFilePaths.push(file.name);
            }
            
            if (unityPackageFiles.length > 1) {
                // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯é¸æŠè‚¢ã‚’æä¾›
                showFolderOptionDialogForFiles(unityPackageFiles, folderName);
            } else {
                // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                processFilesAsSeparateProductsFromFiles(unityPackageFiles, folderName);
            }
        }

        // main processã§ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹
        async function processFolderDropWithMainProcess(folder) {
            console.log('ãƒ•ã‚©ãƒ«ãƒ€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ:', folder.path);
            
            try {
                // main processã®selectDirectoryã‚’ä½¿ã£ã¦ã€ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’å–å¾—
                // ãŸã ã—ã€å®Ÿéš›ã«ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚‹
                alert('ãƒ•ã‚©ãƒ«ãƒ€ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ­£ç¢ºãªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                selectDirectoryForDrop();
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚©ãƒ«ãƒ€ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        // WebKit Entry APIã‚’ä½¿ã£ãŸãƒ•ã‚©ãƒ«ãƒ€å‡¦ç†
        async function processFolderDropEntry(entry) {
            if (!entry.isDirectory) return;
            
            console.log('ãƒ•ã‚©ãƒ«ãƒ€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ (Entry API):', entry.name);
            
            try {
                const unityPackageFiles = [];
                
                // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«èª­ã¿å–ã‚Š
                const reader = entry.createReader();
                
                const readEntries = () => {
                    return new Promise((resolve, reject) => {
                        reader.readEntries((entries) => {
                            resolve(entries);
                        }, reject);
                    });
                };
                
                const entries = await readEntries();
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿéš›ã«èª­ã¿å–ã£ã¦ã€ãƒ‘ã‚¹ã‚’å–å¾—
                const filePromises = [];
                
                for (const fileEntry of entries) {
                    if (!fileEntry.isDirectory && fileEntry.name.toLowerCase().endsWith('.unitypackage')) {
                        filePromises.push(
                            new Promise((resolve) => {
                                fileEntry.file((file) => {
                                    // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ãƒ‘ã‚¹ã‚’å–å¾—
                                    resolve({
                                        name: file.name,
                                        path: file.path || file.webkitRelativePath || fileEntry.fullPath
                                    });
                                }, (error) => {
                                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:', error);
                                    resolve(null);
                                });
                            })
                        );
                    }
                }
                
                const fileResults = await Promise.all(filePromises);
                const validFiles = fileResults.filter(f => f !== null);
                
                for (const fileInfo of validFiles) {
                    unityPackageFiles.push(fileInfo);
                }
                
                if (unityPackageFiles.length > 0) {
                    console.log(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«${unityPackageFiles.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                    
                    // å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
                    openProductModal();
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«åã®é…åˆ—ã‚’ä½œæˆ
                    const fileNames = unityPackageFiles.map(f => f.name);
                    
                    // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿è¡¨ç¤ºï¼‰
                    displayMultipleFiles(fileNames);
                    
                    // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦è¨­å®šï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ï¼‰
                    document.getElementById('productFilePath').value = fileNames[0];
                    
                    // ãƒ•ã‚©ãƒ«ãƒ€åã‹ã‚‰å•†å“åã‚’æ¨æ¸¬
                    document.getElementById('productName').value = entry.name;
                    
                    alert(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«${unityPackageFiles.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å•†å“æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                } else {
                    alert('ãƒ•ã‚©ãƒ«ãƒ€å†…ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚©ãƒ«ãƒ€ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        // ãƒ•ã‚©ãƒ«ãƒ€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        async function processFolderDrop(folder) {
            try {
                // ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹ã‚’å–å¾—
                const folderPath = folder.path;
                console.log('ãƒ•ã‚©ãƒ«ãƒ€ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ:', folderPath);
                
                // Node.jsã®fsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
                if (window.electronAPI && window.electronAPI.shell) {
                    // Electronã®main processã«ãƒ•ã‚©ãƒ«ãƒ€ã‚¹ã‚­ãƒ£ãƒ³ã‚’ä¾é ¼
                    const fs = require('fs');
                    const path = require('path');
                    
                    if (fs && fs.readdirSync) {
                        try {
                            const files = fs.readdirSync(folderPath);
                            const unityPackageFiles = files
                                .filter(file => file.toLowerCase().endsWith('.unitypackage'))
                                .map(file => path.join(folderPath, file));
                            
                            if (unityPackageFiles.length > 0) {
                                console.log(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«${unityPackageFiles.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                                
                                // å•†å“è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
                                openProductModal();
                                
                                // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®è¡¨ç¤º
                                displayMultipleFiles(unityPackageFiles);
                                
                                // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦è¨­å®š
                                document.getElementById('productFilePath').value = unityPackageFiles[0];
                                
                                // ãƒ•ã‚©ãƒ«ãƒ€åã‹ã‚‰å•†å“åã‚’æ¨æ¸¬
                                const folderName = path.basename(folderPath);
                                document.getElementById('productName').value = folderName;
                                
                                alert(`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«${unityPackageFiles.length}å€‹ã®.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å•†å“æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                            } else {
                                alert('ãƒ•ã‚©ãƒ«ãƒ€å†…ã«.unitypackageãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                            }
                        } catch (error) {
                            console.error('ãƒ•ã‚©ãƒ«ãƒ€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                            alert('ãƒ•ã‚©ãƒ«ãƒ€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                        }
                    }
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ•ã‚©ãƒ«ãƒ€ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }
        
        function getFilteredProducts() {
            // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«åŸºã¥ã„ã¦å•†å“ã‚’å–å¾—
            let filtered = products.slice();
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
            const categoryCheckboxes = document.querySelectorAll('[id^="filter_"]:checked');
            const selectedCategories = Array.from(categoryCheckboxes).map(cb => cb.value);
            if (selectedCategories.length > 0) {
                filtered = filtered.filter(product => selectedCategories.includes(product.category));
            }
            
            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(product => 
                    product.name.toLowerCase().includes(query) ||
                    (product.description && product.description.toLowerCase().includes(query))
                );
            }
            
            return filtered;
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            initDragAndDrop();
            updateViewButtons();
            
            // ä¸¦ã³é †ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            const orderSelect = document.getElementById('orderSelect');
            if (orderSelect) {
                orderSelect.value = 'created_desc';
                currentSortOrder = 'created_desc';
            }
        });

        // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
        function showHelpModal() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
        async function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            
            // ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
            try {
                const settings = await window.electronAPI.settings.get();
                document.getElementById('autoArchiveCheckbox').checked = settings.autoArchive === true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡åŠ¹
            } catch (error) {
                console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                document.getElementById('autoArchiveCheckbox').checked = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            }
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // Boothè³¼å…¥å±¥æ­´ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        async function importPurchaseHistory() {
            try {
                const statusDiv = document.getElementById('importStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#60a5fa';
                statusDiv.textContent = 'HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„...';
                
                // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰
                const htmlFilePaths = await window.electronAPI.booth.selectPurchaseHistoryFiles();
                
                if (!htmlFilePaths || htmlFilePaths.length === 0) {
                    statusDiv.style.display = 'none';
                    return;
                }
                
                const fileCount = htmlFilePaths.length;
                statusDiv.textContent = `${fileCount}å€‹ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æä¸­...`;
                
                // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦å•†å“æƒ…å ±ã‚’æŠ½å‡º
                const result = await window.electronAPI.booth.parseMultiplePurchaseHistories(htmlFilePaths);
                
                if (result.success) {
                    statusDiv.style.color = '#10b981';
                    statusDiv.innerHTML = `
                        âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼<br>
                        â€¢ å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«: ${fileCount}å€‹<br>
                        â€¢ æŠ½å‡ºã—ãŸå•†å“: ${result.totalItems}ä»¶<br>
                        â€¢ æ–°è¦è¿½åŠ : ${result.addedItems}ä»¶<br>
                        â€¢ æ—¢å­˜ã‚¹ã‚­ãƒƒãƒ—: ${result.existingItems}ä»¶
                    `;
                    
                    // è©³ç´°ãƒ­ã‚°
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ:', result);
                    
                    // æˆåŠŸæ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚‚è¡¨ç¤º
                    setTimeout(() => {
                        alert(`è³¼å…¥å±¥æ­´ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\nå‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«: ${fileCount}å€‹\næŠ½å‡ºã—ãŸå•†å“: ${result.totalItems}ä»¶\næ–°è¦è¿½åŠ : ${result.addedItems}ä»¶\næ—¢å­˜ã‚¹ã‚­ãƒƒãƒ—: ${result.existingItems}ä»¶\n\nä»Šå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«åã«ä¸€è‡´ã™ã‚‹å•†å“ãŒã‚ã‚Œã°è‡ªå‹•ã§BoothURLãŒè¨­å®šã•ã‚Œã¾ã™ã€‚`);
                    }, 1000);
                    
                } else {
                    statusDiv.style.color = '#ef4444';
                    statusDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${result.error}`;
                    
                    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n${result.error}`);
                }
                
            } catch (error) {
                console.error('è³¼å…¥å±¥æ­´ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                
                const statusDiv = document.getElementById('importStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#ef4444';
                statusDiv.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                
                alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message}`);
            }
        }

        async function saveSettings() {
            try {
                const autoArchive = document.getElementById('autoArchiveCheckbox').checked;
                await window.electronAPI.settings.update({ autoArchive });
                console.log('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:', { autoArchive });
                closeSettingsModal();
            } catch (error) {
                console.error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', error);
                alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // Boothå€™è£œé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
        let boothSearchResults = [];
        let selectedBoothUrl = null;
        let currentBoothSearchCallback = null;

        // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®æ‰‹å‹•æ¤œç´¢ãƒ†ã‚¹ãƒˆ
        async function testBoothSearchManual(filename) {
            console.log('æ‰‹å‹•æ¤œç´¢ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ:', filename);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
            let name = filename.replace(/\.(unitypackage|zip|rar)$/i, '');
            name = name
                .replace(/_?v?\d+\.\d+.*$/i, '') // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·
                .replace(/_?\d{8}.*$/i, '') // æ—¥ä»˜
                .replace(/_?fix.*$/i, '') // fix
                .replace(/_?final.*$/i, '') // final
                .replace(/[\[\]()ï¼ˆï¼‰]/g, '') // æ‹¬å¼§
                .replace(/[_-]+/g, ' ') // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã¨ãƒã‚¤ãƒ•ãƒ³ã‚’ã‚¹ãƒšãƒ¼ã‚¹
                .trim();
            
            const keywords = name.split(/\s+/).filter(word => word.length > 1);
            console.log('æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', keywords);
            
            if (keywords.length === 0) {
                return {
                    success: false,
                    error: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºå¤±æ•—',
                    results: [],
                    keywords: []
                };
            }
            
            // ç°¡å˜ãªãƒ€ãƒŸãƒ¼æ¤œç´¢çµæœï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            const dummyResults = [
                {
                    url: 'https://booth.pm/items/123456',
                    title: `${keywords[0]} - ãƒ†ã‚¹ãƒˆå•†å“1`,
                    query: keywords[0]
                },
                {
                    url: 'https://booth.pm/items/789012',
                    title: `${keywords.join(' ')} - ãƒ†ã‚¹ãƒˆå•†å“2`,
                    query: keywords.join(' ')
                }
            ];
            
            console.log('ãƒ€ãƒŸãƒ¼æ¤œç´¢çµæœ:', dummyResults);
            
            return {
                success: true,
                results: dummyResults,
                keywords: keywords
            };
        }

        async function searchBoothByFilename(filename, callback) {
            console.log('searchBoothByFilenameé–‹å§‹:', filename);
            currentBoothSearchCallback = callback;
            
            try {
                document.getElementById('searchFilename').textContent = filename;
                document.getElementById('searchKeywords').textContent = 'æ¤œç´¢ä¸­...';
                document.getElementById('boothCandidatesList').innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">æ¤œç´¢ä¸­...</div>';
                document.getElementById('boothCandidatesModal').style.display = 'block';
                
                console.log('Boothæ¤œç´¢APIå‘¼ã³å‡ºã—ä¸­...', filename);
                
                console.log('ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹APIå‘¼ã³å‡ºã—é–‹å§‹');
                let result;
                try {
                    console.log('window.electronAPI.booth:', window.electronAPI.booth);
                    console.log('searchByFilenameé–¢æ•°:', window.electronAPI.booth.searchByFilename);
                    
                    result = await window.electronAPI.booth.searchByFilename(filename);
                    console.log('ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹APIæˆåŠŸ:', result);
                } catch (apiError) {
                    console.error('ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹APIå¤±æ•—:', apiError);
                    console.error('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', apiError.message, apiError.stack);
                    
                    // APIãŒå¤±æ•—ã—ãŸå ´åˆã®å‡¦ç†
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•æ¤œç´¢ãƒ†ã‚¹ãƒˆé–‹å§‹');
                    result = await testBoothSearchManual(filename);
                }
                
                console.log('æœ€çµ‚çš„ãªBoothæ¤œç´¢çµæœ:', result);
                console.log('æ¤œç´¢çµæœã®è©³ç´°:', result.results);
                if (result.results && result.results.length > 0) {
                    result.results.forEach((item, index) => {
                        console.log(`å€™è£œ${index + 1}:`, item.title, '->', item.url);
                    });
                }
                
                if (result.success && result.results.length > 0) {
                    boothSearchResults = result.results;
                    displayBoothCandidates(result.results, result.keywords);
                } else {
                    document.getElementById('boothCandidatesList').innerHTML = 
                        '<div style="text-align: center; padding: 20px; color: #f87171;">å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>';
                    document.getElementById('searchKeywords').textContent = result.keywords ? result.keywords.join(', ') : 'æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ';
                }
            } catch (error) {
                console.error('Boothæ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('boothCandidatesList').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #f87171;">æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>';
            }
        }

        function displayBoothCandidates(candidates, keywords) {
            document.getElementById('searchKeywords').textContent = keywords.join(', ');
            
            const candidatesList = document.getElementById('boothCandidatesList');
            candidatesList.innerHTML = '';
            
            candidates.forEach((candidate, index) => {
                const candidateDiv = document.createElement('div');
                candidateDiv.style.cssText = `
                    margin-bottom: 10px; 
                    padding: 12px; 
                    border: 2px solid #4b5563; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    transition: all 0.2s;
                    background-color: #1f2937;
                `;
                
                candidateDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="boothCandidate" value="${index}" id="candidate${index}" style="width: 16px; height: 16px;">
                        <label for="candidate${index}" style="flex: 1; cursor: pointer;">
                            <div style="font-weight: 600; color: #d1d5db; margin-bottom: 4px;">${candidate.title}</div>
                            <div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">${candidate.url}</div>
                            <div style="font-size: 11px; color: #6b7280;">æ¤œç´¢ã‚¯ã‚¨ãƒª: ${candidate.query}</div>
                        </label>
                    </div>
                `;
                
                candidateDiv.addEventListener('click', () => {
                    const radio = candidateDiv.querySelector('input[type="radio"]');
                    radio.checked = true;
                    selectCandidate(index);
                });
                
                candidateDiv.addEventListener('mouseenter', () => {
                    candidateDiv.style.borderColor = '#60a5fa';
                    candidateDiv.style.backgroundColor = '#2563eb20';
                });
                
                candidateDiv.addEventListener('mouseleave', () => {
                    if (!candidateDiv.querySelector('input[type="radio"]').checked) {
                        candidateDiv.style.borderColor = '#4b5563';
                        candidateDiv.style.backgroundColor = '#1f2937';
                    }
                });
                
                candidatesList.appendChild(candidateDiv);
            });
        }

        function selectCandidate(index) {
            selectedBoothUrl = boothSearchResults[index].url;
            document.getElementById('selectBoothCandidate').disabled = false;
            
            // ä»–ã®å€™è£œã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('#boothCandidatesList > div').forEach((div, i) => {
                if (i === index) {
                    div.style.borderColor = '#60a5fa';
                    div.style.backgroundColor = '#2563eb20';
                } else {
                    div.style.borderColor = '#4b5563';
                    div.style.backgroundColor = '#1f2937';
                }
            });
        }

        async function selectBoothCandidate() {
            if (selectedBoothUrl && currentBoothSearchCallback) {
                // å­¦ç¿’æ©Ÿèƒ½ï¼šé¸æŠã•ã‚ŒãŸURLã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’é–¢é€£ä»˜ã‘ã¦ä¿å­˜
                const filename = document.getElementById('searchFilename').textContent;
                console.log('å­¦ç¿’å‡¦ç†é–‹å§‹ - ãƒ•ã‚¡ã‚¤ãƒ«å:', filename, 'URL:', selectedBoothUrl);
                
                if (filename && selectedBoothUrl.includes('booth.pm') && selectedBoothUrl.includes('/items/')) {
                    try {
                        console.log('å­¦ç¿’APIå‘¼ã³å‡ºã—å‰');
                        const result = await window.electronAPI.booth.learnMapping(filename, selectedBoothUrl);
                        console.log('å­¦ç¿’APIçµæœ:', result);
                        console.log('Boothãƒãƒƒãƒ”ãƒ³ã‚°å­¦ç¿’å®Œäº†:', filename, '->', selectedBoothUrl);
                        alert(`å­¦ç¿’å®Œäº†ï¼\n${filename} â†’ ${selectedBoothUrl}`);
                    } catch (error) {
                        console.error('å­¦ç¿’ã‚¨ãƒ©ãƒ¼:', error);
                        alert('å­¦ç¿’ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    }
                } else {
                    console.log('å­¦ç¿’å¯¾è±¡å¤–:', 'filename=' + filename, 'URL=' + selectedBoothUrl);
                }
                
                currentBoothSearchCallback(selectedBoothUrl);
                closeBoothCandidatesModal();
            }
        }

        function selectManualEntry() {
            if (currentBoothSearchCallback) {
                currentBoothSearchCallback(null); // null = æ‰‹å‹•å…¥åŠ›
                closeBoothCandidatesModal();
            }
        }

        function closeBoothCandidatesModal() {
            document.getElementById('boothCandidatesModal').style.display = 'none';
            boothSearchResults = [];
            selectedBoothUrl = null;
            currentBoothSearchCallback = null;
        }

        // å•†å“ãƒ¢ãƒ¼ãƒ€ãƒ«ã§Boothæ¤œç´¢ã‚’å®Ÿè¡Œ
        function searchBoothForCurrentFile() {
            console.log('searchBoothForCurrentFileå‘¼ã³å‡ºã—');
            const filePath = document.getElementById('productFilePath').value;
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹:', filePath);
            
            if (!filePath) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‹ã‚‰Boothæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }
            
            const filename = filePath.split(/[/\\]/).pop(); // ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿æŠ½å‡º
            console.log('æŠ½å‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å:', filename);
            
            searchBoothByFilename(filename, (selectedUrl) => {
                console.log('ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‘¼ã³å‡ºã—, selectedUrl:', selectedUrl);
                if (selectedUrl) {
                    document.getElementById('productBoothUrl').value = selectedUrl;
                    // ã‚µãƒ ãƒã‚¤ãƒ«ã‚‚è‡ªå‹•å–å¾—
                    fetchThumbnail();
                }
                // selectedUrl ãŒ null ã®å ´åˆã¯æ‰‹å‹•å…¥åŠ›ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const helpModal = document.getElementById('helpModal');
            const settingsModal = document.getElementById('settingsModal');
            const boothCandidatesModal = document.getElementById('boothCandidatesModal');
            
            if (event.target === helpModal) {
                closeHelpModal();
            } else if (event.target === settingsModal) {
                closeSettingsModal();
            } else if (event.target === boothCandidatesModal) {
                closeBoothCandidatesModal();
            }
        }
    </script>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="helpModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #374151; margin: 5% auto; padding: 30px; border-radius: 6px; width: 90%; max-width: 800px; color: white; position: relative; max-height: 80vh; overflow-y: auto;">
            <button onclick="closeHelpModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 24px; font-weight: bold;">&times;</button>
            
            <h2 style="margin-top: 0; color: #60a5fa; font-size: 20px;">ğŸ“˜ VRChat Boothå•†å“ç®¡ç† - ä½¿ã„æ–¹</h2>
            
            <div style="line-height: 1.6; font-size: 14px;">
                <h3 style="color: #34d399; font-size: 16px; margin-top: 25px; margin-bottom: 10px;">ğŸ¯ åŸºæœ¬æ“ä½œ</h3>
                <ul style="margin-left: 20px;">
                    <li><strong>å•†å“è¿½åŠ :</strong> ã€Œå•†å“ã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ–°ã—ã„å•†å“ã‚’ç™»éŒ²</li>
                    <li><strong>ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—:</strong> .unitypackageãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›´æ¥ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸€æ‹¬è¿½åŠ </li>
                    <li><strong>ç·¨é›†:</strong> å„å•†å“ã®ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã‹ã‚‰æƒ…å ±ã‚’ä¿®æ­£</li>
                    <li><strong>å‰Šé™¤:</strong> å•†å“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€Œé¸æŠã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ã€ã§ä¸€æ‹¬å‰Šé™¤</li>
                </ul>

                <h3 style="color: #34d399; font-size: 16px; margin-top: 25px; margin-bottom: 10px;">ğŸ“ è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h3>
                <ul style="margin-left: 20px;">
                    <li><strong>è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²:</strong> ä¸€ã¤ã®å•†å“ã«è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–¢é€£ä»˜ã‘</li>
                    <li><strong>è¡¨ç¤ºåè¨­å®š:</strong> å„ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†ã‹ã‚Šã‚„ã™ã„åå‰ã‚’è¨­å®š</li>
                    <li><strong>å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:</strong> Unityãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</li>
                </ul>

                <h3 style="color: #34d399; font-size: 16px; margin-top: 25px; margin-bottom: 10px;">ğŸ·ï¸ ã‚¿ã‚°æ©Ÿèƒ½</h3>
                <ul style="margin-left: 20px;">
                    <li><strong>ã‚¿ã‚°ä½œæˆ:</strong> ã€Œã‚¿ã‚°ã‚’è¿½åŠ ã€ã§æ–°ã—ã„ã‚¿ã‚°ã‚’ä½œæˆ</li>
                    <li><strong>ä¸€æ‹¬ã‚¿ã‚°ä»˜ã‘:</strong> è¤‡æ•°ã®å•†å“ã‚’é¸æŠã—ã¦ä¸€æ‹¬ã§ã‚¿ã‚°ã‚’é©ç”¨</li>
                    <li><strong>ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</strong> ã‚¿ã‚°ã§å•†å“ã‚’çµã‚Šè¾¼ã¿è¡¨ç¤º</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settingsModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #374151; margin: 10% auto; padding: 30px; border-radius: 6px; width: 90%; max-width: 500px; color: white; position: relative;">
            <button onclick="closeSettingsModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 24px; font-weight: bold;">&times;</button>
            
            <h2 style="margin-top: 0; color: #60a5fa; font-size: 20px;">âš™ï¸ è¨­å®š</h2>
            
            <div style="line-height: 1.6; font-size: 14px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoArchiveCheckbox" style="width: 16px; height: 16px;">
                        <div>
                            <div style="font-weight: 600; color: #d1d5db;">è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½</div>
                            <div style="font-size: 12px; color: #9ca3af; margin-top: 2px;">
                                å•†å“ç™»éŒ²æ™‚ã«UnityPackageãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã€<br>
                                ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ãªã©ã‹ã‚‰å‰Šé™¤ã—ã¾ã™
                            </div>
                        </div>
                    </label>
                </div>
                
                <div style="margin-bottom: 20px; border-top: 1px solid #4b5563; padding-top: 20px;">
                    <div style="font-weight: 600; color: #d1d5db; margin-bottom: 10px;">ğŸ“‹ Boothè³¼å…¥å±¥æ­´ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                    <div style="font-size: 12px; color: #9ca3af; margin-bottom: 15px; line-height: 1.4;">
                        Boothã®è³¼å…¥å±¥æ­´ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜ã—ãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å•†å“æƒ…å ±ã‚’è‡ªå‹•å–å¾—ã—ã€<br>
                        ãƒ•ã‚¡ã‚¤ãƒ«åã¨å•†å“URLã‚’è‡ªå‹•ã§ãƒãƒƒãƒãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                    </div>
                    <button onclick="importPurchaseHistory()" style="padding: 8px 16px; background-color: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                        ğŸ“ è³¼å…¥å±¥æ­´HTMLã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <div id="importStatus" style="margin-top: 10px; font-size: 12px; color: #9ca3af; display: none;"></div>
                </div>
                
                <div style="border-top: 1px solid #4b5563; padding-top: 15px; margin-top: 20px;">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeSettingsModal()" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button onclick="saveSettings()" style="padding: 8px 16px; background-color: #059669; color: white; border: none; border-radius: 4px; cursor: pointer;">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Boothå€™è£œé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="boothCandidatesModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: #374151; margin: 5% auto; padding: 30px; border-radius: 6px; width: 90%; max-width: 700px; color: white; position: relative; max-height: 80vh; overflow-y: auto;">
            <button onclick="closeBoothCandidatesModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 24px; font-weight: bold;">&times;</button>
            
            <h2 style="margin-top: 0; color: #60a5fa; font-size: 20px;">ğŸ” Boothå•†å“ã®å€™è£œé¸æŠ</h2>
            
            <div id="boothSearchInfo" style="margin-bottom: 20px; padding: 10px; background-color: #4b5563; border-radius: 4px; font-size: 14px;">
                <div><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> <span id="searchFilename"></span></div>
                <div><strong>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> <span id="searchKeywords"></span></div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; color: #d1d5db; margin-bottom: 10px;">è©²å½“ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆé¸æŠã—ãªã„å ´åˆã¯æ‰‹å‹•å…¥åŠ›ï¼‰ï¼š</div>
                <div id="boothCandidatesList" style="max-height: 400px; overflow-y: auto;">
                    <!-- å€™è£œãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
            </div>
            
            <div style="border-top: 1px solid #4b5563; padding-top: 15px; margin-top: 20px;">
                <div style="display: flex; gap: 10px; justify-content: space-between;">
                    <button onclick="selectManualEntry()" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">æ‰‹å‹•å…¥åŠ›</button>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="closeBoothCandidatesModal()" style="padding: 8px 16px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button id="selectBoothCandidate" onclick="selectBoothCandidate()" style="padding: 8px 16px; background-color: #059669; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>é¸æŠ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>